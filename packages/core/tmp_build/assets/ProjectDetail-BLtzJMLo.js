import{r as g,t as b,i as P,j as e,L as d,I as oe,E as y,G as w,H as k,J as R,K as c,l as me,k as V,c as f,x as xe,S as Ne,ac as ke,ab as Re,b as Ce,F as Ae,C as m,d as x,e as h,m as u,T as Se,f as B,aa as te}from"./index-DOc7Nwb7.js";import{D as he}from"./DashboardLayout-aHnUqq57.js";import{B as Ie}from"./Breadcrumb-CRi3LAxS.js";import{P as Te}from"./PageGuide-CPKKXXS6.js";import{T as ye,a as we,b as $,c as F}from"./tabs-CBDTXbEn.js";import{P as ae}from"./progress-B-1k4ZZX.js";import{E as Pe}from"./enhanced-dialog-CeRPsI16.js";import{T as re}from"./textarea-BtxBxzdY.js";import{c as ue}from"./riskCalculations-D9ghekGI.js";import{C as Le,R as Me,a as Ee}from"./RiskTreatmentCard-70xqcJLZ.js";import{W as De}from"./wand-sparkles-BtekNLFr.js";import{P as ie}from"./plus-BaQ35Jcx.js";import{S as Oe}from"./save-CvVmWchr.js";import{C as He}from"./chevron-left-DZH-lUm7.js";import{C as Ve}from"./circle-check-C5kiwRoG.js";import{T as $e}from"./target-cfAj3L6j.js";import{B as Fe}from"./bar-chart-3-BCngNY6H.js";import{R as je,T as pe}from"./generateCategoricalChart-KNLgM3hn.js";import{R as fe,P as ve,a as ge}from"./RadarChart-Jh4tpWfl.js";import{P as be,a as Ue}from"./PolarAngleAxis-BO8F-h7c.js";import{L as le}from"./lock-czWF3qbC.js";import{B as Qe}from"./brain-C-Zi22rJ.js";import{A as ze}from"./arrow-up-right-BLuFLpps.js";import{C as Be}from"./clock-osbacZli.js";import"./index--2vFva6Y.js";import"./search-CwuIBBPE.js";import"./filter-Ceo--4mb.js";import"./clipboard-check-CQkJX5J0.js";import"./sparkles-CoQ80pK2.js";import"./send-FW7-3cjH.js";import"./scroll-area-DPaNxEJD.js";import"./settings-CIu9FFiX.js";import"./en-US-Bfz1jvxT.js";import"./getTimezoneOffsetInMilliseconds-em2BGgN1.js";import"./rocket-C2MuHhsn.js";import"./scale-BCebIfgE.js";import"./layout-grid-CGqkIAJU.js";import"./book-open-BffBrdze.js";import"./zap-B01fFOkT.js";import"./star-BTvaCCU4.js";import"./briefcase-BxorFA78.js";import"./database-Bjtecw5f.js";import"./activity-B1F2IRm3.js";import"./shield-check-ETs8j4-d.js";import"./shield-alert-iAruRy4W.js";import"./link-FmUqdGRG.js";import"./globe-BMGZmoaJ.js";import"./calendar-BlLJlGbj.js";import"./message-square-5hBo7zY3.js";import"./upload-BBmUECj8.js";import"./user-CqRnJLgW.js";import"./separator-BWuYil37.js";import"./info-By5wLOUH.js";import"./circle-check-big-BSqJVrgh.js";import"./ban-TJUJ_p7U.js";import"./dollar-sign-M9UCfTjq.js";import"./square-pen-ClRv15cM.js";import"./trash-2-CFEfisbM.js";import"./isEqual-D_xcZLCn.js";const _e={Rare:1,Unlikely:2,Possible:3,Likely:4,"Almost Certain":5},Ke={Low:1,Medium:2,High:3,"Very High":4,Critical:5},We={1:"Rare",1:"Rare",2:"Unlikely",2:"Unlikely",3:"Possible",3:"Possible",4:"Likely",4:"Likely",5:"Almost Certain",5:"Almost Certain"},Ge={1:"Low",1:"Low",2:"Medium",2:"Medium",3:"High",3:"High",4:"Very High",4:"Very High",5:"Critical",5:"Critical"};function Ye({open:H,onOpenChange:L,clientId:C,onSuccess:v,initialData:t}){const[_,S]=g.useState(!1),[M,N]=g.useState(!1),[se,U]=g.useState("assessment"),[I,E]=g.useState(!1),[r,D]=g.useState(null),[a,l]=g.useState({assessmentId:`RA-${new Date().getFullYear()}-${Math.floor(Math.random()*1e3)}`,assessmentDate:new Date().toISOString().split("T")[0],assessor:"",method:"Qualitative",threatDescription:"",vulnerabilityDescription:"",affectedAssets:[],likelihood:"Possible",impact:"High",inherentRisk:"Medium",controlEffectiveness:"Effective",residualRisk:"Low",riskOwner:"",treatmentOption:"None",recommendedActions:"",priority:"Medium",targetResidualRisk:"Low",reviewDueDate:"",status:"draft",notes:"",nextReviewDate:"",controlIds:[]}),{data:O}=b.clientControls.list.useQuery({clientId:C}),{data:p}=b.risks.getAssets.useQuery({clientId:C}),{data:j}=b.clients.getUsers.useQuery({clientId:C});g.useEffect(()=>{if(t&&H){const s=ue(t.inherentRisk,t.controlEffectiveness),n=t.residualRisk!==s;N(n),l({assessmentId:t.assessmentId,assessmentDate:t.assessmentDate?new Date(t.assessmentDate).toISOString().split("T")[0]:"",assessor:t.assessor||"",method:t.method||"Qualitative",threatDescription:t.threatDescription||"",vulnerabilityDescription:t.vulnerabilityDescription||"",affectedAssets:Array.isArray(t.affectedAssets)?t.affectedAssets:[],likelihood:We[t.likelihood]||t.likelihood||"Possible",impact:Ge[t.impact]||t.impact||"High",inherentRisk:t.inherentRisk||"Medium",controlEffectiveness:t.controlEffectiveness||"Effective",residualRisk:t.residualRisk||"Low",riskOwner:t.riskOwner||"",treatmentOption:t.treatmentOption||"Mitigate",recommendedActions:t.recommendedActions||"",priority:t.priority||"Medium",targetResidualRisk:t.targetResidualRisk||"Low",reviewDueDate:t.reviewDueDate?new Date(t.reviewDueDate).toISOString().split("T")[0]:"",status:t.status||"draft",notes:t.notes||"",nextReviewDate:t.nextReviewDate?new Date(t.nextReviewDate).toISOString().split("T")[0]:"",controlIds:Array.isArray(t.controlIds)?t.controlIds.filter(o=>typeof o=="number"):[]})}else H&&!t&&(N(!1),l({assessmentId:`RA-${new Date().getFullYear()}-${Math.floor(Math.random()*1e3)}`,assessmentDate:new Date().toISOString().split("T")[0],assessor:"",method:"Qualitative",threatDescription:"",vulnerabilityDescription:"",affectedAssets:[],likelihood:"Possible",impact:"High",inherentRisk:"Medium",controlEffectiveness:"Effective",residualRisk:"Low",riskOwner:"",treatmentOption:"None",recommendedActions:"",priority:"Medium",targetResidualRisk:"Low",reviewDueDate:"",status:"draft",notes:"",nextReviewDate:"",controlIds:[]}))},[t,H]),g.useEffect(()=>{if(!M&&a.inherentRisk){const s=ue(a.inherentRisk,a.controlEffectiveness);s&&s!==a.residualRisk&&l(n=>({...n,residualRisk:s}))}},[a.inherentRisk,a.controlEffectiveness,M,a.residualRisk]);const K=b.risks.upsert.useMutation({onSuccess:()=>{P.success(t?"Risk Assessment updated successfully":"Risk Assessment created successfully"),v(),L(!1),S(!1)},onError:s=>{P.error(`Failed to save assessment: ${s.message}`),S(!1)}}),Q=b.advisor.analyzeRisk.useMutation({onSuccess:s=>{l(n=>({...n,likelihood:s.likelihood,impact:s.impact,inherentRisk:s.inherentRisk})),P.success("Risk scored by AI",{description:s.reasoning,duration:5e3})},onError:s=>{P.error(`Auto-triage failed: ${s.message}`)}}),W=async()=>{if(!a.threatDescription||!a.vulnerabilityDescription){P.error("Please enter threat and vulnerability descriptions first");return}P.info("Analyzing risk scenario..."),await Q.mutateAsync({clientId:C,threat:a.threatDescription,vulnerability:a.vulnerabilityDescription,assets:a.affectedAssets})},G=async()=>{S(!0);const s=_e[a.likelihood]||3,n=Ke[a.impact]||3,o={...a,clientId:C,id:t==null?void 0:t.id,likelihood:s,impact:n,controlIds:(a.controlIds||[]).filter(T=>typeof T=="number"),assessmentDate:a.assessmentDate||void 0,reviewDueDate:a.reviewDueDate||void 0,nextReviewDate:a.nextReviewDate||void 0};K.mutate(o)},Y=s=>{l(n=>n.controlIds.includes(s)?{...n,controlIds:n.controlIds.filter(T=>T!==s)}:{...n,controlIds:[...n.controlIds,s]})},J=s=>{l(n=>n.affectedAssets.includes(s)?{...n,affectedAssets:n.affectedAssets.filter(T=>T!==s)}:{...n,affectedAssets:[...n.affectedAssets,s]})},{data:A,refetch:z}=b.risks.getRiskTreatments.useQuery({riskAssessmentId:(t==null?void 0:t.id)||0},{enabled:!!(t!=null&&t.id)}),q=b.risks.deleteRiskTreatment.useMutation({onSuccess:()=>{P.success("Treatment deleted successfully"),z()},onError:s=>{P.error(`Failed to delete treatment: ${s.message}`)}}),X=s=>{D(s),E(!0)},Z=async s=>{confirm("Are you sure you want to delete this treatment plan?")&&await q.mutateAsync({id:s})},ee=()=>{z(),E(!1),D(null)};return e.jsx(Pe,{open:H,onOpenChange:L,title:t?"Edit Risk Assessment":"New Risk Assessment",description:t?"Update the details of this risk assessment.":"Complete the form below to create a comprehensive risk assessment.",size:"xl",className:"max-h-[90vh]",footer:e.jsxs("div",{className:"flex w-full justify-between",children:[e.jsx(f,{variant:"outline",onClick:()=>L(!1),children:"Close Dialog"}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(f,{onClick:G,disabled:_,className:"gap-2",children:[_?e.jsx(xe,{className:"w-4 h-4 animate-spin"}):e.jsx(Oe,{className:"w-4 h-4"}),t?"Save Assessment Details":"Create Assessment"]})})]}),children:e.jsxs(ye,{value:se,onValueChange:U,className:"w-full",children:[e.jsxs(we,{className:"grid w-full grid-cols-2",children:[e.jsx($,{value:"assessment",children:"Assessment Details"}),e.jsxs($,{value:"treatments",disabled:!t,children:["Treatments ",A&&A.length>0&&`(${A.length})`]})]}),e.jsx(F,{value:"assessment",className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-6 py-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900 border-b pb-2",children:"Identification"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Assessment ID"}),e.jsx(oe,{value:a.assessmentId,disabled:!0,onChange:()=>{},className:"border-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Date"}),e.jsx(oe,{type:"date",value:a.assessmentDate,onChange:s=>l({...a,assessmentDate:s.target.value}),className:"border-2"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Assessor"}),e.jsxs(y,{onValueChange:s=>l({...a,assessor:s}),value:a.assessor,children:[e.jsx(w,{className:"border-2",children:e.jsx(k,{placeholder:"Select Assessor"})}),e.jsx(R,{children:j==null?void 0:j.map(s=>e.jsxs(c,{value:s.name||s.email,children:[s.name," (",s.email,")"]},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Affected Assets"}),e.jsxs("div",{className:"border-2 rounded-md p-2 h-32 overflow-y-auto space-y-1 bg-background",children:[p==null?void 0:p.map(s=>e.jsxs("div",{className:`flex items-center gap-2 p-1.5 rounded text-sm cursor-pointer hover:bg-gray-50 ${a.affectedAssets.includes(s.name)?"bg-blue-50 text-blue-700":""}`,onClick:()=>J(s.name),children:[e.jsx("div",{className:`w-4 h-4 border rounded flex items-center justify-center ${a.affectedAssets.includes(s.name)?"bg-blue-600 border-blue-600":"border-gray-300"}`,children:a.affectedAssets.includes(s.name)&&e.jsx(me,{className:"w-3 h-3 text-white"})}),e.jsx("span",{children:s.name})]},s.id)),(!p||p.length===0)&&e.jsx("p",{className:"text-gray-400 text-sm p-1",children:"No assets found"})]}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:a.affectedAssets.map(s=>e.jsx(V,{variant:"secondary",className:"text-xs",children:s},s))})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900 border-b pb-2",children:"Analysis"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Threat Description"}),e.jsx(re,{placeholder:"What is the thread?",value:a.threatDescription,onChange:s=>l({...a,threatDescription:s.target.value}),className:"border-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Vulnerability Description"}),e.jsx(re,{placeholder:"What is the weakness?",value:a.vulnerabilityDescription,onChange:s=>l({...a,vulnerabilityDescription:s.target.value}),className:"border-2"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(f,{type:"button",variant:"outline",size:"sm",onClick:W,disabled:Q.isLoading,className:"gap-2 text-violet-600 border-violet-200 hover:bg-violet-50",children:[Q.isLoading?e.jsx(xe,{className:"w-3 h-3 animate-spin"}):e.jsx(De,{className:"w-3 h-3"}),"Auto-Triage with AI"]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Likelihood"}),e.jsxs(y,{onValueChange:s=>l({...a,likelihood:s}),value:a.likelihood,children:[e.jsx(w,{className:"border-2",children:e.jsx(k,{placeholder:"Likelihood"})}),e.jsxs(R,{children:[e.jsx(c,{value:"Rare",children:"Rare"}),e.jsx(c,{value:"Unlikely",children:"Unlikely"}),e.jsx(c,{value:"Possible",children:"Possible"}),e.jsx(c,{value:"Likely",children:"Likely"}),e.jsx(c,{value:"Almost Certain",children:"Almost Certain"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Impact"}),e.jsxs(y,{onValueChange:s=>l({...a,impact:s}),value:a.impact,children:[e.jsx(w,{className:"border-2",children:e.jsx(k,{placeholder:"Impact"})}),e.jsxs(R,{children:[e.jsx(c,{value:"Low",children:"Low"}),e.jsx(c,{value:"Medium",children:"Medium"}),e.jsx(c,{value:"High",children:"High"}),e.jsx(c,{value:"Very High",children:"Very High"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Inherent Risk"}),e.jsxs(y,{onValueChange:s=>l({...a,inherentRisk:s}),value:a.inherentRisk,children:[e.jsx(w,{className:"border-2",children:e.jsx(k,{placeholder:"Level"})}),e.jsxs(R,{children:[e.jsx(c,{value:"Low",children:"Low"}),e.jsx(c,{value:"Medium",children:"Medium"}),e.jsx(c,{value:"High",children:"High"}),e.jsx(c,{value:"Very High",children:"Very High"})]})]})]})]}),e.jsxs("div",{className:"space-y-4 col-span-2",children:[e.jsx("h3",{className:"font-semibold text-gray-900 border-b pb-2",children:"Existing Controls"}),e.jsxs("div",{className:"border rounded-md p-4 max-h-48 overflow-y-auto grid grid-cols-2 gap-2",children:[O==null?void 0:O.map(s=>{const{clientControl:n,control:o}=s;return e.jsxs("div",{className:`flex items-start gap-2 p-2 rounded text-sm cursor-pointer hover:bg-gray-50 border ${a.controlIds.includes(n.id)?"bg-blue-50 border-blue-200":"border-transparent"}`,onClick:()=>Y(n.id),children:[e.jsx("div",{className:`mt-0.5 w-4 h-4 border rounded flex items-center justify-center shrink-0 ${a.controlIds.includes(n.id)?"bg-blue-600 border-blue-600":"border-gray-300"}`,children:a.controlIds.includes(n.id)&&e.jsx(me,{className:"w-3 h-3 text-white"})}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium block",children:(o==null?void 0:o.controlId)||n.controlId}),e.jsx("span",{className:"text-gray-500 text-xs",children:(o==null?void 0:o.name)||n.customDescription})]})]},n.id)}),(!O||O.length===0)&&e.jsx("p",{className:"text-gray-400 text-sm",children:"No controls available in library."})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mt-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Control Effectiveness"}),e.jsxs(y,{onValueChange:s=>l({...a,controlEffectiveness:s}),value:a.controlEffectiveness,children:[e.jsx(w,{className:"border-2",children:e.jsx(k,{})}),e.jsxs(R,{children:[e.jsx(c,{value:"Effective",children:"Effective"}),e.jsx(c,{value:"Partially Effective",children:"Partially Effective"}),e.jsx(c,{value:"Ineffective",children:"Ineffective"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{children:"Residual Risk"}),!M&&e.jsxs("span",{className:"text-xs text-blue-600 dark:text-blue-400 flex items-center gap-1",children:[e.jsx(Le,{className:"w-3 h-3"}),"Auto-calculated"]})]}),e.jsxs(y,{onValueChange:s=>{l({...a,residualRisk:s}),N(!0)},value:a.residualRisk,children:[e.jsx(w,{className:M?"":"border-blue-300 dark:border-blue-700",children:e.jsx(k,{})}),e.jsxs(R,{children:[e.jsx(c,{value:"Low",children:"Low"}),e.jsx(c,{value:"Medium",children:"Medium"}),e.jsx(c,{value:"High",children:"High"}),e.jsx(c,{value:"Very High",children:"Very High"})]})]}),M&&e.jsx("button",{type:"button",onClick:()=>N(!1),className:"text-xs text-blue-600 dark:text-blue-400 hover:underline",children:"Reset to auto-calculate"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Target Risk"}),e.jsxs(y,{onValueChange:s=>l({...a,targetResidualRisk:s}),value:a.targetResidualRisk,children:[e.jsx(w,{className:"border-2",children:e.jsx(k,{})}),e.jsxs(R,{children:[e.jsx(c,{value:"Low",children:"Low"}),e.jsx(c,{value:"Medium",children:"Medium"})]})]})]})]})]}),e.jsxs("div",{className:"space-y-4 col-span-2",children:[e.jsx("h3",{className:"font-semibold text-gray-900 border-b pb-2",children:"Treatment Plan"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Treatment Option"}),e.jsxs(y,{onValueChange:s=>l({...a,treatmentOption:s}),value:a.treatmentOption,children:[e.jsx(w,{className:"border-2",children:e.jsx(k,{})}),e.jsxs(R,{children:[e.jsx(c,{value:"None",children:"None (Not Decided)"}),e.jsx(c,{value:"Mitigate",children:"Mitigate"}),e.jsx(c,{value:"Accept",children:"Accept"}),e.jsx(c,{value:"Transfer",children:"Transfer"}),e.jsx(c,{value:"Avoid",children:"Avoid"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Risk Owner"}),e.jsxs(y,{onValueChange:s=>l({...a,riskOwner:s}),value:a.riskOwner,children:[e.jsx(w,{className:"border-2",children:e.jsx(k,{placeholder:"Select Owner"})}),e.jsx(R,{children:j==null?void 0:j.map(s=>e.jsxs(c,{value:s.name||s.email,children:[s.name," (",s.email,")"]},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Priority"}),e.jsxs(y,{onValueChange:s=>l({...a,priority:s}),value:a.priority,children:[e.jsx(w,{className:"border-2",children:e.jsx(k,{})}),e.jsxs(R,{children:[e.jsx(c,{value:"Low",children:"Low"}),e.jsx(c,{value:"Medium",children:"Medium"}),e.jsx(c,{value:"High",children:"High"}),e.jsx(c,{value:"Critical",children:"Critical"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Recommended Actions"}),e.jsx(re,{value:a.recommendedActions,onChange:s=>l({...a,recommendedActions:s.target.value}),placeholder:"Actions to take..."})]})]})]})}),e.jsx(F,{value:"treatments",className:"space-y-4 mt-4",children:e.jsx("div",{className:"space-y-4",children:I?e.jsxs("div",{className:"border rounded-lg p-4 bg-gray-50",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-primary",children:r?"Edit Treatment Analysis":"New Treatment Analysis"}),e.jsx(Me,{clientId:C,riskAssessmentId:(t==null?void 0:t.id)||0,onSuccess:ee,onCancel:()=>{E(!1),D(null)},initialData:r,riskContext:{threat:a.threatDescription||"",vulnerability:a.vulnerabilityDescription||"",riskDetails:`Impact: ${a.impact}, Likelihood: ${a.likelihood}, Risk: ${a.inherentRisk}`}})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Treatment Plans"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Manage risk mitigation strategies for this assessment"})]}),e.jsxs(f,{type:"button",onClick:()=>{D(null),E(!0)},className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"Add Treatment"]})]}),A&&A.length>0?e.jsx("div",{className:"space-y-3",children:A.map(s=>e.jsx(Ee,{treatment:s,onEdit:X,onDelete:Z},s.id))}):e.jsxs("div",{className:"border-2 border-dashed rounded-lg p-12 text-center",children:[e.jsx(Ne,{className:"w-12 h-12 mx-auto text-muted-foreground mb-3"}),e.jsx("h4",{className:"font-medium mb-1",children:"No Treatment Plans Yet"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Create treatment plans to document how this risk will be managed"}),e.jsxs(f,{type:"button",variant:"outline",onClick:()=>{D(null),E(!0)},children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"Create First Treatment"]})]})]})})})]})})}const st=()=>{var G,Y,J,A,z,q,X,Z,ee,s,n,o,T,ce,ne,de;const{selectedClientId:H}=ke(),L=Re(),[,C]=Ce(),v=parseInt(L.projectId),t=L.clientId?parseInt(L.clientId):H,[_,S]=g.useState(null),[M,N]=g.useState(!1),[se,U]=g.useState("overview"),{data:I,isLoading:E}=b.projects.get.useQuery({id:v,clientId:t},{enabled:!!v&&!!t}),{data:r,isLoading:D,refetch:a}=b.projects.getProjectSecurityPosture.useQuery({projectId:v,clientId:t},{enabled:!!v&&!!t}),{data:l,refetch:O}=b.risks.list.useQuery({clientId:t,projectId:v,limit:100},{enabled:!!v&&!!t}),{data:p}=b.threatModels.list.useQuery({clientId:t,projectId:v,relaxedProjectSearch:!0},{enabled:!!v&&!!t}),j=p==null?void 0:p.find(i=>i.methodology==="LINDDUN");if(E||D)return e.jsx(he,{children:e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})});if(!I)return e.jsx("div",{children:"Project not found"});const K=(r==null?void 0:r.csfStats)||[],Q=(r==null?void 0:r.owaspStats)||[];r!=null&&r.aiRmfStats;const W=(r==null?void 0:r.overallPosture)||0;return e.jsx(he,{children:e.jsxs("div",{className:"space-y-6 page-transition",children:[e.jsx(Ie,{items:[{label:"Dashboard",href:"/dashboard"},{label:"Projects",href:`/clients/${t}/projects`},{label:I.name}]}),e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(f,{variant:"ghost",size:"icon",onClick:()=>C(`/clients/${t}/projects`),className:"bg-white border rounded-xl",children:e.jsx(He,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("h1",{className:"text-3xl font-extrabold text-slate-900",children:I.name}),e.jsx(V,{variant:"outline",className:"capitalize",children:I.projectType})]}),e.jsx("p",{className:"text-slate-500 mt-1",children:I.description})]})]}),e.jsxs("div",{className:"flex space-x-3 items-center",children:[e.jsx(Te,{title:"IT Project Overview",description:"Security posture and risk analysis for infrastructure projects.",rationale:"Provides visibility into the security health of IT initiatives.",howToUse:[{step:"Security Analysis",description:"View NIST CSF maturity scores."},{step:"Privacy & Data",description:"Track LINDDUN privacy threats."},{step:"Risk Register",description:"Manage project-specific risks."}]}),e.jsxs(f,{variant:"outline",className:"rounded-xl",children:[e.jsx(Ae,{className:"mr-2 h-4 w-4"})," Export Report"]}),e.jsx(f,{className:"rounded-xl shadow-lg shadow-blue-100 bg-blue-600 hover:bg-blue-700",children:"Perform Assessment"})]})]}),e.jsxs(ye,{value:se,onValueChange:U,className:"space-y-6",children:[e.jsxs(we,{className:"bg-slate-100/50 p-1 rounded-xl glass-effect border border-slate-200",children:[e.jsx($,{value:"overview",className:"rounded-lg px-6",children:"Overview"}),e.jsx($,{value:"security",className:"rounded-lg px-6",children:"Security Analysis"}),e.jsx($,{value:"privacy",className:"rounded-lg px-6",children:"Privacy & Data"}),e.jsx($,{value:"risks",className:"rounded-lg px-6",children:"Risk Register"})]}),e.jsxs(F,{value:"overview",className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs(m,{className:"border-none shadow-sm bg-gradient-to-br from-red-50 to-white overflow-hidden",children:[e.jsx(x,{className:"pb-1 p-4",children:e.jsx(h,{className:"text-xs font-bold text-red-600 uppercase tracking-wider",children:"Critical Risks"})}),e.jsx(u,{className:"p-4 pt-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-3xl font-black text-red-700",children:(r==null?void 0:r.riskStats.high)||0}),e.jsx(Se,{className:"h-8 w-8 text-red-200"})]})})]}),e.jsxs(m,{className:"border-none shadow-sm bg-gradient-to-br from-emerald-50 to-white overflow-hidden",children:[e.jsx(x,{className:"pb-1 p-4",children:e.jsx(h,{className:"text-xs font-bold text-emerald-600 uppercase tracking-wider",children:"Controls"})}),e.jsxs(u,{className:"p-4 pt-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-3xl font-black text-emerald-700",children:(((G=r==null?void 0:r.complianceStats)==null?void 0:G.total)||0)+(((Y=r==null?void 0:r.treatmentStats)==null?void 0:Y.total)||0)}),e.jsx(Ve,{className:"h-8 w-8 text-emerald-200"})]}),e.jsxs("div",{className:"text-[10px] text-emerald-600 font-medium mt-1",children:[(r==null?void 0:r.complianceStats.implemented)+(r==null?void 0:r.treatmentStats.implemented)," Implemented"]})]})]}),e.jsxs(m,{className:"border-none shadow-sm bg-gradient-to-br from-indigo-50 to-white overflow-hidden",children:[e.jsx(x,{className:"pb-1 p-4",children:e.jsx(h,{className:"text-xs font-bold text-indigo-600 uppercase tracking-wider",children:"Mitigation"})}),e.jsxs(u,{className:"p-4 pt-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-3xl font-black text-indigo-700",children:((J=r==null?void 0:r.treatmentStats)==null?void 0:J.averageCompletion)===0&&((A=r==null?void 0:r.treatmentStats)==null?void 0:A.total)>0?r.treatmentStats.total:`${((z=r==null?void 0:r.treatmentStats)==null?void 0:z.averageCompletion)||0}%`}),e.jsx($e,{className:"h-8 w-8 text-indigo-200"})]}),e.jsx("div",{className:"text-[10px] text-indigo-600 font-medium mt-1",children:((q=r==null?void 0:r.treatmentStats)==null?void 0:q.averageCompletion)===0&&((X=r==null?void 0:r.treatmentStats)==null?void 0:X.total)>0?"Planned Strategies":"Completion Rate"})]})]}),e.jsxs(m,{className:"border-none shadow-sm bg-gradient-to-br from-amber-50 to-white overflow-hidden",children:[e.jsx(x,{className:"pb-1 p-4",children:e.jsx(h,{className:"text-xs font-bold text-amber-600 uppercase tracking-wider",children:"Models"})}),e.jsx(u,{className:"p-4 pt-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-3xl font-black text-amber-700",children:(r==null?void 0:r.threatModelCount)||0}),e.jsx(Ne,{className:"h-8 w-8 text-amber-200"})]})})]}),e.jsxs(m,{className:"border-none shadow-sm bg-blue-600 text-white overflow-hidden",children:[e.jsx(x,{className:"pb-1 p-4",children:e.jsx(h,{className:"text-xs font-bold uppercase tracking-wider text-blue-100",children:"Overall Score"})}),e.jsxs(u,{className:"p-4 pt-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-3xl font-black",children:[W,"%"]}),e.jsx(Fe,{className:"h-8 w-8 text-blue-400"})]}),e.jsx(ae,{value:W,className:"h-1 mt-2 bg-blue-400/30"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(m,{className:"lg:col-span-2 shadow-sm border-slate-200",children:[e.jsxs(x,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(h,{className:"text-lg font-bold",children:"Residual Risk Profile"}),e.jsx(B,{children:"Consolidated security and privacy posture."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(V,{variant:"secondary",className:"bg-red-50 text-red-700 border-red-100",children:[((Z=r==null?void 0:r.residualStats)==null?void 0:Z.critical)||0," Critical"]}),e.jsxs(V,{variant:"secondary",className:"bg-orange-50 text-orange-700 border-orange-100",children:[((ee=r==null?void 0:r.residualStats)==null?void 0:ee.high)||0," High"]})]})]}),e.jsx(u,{className:"h-[300px]",children:e.jsx(je,{width:"100%",height:"100%",children:e.jsxs(fe,{cx:"50%",cy:"50%",outerRadius:"80%",data:K,children:[e.jsx(ve,{stroke:"#e2e8f0"}),e.jsx(be,{dataKey:"subject",tick:{fill:"#64748b",fontSize:11}}),e.jsx(ge,{name:"Level",dataKey:"A",stroke:"#3b82f6",fill:"#3b82f6",fillOpacity:.5}),e.jsx(pe,{})]})})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(m,{className:"shadow-sm border-slate-200",children:[e.jsx(x,{className:"pb-3",children:e.jsxs(h,{className:"text-sm font-bold flex items-center",children:[e.jsx(le,{className:"mr-2 h-4 w-4 text-emerald-500"})," Privacy Health"]})}),e.jsxs(u,{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsx("span",{className:"text-slate-500",children:"LINDDUN Analysis"}),e.jsx(V,{className:j?"bg-emerald-50 text-emerald-700 border-emerald-100":"bg-slate-50 text-slate-400 border-slate-100",children:j?"Complete":"Pending"})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsx("span",{className:"text-slate-500",children:"Privacy Risks"}),e.jsx("span",{className:"font-bold",children:((s=r==null?void 0:r.riskStats)==null?void 0:s.privacyRisks)||0})]}),e.jsx(f,{variant:"outline",className:"w-full text-xs h-9",onClick:()=>U("privacy"),children:"View Privacy Details"})]})]}),I.projectType==="ai"&&e.jsxs(m,{className:"shadow-sm border-slate-200 bg-indigo-50/30",children:[e.jsx(x,{className:"pb-3",children:e.jsxs(h,{className:"text-sm font-bold flex items-center",children:[e.jsx(Qe,{className:"mr-2 h-4 w-4 text-indigo-500"})," AI RMF 1.0 Status"]})}),e.jsxs(u,{children:[e.jsx("p",{className:"text-xs text-slate-500 mb-3 tracking-tight",children:"AI risk management frameworks applied to this project scope."}),e.jsx(ae,{value:75,className:"h-1 bg-indigo-100"})]})]})]})]}),e.jsxs(m,{className:"shadow-sm border-slate-200",children:[e.jsxs(x,{className:"flex flex-row items-center justify-between",children:[e.jsx(h,{className:"text-lg font-bold",children:"Recent Risks"}),e.jsxs(f,{variant:"ghost",size:"sm",className:"text-blue-600",onClick:()=>U("risks"),children:["View Full Register ",e.jsx(ze,{className:"ml-2 h-4 w-4"})]})]}),e.jsx(u,{children:e.jsx("div",{className:"space-y-2",children:(n=l==null?void 0:l.items)==null?void 0:n.slice(0,3).map(i=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-xl border border-slate-100 hover:border-blue-200 hover:bg-blue-50/30 transition-all cursor-pointer group",onClick:()=>{S(i),N(!0)},children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${i.inherentRisk==="Critical"?"bg-red-500":i.inherentRisk==="High"?"bg-orange-500":"bg-yellow-500"}`}),e.jsx("span",{className:"text-sm font-medium text-slate-700 group-hover:text-blue-700",children:i.title})]}),e.jsx(te,{className:"h-4 w-4 text-slate-300 group-hover:text-blue-400 group-hover:translate-x-1 transition-all"})]},i.id))})})]})]}),e.jsx(F,{value:"security",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(m,{className:"lg:col-span-2 shadow-sm border-slate-200",children:[e.jsxs(x,{children:[e.jsx(h,{children:"NIST CSF Maturity Breakdown"}),e.jsx(B,{children:"Function-level maturity scores derived from identified risks and controls."})]}),e.jsx(u,{className:"h-[400px]",children:e.jsx(je,{width:"100%",height:"100%",children:e.jsxs(fe,{cx:"50%",cy:"50%",outerRadius:"80%",data:K,children:[e.jsx(ve,{stroke:"#e2e8f0"}),e.jsx(be,{dataKey:"subject",tick:{fill:"#64748b",fontSize:12}}),e.jsx(Ue,{angle:30,domain:[0,100]}),e.jsx(ge,{name:"Security",dataKey:"A",stroke:"#3b82f6",fill:"#3b82f6",fillOpacity:.6}),e.jsx(pe,{})]})})})]}),e.jsxs(m,{className:"shadow-sm border-slate-200",children:[e.jsxs(x,{children:[e.jsx(h,{children:"OWASP Attack Surface"}),e.jsx(B,{children:"Risk concentration in common application attack vectors."})]}),e.jsx(u,{className:"space-y-5",children:Q.map(i=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-xs font-semibold",children:[e.jsx("span",{children:i.name}),e.jsxs("span",{className:"text-slate-400",children:[i.score,"% Risk"]})]}),e.jsx(ae,{value:i.score,className:"h-1.5"})]},i.name))})]})]})}),e.jsx(F,{value:"privacy",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(m,{className:"shadow-sm border-slate-200 bg-emerald-50/20",children:[e.jsx(x,{children:e.jsxs(h,{className:"text-lg flex items-center",children:[e.jsx(le,{className:"mr-2 h-5 w-5 text-emerald-500"})," LINDDUN Framework Status"]})}),e.jsxs(u,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 rounded-xl bg-white border border-emerald-100",children:[e.jsx("div",{className:"text-xs text-slate-500 font-medium mb-1 uppercase",children:"Models Active"}),e.jsx("div",{className:"text-2xl font-bold text-emerald-700",children:(p==null?void 0:p.filter(i=>i.methodology==="LINDDUN").length)||0})]}),e.jsxs("div",{className:"p-4 rounded-xl bg-white border border-emerald-100",children:[e.jsx("div",{className:"text-xs text-slate-500 font-medium mb-1 uppercase",children:"Privacy Risks"}),e.jsx("div",{className:"text-2xl font-bold text-emerald-700",children:((o=r==null?void 0:r.riskStats)==null?void 0:o.privacyRisks)||0})]})]}),e.jsx(f,{className:"w-full bg-emerald-600 hover:bg-emerald-700",onClick:()=>C(`/clients/${t}/dev/projects/${v}/threat-model/${(j==null?void 0:j.id)||"new"}?methodology=LINDDUN&source=general`),children:j?"Open Privacy Threat Model":"Start LINDDUN Analysis"})]})]}),e.jsxs(m,{className:"lg:col-span-2 shadow-sm border-slate-200",children:[e.jsxs(x,{children:[e.jsx(h,{children:"Identified Privacy Threats"}),e.jsx(B,{children:"Data protection risks affecting personal information and subject rights."})]}),e.jsx(u,{children:e.jsx("div",{className:"space-y-3",children:((T=l==null?void 0:l.items)==null?void 0:T.filter(i=>i.privacyImpact).length)===0?e.jsx("div",{className:"text-center py-12 text-slate-400 text-sm italic border-2 border-dashed rounded-xl",children:"No privacy-specific risks identified."}):(ce=l==null?void 0:l.items)==null?void 0:ce.filter(i=>i.privacyImpact).map(i=>e.jsxs("div",{className:"p-4 rounded-xl border border-emerald-50 bg-emerald-50/10 hover:bg-emerald-50/30 transition-all cursor-pointer flex justify-between items-center group",onClick:()=>{S(i),N(!0)},children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-slate-800 text-sm group-hover:text-emerald-700 mb-1",children:i.title}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(V,{className:"bg-emerald-100 text-emerald-700 hover:bg-emerald-100 text-[10px] h-4",children:"Privacy"}),e.jsxs("span",{className:"text-[10px] text-slate-400 font-medium",children:["Risk: ",i.inherentRisk]})]})]}),e.jsx(te,{className:"h-4 w-4 text-emerald-300 group-hover:translate-x-1 transition-all"})]},i.id))})})]})]})}),e.jsx(F,{value:"risks",className:"space-y-6",children:e.jsxs(m,{className:"shadow-sm border-slate-200 min-h-[500px]",children:[e.jsxs(x,{className:"flex flex-row items-center justify-between border-b border-slate-100 pb-4",children:[e.jsxs("div",{children:[e.jsx(h,{className:"text-xl font-bold",children:"Project Risk Register"}),e.jsx(B,{children:"Click any risk to update its assessment, treatments, or status."})]}),e.jsxs(f,{className:"shadow-md bg-blue-600 hover:bg-blue-700 rounded-xl",onClick:()=>{S(null),N(!0)},children:[e.jsx(ie,{className:"mr-2 h-4 w-4"})," Add Risk Entry"]})]}),e.jsx(u,{className:"p-0",children:e.jsx("div",{className:"divide-y divide-slate-100",children:((ne=l==null?void 0:l.items)==null?void 0:ne.length)===0?e.jsx("div",{className:"text-center py-20 text-slate-400 italic",children:"No risks have been documented for this project yet."}):(de=l==null?void 0:l.items)==null?void 0:de.map(i=>e.jsxs("div",{className:"flex items-center justify-between p-4 hover:bg-slate-50 transition-colors cursor-pointer group",onClick:()=>{S(i),N(!0)},children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`w-3 h-3 rounded-full shrink-0 ${i.inherentRisk==="Critical"?"bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)]":i.inherentRisk==="High"?"bg-orange-500":i.inherentRisk==="Medium"?"bg-yellow-500":"bg-blue-500"}`}),e.jsxs("div",{children:[e.jsx("div",{className:"font-bold text-slate-900 group-hover:text-blue-600 transition-colors",children:i.title}),e.jsxs("div",{className:"flex gap-3 mt-1",children:[e.jsxs("span",{className:"text-xs text-slate-400 font-medium flex items-center",children:[e.jsx(Be,{className:"w-3 h-3 mr-1"})," ",i.status]}),i.privacyImpact&&e.jsxs("span",{className:"text-xs text-emerald-600 font-bold flex items-center bg-emerald-50 px-1.5 rounded",children:[e.jsx(le,{className:"w-2.5 h-2.5 mr-1"})," Privacy"]}),i.owaspCategory&&e.jsx("span",{className:"text-xs text-orange-600 font-medium px-1.5 rounded bg-orange-50 border border-orange-100",children:i.owaspCategory})]})]})]}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"text-right hidden sm:block",children:[e.jsxs("div",{className:"text-xs font-bold text-slate-900",children:["Score: ",i.inherentScore||0]}),e.jsxs("div",{className:"text-[10px] text-slate-400 uppercase tracking-tighter",children:["Residual: ",i.residualScore||0]})]}),e.jsx(te,{className:"h-5 w-5 text-slate-300 group-hover:text-blue-400 group-hover:translate-x-1 transition-all"})]})]},i.id))})})]})})]}),e.jsx(Ye,{open:M,onOpenChange:N,clientId:t,initialData:_,onSuccess:()=>{O(),a()}})]})})};export{st as ProjectDetail};
