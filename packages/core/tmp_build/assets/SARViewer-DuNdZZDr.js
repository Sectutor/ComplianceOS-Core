import{ab as he,r as j,t as v,R as ue,j as e,x as pe,c as b,C as K,d as q,e as U,m as G,L as i,I as y,E as f,G as N,H as S,J as w,K as r,f as je,N as ve,O as be,P as $,Q as g,V as ye,W as u,k as ge,D as fe,o as Ne,p as Se,q as we,s as Ce,w as Ae,i as C}from"./index-DOc7Nwb7.js";import{D as _}from"./DashboardLayout-aHnUqq57.js";import{B as Y}from"./Breadcrumb-CRi3LAxS.js";import{T as O}from"./textarea-BtxBxzdY.js";import{T as Re,a as De,b as X,c as Z}from"./tabs-CBDTXbEn.js";import{S as ee}from"./searchable-select-CvBIVEjS.js";import{A as Ie}from"./activity-B1F2IRm3.js";import{S as ke}from"./shield-alert-iAruRy4W.js";import{R as Te}from"./refresh-cw-Cjym1DSW.js";import{P as Le}from"./printer-B-Q0xXOk.js";import{S as He}from"./save-CvVmWchr.js";import{P as Oe}from"./plus-BaQ35Jcx.js";import{P as Me}from"./pen-BlTNmlLB.js";import"./index--2vFva6Y.js";import"./search-CwuIBBPE.js";import"./filter-Ceo--4mb.js";import"./clipboard-check-CQkJX5J0.js";import"./sparkles-CoQ80pK2.js";import"./send-FW7-3cjH.js";import"./scroll-area-DPaNxEJD.js";import"./settings-CIu9FFiX.js";import"./circle-check-C5kiwRoG.js";import"./en-US-Bfz1jvxT.js";import"./getTimezoneOffsetInMilliseconds-em2BGgN1.js";import"./rocket-C2MuHhsn.js";import"./scale-BCebIfgE.js";import"./layout-grid-CGqkIAJU.js";import"./book-open-BffBrdze.js";import"./zap-B01fFOkT.js";import"./star-BTvaCCU4.js";import"./briefcase-BxorFA78.js";import"./target-cfAj3L6j.js";import"./database-Bjtecw5f.js";import"./shield-check-ETs8j4-d.js";import"./brain-C-Zi22rJ.js";import"./link-FmUqdGRG.js";import"./lock-czWF3qbC.js";import"./globe-BMGZmoaJ.js";import"./calendar-BlLJlGbj.js";import"./message-square-5hBo7zY3.js";import"./upload-BBmUECj8.js";import"./user-CqRnJLgW.js";import"./chevrons-up-down-COXP-OtJ.js";function Cs(){const se=he(),x=Number(se.id),L=window.location,M=L.pathname.includes("sar-172")||L.pathname.includes("172"),V=M?"sar-172":"sar-171",J=M?"NIST 800-172":"NIST 800-171",A=M?"NIST 800-172":"NIST 800-171";j.useEffect(()=>{console.log(`[SAR] Resolved Framework: ${A} (path: ${L.pathname})`)},[A,L.pathname]);const{data:R,isLoading:ae,refetch:z}=v.federal.listSARs.useQuery({clientId:x}),{data:p}=v.users.listWorkspaceMembers.useQuery({clientId:x}),{data:H}=v.risks.getAll.useQuery({clientId:x}),{data:c}=v.clientControls.list.useQuery({clientId:x});j.useEffect(()=>{if(console.log("[SAR Diagnostics] Framework Key:",A),console.log("[SAR Diagnostics] Client Controls:",(c==null?void 0:c.length)||0,"controls loaded"),c){const s=Array.from(new Set(c.map(o=>{var n;return(n=o.control)==null?void 0:n.framework}))).filter(Boolean);console.log("[SAR Diagnostics] Available Frameworks:",s)}console.log("[SAR Diagnostics] Workspace Members:",(p==null?void 0:p.length)||0,"members loaded"),console.log("[SAR Diagnostics] Risks:",(H==null?void 0:H.length)||0,"risks loaded")},[c,p,H,A]);const te=v.federal.createSAR.useMutation(),le=v.federal.updateSAR.useMutation(),P=v.federal.saveSarFinding.useMutation(),l=(R==null?void 0:R.find(s=>{var o;return(o=s.title)==null?void 0:o.includes(V==="sar-171"?"171":"172")}))||(R==null?void 0:R[0]),D=l==null?void 0:l.id,{data:F,refetch:B}=v.federal.getSarFindings.useQuery({sarId:D,clientId:x},{enabled:!!D}),[t,d]=j.useState({}),[re,m]=j.useState(!1);j.useEffect(()=>{l&&d({systemAcronym:l.systemAcronym||"",systemIdentification:l.systemIdentification||"",systemType:l.systemType||"",version:l.version||"",agency:l.agency||"",assessmentCompletionDate:l.assessmentCompletionDate?new Date(l.assessmentCompletionDate).toISOString().split("T")[0]:"",systemOwnerId:l.systemOwnerId,confidentiality:l.confidentiality||"Moderate",integrity:l.integrity||"Moderate",availability:l.availability||"Moderate",impact:l.impact||"Moderate",packageType:l.packageType||"",executiveSummary:l.executiveSummary||"",assessorName:l.assessorName||""})},[l]);const E=ue.useMemo(()=>{if(!c)return console.log("[SAR Filter] clientControls is null/undefined"),[];console.log("[SAR Filter Debug] Total Controls:",c.length),console.log("[SAR Filter Debug] Target Framework:",A),console.log("[SAR Filter Debug] Framework Slug:",V),c.length>0&&console.log("[SAR Filter Debug] Sample controls:",c.slice(0,3).map(o=>{var n,I;return{id:(n=o.control)==null?void 0:n.controlId,framework:(I=o.control)==null?void 0:I.framework}}));const s=c.filter(o=>{var T;const n=(T=o.control)==null?void 0:T.framework;return(n==null?void 0:n.includes("NIST"))||(n==null?void 0:n.includes("800-171"))||(n==null?void 0:n.includes("800-172"))}).map(o=>{var n,I,T,Q,W;return{label:`${((n=o.control)==null?void 0:n.controlId)||"Custom"}: ${(I=o.control)==null?void 0:I.name}`,value:((T=o.control)==null?void 0:T.controlId)||String(o.clientControl.id),description:((W=(Q=o.control)==null?void 0:Q.description)==null?void 0:W.substring(0,50))+"..."}});return console.log("[SAR Filter Debug] Filtered Count:",s.length),s},[c,A,V]);j.useEffect(()=>{console.log("[SAR Filter Debug] Final Filtered Count:",E.length)},[E.length]);const ie=async()=>{if(D)try{await le.mutateAsync({clientId:x,id:D,...t,systemOwnerId:t.systemOwnerId?Number(t.systemOwnerId):void 0,assessmentCompletionDate:t.assessmentCompletionDate||void 0}),C.success("SAR Header updated successfully."),m(!1),z()}catch(s){C.error(`Failed to update header: ${s.message}`)}},[oe,k]=j.useState(!1),[a,h]=j.useState(null),ne=()=>{h({controlId:"",overlay:"",result:"other_than_satisfied",naJustification:"",vulnerabilitySummary:"",vulnerabilitySeverity:"low",residualRiskLevel:"low",recommendations:"",observation:""})},ce=()=>{ne(),h(null),k(!0)},de=s=>{h({...s}),k(!0)},me=async()=>{if(!D)return;const s=a||{};if(!s.controlId){C.error("Control ID is required.");return}try{await P.mutateAsync({clientId:x,sarId:D,...s,result:s.result||"other_than_satisfied",riskLevel:s.riskLevel||s.vulnerabilitySeverity||"low"}),C.success("Finding saved."),B(),k(!1)}catch(o){C.error(`Failed to save finding: ${o.message}`)}},xe=async()=>{const s=`${J} SAR`;try{await te.mutateAsync({clientId:x,title:s,assessorName:"Assessor"}),C.success("SAR Created. You can now configure it."),z()}catch(o){C.error(`Failed to create SAR: ${o.message}`)}};return ae?e.jsx(_,{children:e.jsx("div",{className:"p-8 flex justify-center",children:e.jsx(pe,{className:"animate-spin"})})}):l?e.jsx(_,{children:e.jsxs("div",{className:"p-6 space-y-6 max-w-[1400px] mx-auto text-slate-900",children:[e.jsx(Y,{items:[{label:"Dashboard",href:`/clients/${x}/dashboard`},{label:"Federal Hub",href:`/clients/${x}/federal`},{label:"DoD SAR"}]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-black tracking-tight flex items-center gap-2",children:[e.jsx(ke,{className:"h-8 w-8 text-blue-700"}),"DoD Security Assessment Report (SAR)"]}),e.jsxs("p",{className:"text-slate-500 font-medium",children:["System Assessment Results - v",t.version||"1.0"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(b,{variant:"outline",onClick:B,children:[e.jsx(Te,{className:"h-4 w-4 mr-2"})," Refresh"]}),e.jsxs(b,{variant:"outline",className:"border-slate-300",children:[e.jsx(Le,{className:"h-4 w-4 mr-2"})," Print PDF"]})]})]}),e.jsxs(K,{className:"border-slate-300 shadow-sm bg-slate-50/50",children:[e.jsx(q,{className:"pb-2 border-b border-slate-200 bg-white rounded-t-lg",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(U,{className:"text-lg font-bold text-slate-800",children:"1. System Characterization & Assessment Details"}),re&&e.jsxs(b,{size:"sm",onClick:ie,className:"bg-amber-600 hover:bg-amber-700 text-white",children:[e.jsx(He,{className:"h-4 w-4 mr-2"})," Save Changes"]})]})}),e.jsxs(G,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{className:"text-xs uppercase font-bold text-slate-500",children:"(1) System Name"}),e.jsx(y,{value:t.systemIdentification||l.title,onChange:s=>{d({...t,systemIdentification:s.target.value}),m(!0)},className:"bg-white"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{className:"text-xs uppercase font-bold text-slate-500",children:"(2) System Acronym"}),e.jsx(y,{value:t.systemAcronym,onChange:s=>{d({...t,systemAcronym:s.target.value}),m(!0)},className:"bg-white"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{className:"text-xs uppercase font-bold text-slate-500",children:"(3) Agency (CC/S/A/FA)"}),e.jsx(y,{value:t.agency,onChange:s=>{d({...t,agency:s.target.value}),m(!0)},className:"bg-white"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{className:"text-xs uppercase font-bold text-slate-500",children:"(5) System Type"}),e.jsx(y,{value:t.systemType,onChange:s=>{d({...t,systemType:s.target.value}),m(!0)},className:"bg-white"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{className:"text-xs uppercase font-bold text-slate-500",children:"Version / Release"}),e.jsx(y,{value:t.version,onChange:s=>{d({...t,version:s.target.value}),m(!0)},className:"bg-white"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{className:"text-xs uppercase font-bold text-slate-500",children:"(9) Last Update"}),e.jsx(y,{disabled:!0,value:l.updatedAt?new Date(l.updatedAt).toLocaleDateString():"N/A",className:"bg-slate-100"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{className:"text-xs uppercase font-bold text-slate-500",children:"(8) Assessment Completion"}),e.jsx(y,{type:"date",value:t.assessmentCompletionDate,onChange:s=>{d({...t,assessmentCompletionDate:s.target.value}),m(!0)},className:"bg-white"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{className:"text-xs uppercase font-bold text-slate-500",children:"(11) System Owner (ISO)"}),e.jsx(ee,{placeholder:"Select Owner...",value:t.systemOwnerId?String(t.systemOwnerId):"",onSelect:s=>{d({...t,systemOwnerId:s}),m(!0)},emptyText:p?"No workspace members found":"Loading members...",options:(p==null?void 0:p.map(s=>({label:s.name||"Unknown",value:String(s.id)})))||[]})]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-4 p-4 bg-slate-100 rounded-lg border border-slate-200",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{className:"text-xs uppercase font-bold text-slate-500",children:"(10) Confidentiality"}),e.jsxs(f,{value:t.confidentiality,onValueChange:s=>{d({...t,confidentiality:s}),m(!0)},children:[e.jsx(N,{className:"bg-white",children:e.jsx(S,{})}),e.jsxs(w,{children:[e.jsx(r,{value:"Low",children:"Low"}),e.jsx(r,{value:"Moderate",children:"Moderate"}),e.jsx(r,{value:"High",children:"High"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{className:"text-xs uppercase font-bold text-slate-500",children:"(10) Integrity"}),e.jsxs(f,{value:t.integrity,onValueChange:s=>{d({...t,integrity:s}),m(!0)},children:[e.jsx(N,{className:"bg-white",children:e.jsx(S,{})}),e.jsxs(w,{children:[e.jsx(r,{value:"Low",children:"Low"}),e.jsx(r,{value:"Moderate",children:"Moderate"}),e.jsx(r,{value:"High",children:"High"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{className:"text-xs uppercase font-bold text-slate-500",children:"(10) Availability"}),e.jsxs(f,{value:t.availability,onValueChange:s=>{d({...t,availability:s}),m(!0)},children:[e.jsx(N,{className:"bg-white",children:e.jsx(S,{})}),e.jsxs(w,{children:[e.jsx(r,{value:"Low",children:"Low"}),e.jsx(r,{value:"Moderate",children:"Moderate"}),e.jsx(r,{value:"High",children:"High"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{className:"text-xs uppercase font-bold text-slate-500",children:"(10) Impact Level"}),e.jsxs(f,{value:t.impact,onValueChange:s=>{d({...t,impact:s}),m(!0)},children:[e.jsx(N,{className:"bg-white",children:e.jsx(S,{})}),e.jsxs(w,{children:[e.jsx(r,{value:"Low",children:"Low"}),e.jsx(r,{value:"Moderate",children:"Moderate"}),e.jsx(r,{value:"High",children:"High"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"font-bold text-slate-800",children:"(1) Security Controls Assessor Executive Summary"}),e.jsx(O,{className:"min-h-[100px] bg-white resize-none",value:t.executiveSummary,onChange:s=>{d({...t,executiveSummary:s.target.value}),m(!0)},placeholder:"Executive summary of the security assessment..."})]})]})]}),e.jsxs(K,{className:"border-slate-300 shadow-xl",children:[e.jsxs(q,{className:"bg-white border-b border-slate-100 flex flex-row justify-between items-center py-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(U,{className:"text-xl font-bold",children:"Security Assessment Results"}),e.jsx(je,{children:"Comprehensive vulnerability and compliance findings."})]}),e.jsxs(b,{onClick:ce,className:"bg-blue-600 hover:bg-blue-700 shadow-md",children:[e.jsx(Oe,{className:"h-4 w-4 mr-2"})," Add Finding"]})]}),e.jsx(G,{className:"p-0",children:e.jsxs(ve,{children:[e.jsx(be,{children:e.jsxs($,{className:"bg-slate-50 border-slate-200",children:[e.jsx(g,{className:"w-[100px] font-bold text-slate-800",children:"Control"}),e.jsx(g,{className:"w-[80px] font-bold text-slate-800",children:"Status"}),e.jsx(g,{className:"w-[100px] font-bold text-slate-800",children:"Overlay"}),e.jsx(g,{className:"font-bold text-slate-800",children:"Vulnerability Summary"}),e.jsx(g,{className:"w-[80px] font-bold text-slate-800",children:"Severity"}),e.jsx(g,{className:"w-[80px] font-bold text-slate-800",children:"Residual"}),e.jsx(g,{className:"font-bold text-slate-800",children:"Recommendations"}),e.jsx(g,{className:"w-[50px]"})]})}),e.jsx(ye,{children:!F||F.length===0?e.jsx($,{children:e.jsx(u,{colSpan:8,className:"h-40 text-center text-slate-400",children:"No findings recorded. Add items to populate the SAR."})}):F.map(s=>e.jsxs($,{className:"border-slate-100 hover:bg-slate-50 transition-colors",children:[e.jsx(u,{className:"align-top font-mono font-bold text-blue-700",children:s.controlId}),e.jsx(u,{className:"align-top",children:e.jsx(ge,{variant:s.result==="satisfied"?"outline":"destructive",className:s.result==="satisfied"?"text-emerald-600 border-emerald-200 bg-emerald-50":"",children:s.result==="satisfied"?"C":"NC"})}),e.jsx(u,{className:"align-top text-xs text-slate-500",children:s.overlay||"-"}),e.jsxs(u,{className:"align-top",children:[e.jsx("div",{className:"prose prose-sm max-w-none text-slate-700 text-xs",children:s.vulnerabilitySummary||s.observation||"No summary"}),s.naJustification&&e.jsxs("div",{className:"mt-1 text-xs text-slate-500 italic",children:[e.jsx("span",{className:"font-semibold",children:"N/A Justif:"})," ",s.naJustification]})]}),e.jsx(u,{className:"align-top text-xs font-semibold capitalize bg-slate-50",children:s.vulnerabilitySeverity||"-"}),e.jsx(u,{className:"align-top text-xs font-semibold capitalize",children:s.residualRiskLevel||"-"}),e.jsx(u,{className:"align-top text-xs text-slate-600",children:s.recommendations||s.remediationPlan||"-"}),e.jsx(u,{className:"align-top text-right",children:e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>de(s),children:e.jsx(Me,{className:"h-3 w-3 text-slate-400 hover:text-blue-600"})})})]},s.id))})]})})]}),e.jsx(fe,{open:oe,onOpenChange:k,children:e.jsxs(Ne,{className:"max-w-2xl max-h-[85vh] overflow-y-auto",children:[e.jsxs(Se,{children:[e.jsx(we,{children:a!=null&&a.id?"Edit Assessment Finding":"Add Assessment Finding"}),e.jsx(Ce,{children:"Document a finding, vulnerability, or observation for a specific control."})]}),e.jsxs(Re,{defaultValue:"general",className:"w-full",children:[e.jsxs(De,{className:"w-full grid grid-cols-2",children:[e.jsx(X,{value:"general",children:"Control & Result"}),e.jsx(X,{value:"details",children:"Vulnerability & Risk"})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs(Z,{value:"general",className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"font-bold",children:"Security Control"}),e.jsx(ee,{placeholder:"Select Control...",value:(a==null?void 0:a.controlId)||"",onSelect:s=>h({...a,controlId:s}),emptyText:c?"No controls found":"Loading controls...",options:E||[]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"font-bold",children:"Assessment Result"}),e.jsxs(f,{value:(a==null?void 0:a.result)||"other_than_satisfied",onValueChange:s=>h({...a,result:s}),children:[e.jsx(N,{children:e.jsx(S,{})}),e.jsxs(w,{children:[e.jsx(r,{value:"satisfied",children:"Satisfied (C)"}),e.jsx(r,{value:"other_than_satisfied",children:"Other Than Satisfied (NC)"}),e.jsx(r,{value:"not_applicable",children:"Not Applicable (NA)"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"font-bold",children:"Overlay"}),e.jsx(y,{value:(a==null?void 0:a.overlay)||"",onChange:s=>h({...a,overlay:s.target.value}),placeholder:"e.g. Classified"})]})]}),(a==null?void 0:a.result)==="not_applicable"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"font-bold text-amber-600",children:"N/A Justification"}),e.jsx(O,{value:(a==null?void 0:a.naJustification)||"",onChange:s=>h({...a,naJustification:s.target.value}),placeholder:"Why is this control N/A?"})]})]}),e.jsxs(Z,{value:"details",className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"font-bold",children:"Vulnerability Summary"}),e.jsx(O,{value:(a==null?void 0:a.vulnerabilitySummary)||(a==null?void 0:a.observation)||"",onChange:s=>h({...a,vulnerabilitySummary:s.target.value,observation:s.target.value}),placeholder:"Describe the vulnerability or link to Risk ID...",className:"min-h-[80px]"}),e.jsx("div",{className:"text-xs text-slate-500",children:"Tip: Mention Risk ID (e.g. RA-001) to cross-reference."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"font-bold",children:"Vulnerability Severity"}),e.jsxs(f,{value:(a==null?void 0:a.vulnerabilitySeverity)||"low",onValueChange:s=>h({...a,vulnerabilitySeverity:s}),children:[e.jsx(N,{children:e.jsx(S,{})}),e.jsxs(w,{children:[e.jsx(r,{value:"low",children:"Low"}),e.jsx(r,{value:"moderate",children:"Moderate"}),e.jsx(r,{value:"high",children:"High"}),e.jsx(r,{value:"very_high",children:"Very High"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"font-bold",children:"Residual Risk Level"}),e.jsxs(f,{value:(a==null?void 0:a.residualRiskLevel)||"low",onValueChange:s=>h({...a,residualRiskLevel:s}),children:[e.jsx(N,{children:e.jsx(S,{})}),e.jsxs(w,{children:[e.jsx(r,{value:"low",children:"Low"}),e.jsx(r,{value:"moderate",children:"Moderate"}),e.jsx(r,{value:"high",children:"High"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"font-bold",children:"Recommendations"}),e.jsx(O,{value:(a==null?void 0:a.recommendations)||(a==null?void 0:a.remediationPlan)||"",onChange:s=>h({...a,recommendations:s.target.value,remediationPlan:s.target.value}),placeholder:"Recommended corrective actions..."})]})]})]})]}),e.jsxs(Ae,{children:[e.jsx(b,{variant:"outline",onClick:()=>k(!1),children:"Cancel"}),e.jsx(b,{onClick:me,disabled:P.isPending,className:"bg-blue-600 hover:bg-blue-700",children:P.isPending?"Saving...":"Save Finding"})]})]})})]})}):e.jsx(_,{children:e.jsxs("div",{className:"p-8 space-y-6 max-w-4xl mx-auto",children:[e.jsx(Y,{items:[{label:"Dashboard",href:`/clients/${x}/dashboard`},{label:"Federal Hub",href:`/clients/${x}/federal`},{label:"SAR Viewer"}]}),e.jsxs("div",{className:"flex flex-col items-center justify-center h-[50vh] border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50",children:[e.jsx(Ie,{className:"h-12 w-12 text-blue-600 mb-4"}),e.jsxs("h2",{className:"text-xl font-bold mb-2",children:["No SAR Found for ",J]}),e.jsx(b,{onClick:xe,children:"Create SAR"})]})]})})}export{Cs as default};
