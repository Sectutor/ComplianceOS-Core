import{M as ae,j as e,C as G,d as P,e as Q,m as K,T as Z,r as b,t as y,R as le,S as ie,L as m,I as W,v as M,E as ne,G as de,H as ce,J as oe,K as w,c as v,x as me,l as xe,i as he}from"./index-DOc7Nwb7.js";import{E as pe}from"./enhanced-dialog-CeRPsI16.js";import{R as ue,a as ge}from"./radio-group-BhirXgcC.js";import{T as ye}from"./textarea-BtxBxzdY.js";import{S as _}from"./DashboardLayout-aHnUqq57.js";import{S as E}from"./scroll-area-DPaNxEJD.js";import{S as je,a as be}from"./slotNames-XB2IFQPg.js";import{s as q,g as J,a as I,b as ve}from"./riskCalculations-D9ghekGI.js";import{C as fe}from"./circle-check-big-BSqJVrgh.js";import{L as Ne}from"./layers-ZuBPQb1T.js";import{B as ke}from"./building-C0cheRWa.js";import{I as Ie}from"./info-By5wLOUH.js";import{S as X}from"./sparkles-CoQ80pK2.js";import{A as Ce}from"./arrow-right-M96iV-v9.js";/**
 * @license lucide-react v0.364.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=ae("Home",[["path",{d:"m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"y5dka4"}],["polyline",{points:"9 22 9 12 15 12 15 22",key:"e2us08"}]]);function we({inherentScore:c,residualScore:o,appetiteThreshold:d=10}){const j=q(c),r=q(o),i=c>d;return o>d?e.jsxs(G,{className:"bg-white border-black",children:[e.jsx(P,{className:"pb-2",children:e.jsxs(Q,{className:"text-sm flex items-center gap-2 text-black",children:[e.jsx(Z,{className:"w-4 h-4"})," Exceeds Risk Appetite"]})}),e.jsx(K,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-xs text-black",children:[e.jsxs("strong",{children:["Residual risk (",r,", score: ",o,")"]})," exceeds the acceptable threshold of ",d,"."]}),i&&e.jsxs("p",{className:"text-xs text-black",children:["Inherent risk (",j,", score: ",c,") also exceeds appetite."]}),e.jsx("p",{className:"text-xs text-black mt-2 font-medium",children:"⚠️ Additional controls or escalation may be required."})]})})]}):e.jsxs(G,{className:"bg-white border-gray-200",children:[e.jsx(P,{className:"pb-2",children:e.jsxs(Q,{className:"text-sm flex items-center gap-2 text-black",children:[e.jsx(fe,{className:"w-4 h-4"})," Within Risk Appetite"]})}),e.jsx(K,{children:e.jsxs("p",{className:"text-xs text-gray-600",children:["Residual risk (",r,", score: ",o,") is within the acceptable threshold of ",d,"."]})})]})}function Pe({open:c,onOpenChange:o,clientId:d,onSuccess:j,initialData:r}){var z;const[i,x]=b.useState("method"),[A,O]=b.useState(!1),[s,l]=b.useState({assessmentType:"asset",assetId:void 0,processId:"",vendorId:void 0,title:"",description:"",threatCategory:"",vulnerability:"",threatIds:[],vulnerabilityIds:[],likelihood:1,impact:1,treatmentStrategy:"mitigate",selectedControlIds:[],riskOwner:"",priority:"Medium"}),D=y.risks.upsert.useMutation();y.risks.linkControl.useMutation();const ee=y.risks.suggestControls.useMutation(),[R,B]=b.useState([]),[$,H]=b.useState(!1),{data:Se}=y.risks.getAssets.useQuery({clientId:d},{enabled:c&&i==="scope"}),{data:T}=y.risks.getThreats.useQuery({clientId:d},{enabled:c&&i==="scope"}),{data:L}=y.risks.getVulnerabilities.useQuery({clientId:d},{enabled:c&&i==="scope"}),{data:f}=y.clientControls.list.useQuery({clientId:d},{enabled:c&&i==="treatment"}),h=s.likelihood*s.impact,p=b.useMemo(()=>{if(s.treatmentStrategy!=="mitigate")return h;const t=s.selectedControlIds.length;if(t===0)return h;const a=Math.min(t*.2,.8);return Math.max(1,Math.round(h*(1-a)))},[h,s.selectedControlIds,s.treatmentStrategy]),V=t=>{if(!t)return 1;if(typeof t=="number")return t;const a=String(t).toLowerCase(),n=parseInt(a);return isNaN(n)?a.includes("critical")||a.includes("extreme")?5:a.includes("very high")?4:a.includes("high")?3:a.includes("medium")?2:1:n};le.useEffect(()=>{var t,a,n,u,g,N,k,C,U,F;c&&(r?l({assessmentType:((t=r.contextSnapshot)==null?void 0:t.assessmentType)||r.assessmentType||"asset",assetId:((a=r.contextSnapshot)==null?void 0:a.assetId)||r.assetId,processId:((n=r.contextSnapshot)==null?void 0:n.processId)||r.processId||"",vendorId:((u=r.contextSnapshot)==null?void 0:u.vendorId)||r.vendorId,title:r.title||"",description:((g=r.contextSnapshot)==null?void 0:g.description)||r.description||"",threatCategory:((N=r.contextSnapshot)==null?void 0:N.threatCategory)||r.threatCategory||"",vulnerability:((k=r.contextSnapshot)==null?void 0:k.vulnerability)||r.vulnerability||"",threatIds:((C=r.contextSnapshot)==null?void 0:C.threatIds)||r.threatIds||(r.threatId?[r.threatId]:[]),vulnerabilityIds:((U=r.contextSnapshot)==null?void 0:U.vulnerabilityIds)||r.vulnerabilityIds||(r.vulnerabilityId?[r.vulnerabilityId]:[]),likelihood:V(r.likelihood),impact:V(r.impact),treatmentStrategy:r.treatmentStrategy||"mitigate",selectedControlIds:((F=r.contextSnapshot)==null?void 0:F.controlIds)||r.controlIds||[],riskOwner:r.riskOwner||"",priority:r.priority||"Medium"}):(l({assessmentType:"asset",assetId:void 0,processId:"",vendorId:void 0,title:"",description:"",threatCategory:"",vulnerability:"",threatIds:[],vulnerabilityIds:[],likelihood:1,impact:1,treatmentStrategy:"mitigate",selectedControlIds:[],riskOwner:"",priority:"Medium"}),x("method")))},[c,r]);const se=()=>{i==="method"?x("scope"):i==="scope"?x("analysis"):i==="analysis"&&x("treatment")},te=()=>{i==="treatment"?x("analysis"):i==="analysis"?x("scope"):i==="scope"&&x("method")},re=async()=>{O(!0);try{const t=await D.mutateAsync({id:r==null?void 0:r.id,clientId:d,title:s.title,likelihood:s.likelihood,impact:s.impact,status:"draft",riskOwner:s.riskOwner,treatmentOption:s.treatmentStrategy,priority:s.priority,residualScore:p,residualRisk:I(p),threatDescription:s.description,contextSnapshot:{assessmentType:s.assessmentType,assetId:s.assetId,processId:s.processId,vendorId:s.vendorId,description:s.description,threatCategory:s.threatCategory,vulnerability:s.vulnerability,threatIds:s.threatIds,vulnerabilityIds:s.vulnerabilityIds,controlIds:s.selectedControlIds,riskOwner:s.riskOwner,treatmentStrategy:s.treatmentStrategy,priority:s.priority,residualScore:p,residualRisk:I(p)}});if(s.treatmentStrategy==="mitigate"&&s.selectedControlIds.length>0)for(const a of s.selectedControlIds);j(),o(!1)}catch(t){console.error("Failed to save risk assessment",t),he.error("Failed to save risk",{description:t.message||"An unexpected error occurred."})}finally{O(!1)}};return e.jsx(pe,{open:c,onOpenChange:o,title:e.jsxs("div",{children:[e.jsx("div",{className:"mb-2",children:r?"Edit Risk Assessment":"New Risk Assessment"}),e.jsx("div",{className:"flex gap-2 mt-2",children:["Method","Scope & ID","Analysis","Treatment"].map((t,a)=>e.jsxs("div",{onClick:()=>x(["method","scope","analysis","treatment"][a]),className:`text-xs font-medium px-2 py-1 rounded cursor-pointer transition-colors ${["method","scope","analysis","treatment"].indexOf(i)===a?"bg-blue-100 text-blue-700":["method","scope","analysis","treatment"].indexOf(i)>a?"text-blue-600":"text-gray-400 hover:text-gray-600"}`,children:[a+1,". ",t]},t))})]}),description:"Follow the steps to assess and treat a risk scenario.",size:"lg",footer:e.jsxs("div",{className:"flex w-full justify-between",children:[e.jsx(v,{variant:"ghost",onClick:()=>o(!1),children:"Cancel"}),e.jsxs("div",{className:"flex gap-2",children:[i!=="method"&&e.jsx(v,{variant:"outline",onClick:te,className:"border-blue-200 text-blue-700 hover:bg-blue-50 hover:text-blue-800",children:"Back"}),i!=="treatment"?e.jsxs(v,{onClick:se,className:"bg-blue-600 hover:bg-blue-700 text-white",children:["Next ",e.jsx(Ce,{className:"w-4 h-4 ml-2"})]}):e.jsx(v,{onClick:re,disabled:A,className:"bg-blue-600 hover:bg-blue-700 text-white",children:A?r?"Updating...":"Creating...":r?"Update Risk":"Create Risk"})]})]}),children:e.jsxs("div",{className:"py-2 min-h-[300px]",children:[i==="method"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(S,{icon:ie,title:"Asset-Based",description:"Assess specific assets.",selected:s.assessmentType==="asset",onClick:()=>l({...s,assessmentType:"asset"})}),e.jsx(S,{icon:Z,title:"Scenario-Based",description:"Assess threat scenarios.",selected:s.assessmentType==="scenario",onClick:()=>l({...s,assessmentType:"scenario"})}),e.jsx(S,{icon:Ne,title:"Process-Based",description:"Assess business processes.",selected:s.assessmentType==="process",onClick:()=>l({...s,assessmentType:"process"})}),e.jsx(S,{icon:ke,title:"Vendor-Based",description:"Assess third-party vendors.",selected:s.assessmentType==="vendor",onClick:()=>l({...s,assessmentType:"vendor"})})]}),i==="scope"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs(m,{className:"text-base",children:["1. Define Scope (",s.assessmentType,")"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Title *"}),e.jsx(W,{placeholder:"Risk Title (e.g. Data Breach)",value:s.title,onChange:t=>l({...s,title:t.target.value})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(m,{className:"text-base",children:"2. Risk Context"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(m,{children:["Threats (",s.threatIds.length," selected)"]}),e.jsx(E,{className:"h-[150px] border rounded-md p-2",children:e.jsx("div",{className:"space-y-1",children:T&&T.length>0?T.map(t=>e.jsxs("div",{className:"flex items-center gap-2 p-1.5 hover:bg-gray-50 rounded text-sm",children:[e.jsx(M,{checked:s.threatIds.includes(t.id),onCheckedChange:a=>{l(a?{...s,threatIds:[...s.threatIds,t.id]}:{...s,threatIds:s.threatIds.filter(n=>n!==t.id)})}}),e.jsx("span",{className:"truncate",children:t.name})]},t.id)):e.jsx("div",{className:"text-sm text-gray-400 p-2",children:"No threats found. Add threats first."})})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(m,{children:["Vulnerabilities (",s.vulnerabilityIds.length," selected)"]}),e.jsx(E,{className:"h-[150px] border rounded-md p-2",children:e.jsx("div",{className:"space-y-1",children:L&&L.length>0?L.map(t=>e.jsxs("div",{className:"flex items-center gap-2 p-1.5 hover:bg-gray-50 rounded text-sm",children:[e.jsx(M,{checked:s.vulnerabilityIds.includes(t.id),onCheckedChange:a=>{l(a?{...s,vulnerabilityIds:[...s.vulnerabilityIds,t.id]}:{...s,vulnerabilityIds:s.vulnerabilityIds.filter(n=>n!==t.id)})}}),e.jsx("span",{className:"truncate",children:t.name})]},t.id)):e.jsx("div",{className:"text-sm text-gray-400 p-2",children:"No vulnerabilities found. Add vulnerabilities first."})})})]})]}),e.jsx(ye,{placeholder:"Description...",value:s.description,onChange:t=>l({...s,description:t.target.value})})]})]}),i==="analysis"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-slate-50 p-3 rounded-lg border border-slate-200 mb-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ie,{className:"h-4 w-4 text-blue-600 mt-0.5"}),e.jsxs("div",{className:"text-[11px] space-y-1",children:[e.jsx("h4",{className:"font-semibold text-slate-900",children:"Risk Calculation Methodology"}),e.jsxs("p",{className:"text-slate-600 leading-relaxed",children:["Scores are calculated using a 5x5 matrix: ",e.jsx("br",{}),e.jsx("span",{className:"font-mono bg-slate-200 px-1 py-0.5 rounded text-[10px]",children:"Likelihood (1-5) × Impact (1-5) = Risk Score"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-2 text-[10px] text-slate-500 font-medium pt-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-red-800"})," 20-25: Critical"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-red-600"})," 15-19: Very High"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-orange-500"})," 8-14: High"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-amber-500"})," 4-7: Medium"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-emerald-600"})," 1-3: Low"]})]})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center bg-violet-50/50 p-4 rounded-lg border border-violet-100",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(m,{className:"text-violet-900 font-bold",children:"Inherent Risk Scoring"}),e.jsx("p",{className:"text-[10px] text-violet-700",children:"Use AI to analyze the threat/vulnerability and suggest scores."})]}),e.jsx(je,{name:be.RISK_AUTO_TRIAGE,props:{clientId:d,threatDescription:s.description||"",vulnerabilityDescription:s.vulnerability||"",affectedAssets:s.assets,onAnalysisComplete:t=>{l(a=>({...a,likelihood:parseInt(t.likelihood),impact:parseInt(t.impact),notes:(a.notes||"")+`

[AI Triage]: ${t.reasoning}`}))}}})]}),e.jsx("div",{className:"flex justify-between mt-4",children:e.jsxs(m,{children:["Likelihood (",s.likelihood,")"]})}),e.jsx(_,{value:[s.likelihood],onValueChange:([t])=>l({...s,likelihood:t}),max:5,min:1,step:1,className:"py-4",rangeClassName:"bg-blue-700"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(m,{children:"Priority"}),e.jsxs(ne,{value:s.priority,onValueChange:t=>l({...s,priority:t}),children:[e.jsx(de,{children:e.jsx(ce,{placeholder:"Select Priority"})}),e.jsxs(oe,{children:[e.jsx(w,{value:"Critical",children:"Critical"}),e.jsx(w,{value:"High",children:"High"}),e.jsx(w,{value:"Medium",children:"Medium"}),e.jsx(w,{value:"Low",children:"Low"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-between",children:e.jsxs(m,{children:["Impact (",s.impact,")"]})}),e.jsx(_,{value:[s.impact],onValueChange:([t])=>l({...s,impact:t}),max:5,min:1,step:1,className:"py-4",rangeClassName:"bg-blue-700"})]}),e.jsxs("div",{className:"bg-gray-50 p-6 rounded-xl flex items-center justify-between border border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Inherent Score"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Before Controls"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`text-3xl font-bold ${J(I(h))}`,children:h}),e.jsx(Y,{score:h})]})]})]}),i==="treatment"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(m,{children:"Risk Owner"}),e.jsx(W,{placeholder:"Enter Risk Owner Name or Email",value:s.riskOwner,onChange:t=>l({...s,riskOwner:t.target.value})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(m,{children:"Strategy"}),e.jsx(ue,{value:s.treatmentStrategy,onValueChange:t=>l({...s,treatmentStrategy:t}),className:"grid grid-cols-4 gap-2",children:["mitigate","accept","transfer","avoid"].map(t=>e.jsxs("div",{className:`border rounded p-3 cursor-pointer ${s.treatmentStrategy===t?"border-blue-500 bg-blue-50":""}`,children:[e.jsx(ge,{value:t,id:t,className:"sr-only"}),e.jsx(m,{htmlFor:t,className:"capitalize cursor-pointer",children:t})]},t))})]}),s.treatmentStrategy==="mitigate"&&e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(m,{children:"Select Controls to Mitigate Risk"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:[s.selectedControlIds.length," selected"]}),e.jsxs(v,{variant:"outline",size:"sm",disabled:$||!s.description,onClick:async()=>{H(!0),B([]);try{const t=await ee.mutateAsync({clientId:d,threat:s.threatCategory||s.description||"Unknown threat",vulnerability:s.vulnerability||s.description||"Unknown vulnerability"});B(t.suggestions||[])}catch(t){console.error("AI suggestion failed",t)}H(!1)},children:[$?e.jsx(me,{className:"w-4 h-4 animate-spin"}):e.jsx(X,{className:"w-4 h-4"}),e.jsx("span",{className:"ml-1",children:"AI Suggest"})]})]})]}),R.length>0&&e.jsxs("div",{className:"bg-purple-50 dark:bg-purple-900/20 border border-purple-200 rounded-lg p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm font-medium text-purple-700 dark:text-purple-300 flex items-center gap-1",children:[e.jsx(X,{className:"w-4 h-4"})," AI Recommendations"]}),e.jsxs(v,{size:"sm",variant:"secondary",onClick:()=>{const t=R.map(a=>a.clientControlId).filter(a=>!s.selectedControlIds.includes(a));l({...s,selectedControlIds:[...s.selectedControlIds,...t]})},children:[e.jsx(xe,{className:"w-3 h-3 mr-1"})," Apply All"]})]}),e.jsx("div",{className:"space-y-1",children:R.map(t=>{var a,n,u,g;return e.jsxs("div",{className:`text-xs p-2 rounded flex justify-between items-start cursor-pointer transition-colors ${s.selectedControlIds.includes(t.clientControlId)?"bg-purple-200 dark:bg-purple-800":"bg-white dark:bg-gray-800 hover:bg-purple-100"}`,onClick:()=>{s.selectedControlIds.includes(t.clientControlId)||l({...s,selectedControlIds:[...s.selectedControlIds,t.clientControlId]})},children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:((n=(a=t.details)==null?void 0:a.control)==null?void 0:n.name)||((g=(u=t.details)==null?void 0:u.clientControl)==null?void 0:g.customDescription)||`Control #${t.clientControlId}`}),e.jsx("div",{className:"text-gray-500",children:t.reasoning})]}),e.jsxs("span",{className:"text-purple-600 font-bold ml-2",children:[t.relevance,"/10"]})]},t.clientControlId)})})]}),e.jsx(E,{className:"h-[300px] border rounded-md p-2 bg-white",children:e.jsx("div",{className:"space-y-2",children:((z=f==null?void 0:f.map)==null?void 0:z.call(f,t=>{var u,g,N,k;const a=((u=t.clientControl)==null?void 0:u.id)||t.id,n=s.selectedControlIds.includes(a);return e.jsxs("div",{className:`flex items-start gap-3 p-3 rounded border transition-all cursor-pointer ${n?"bg-white border-black shadow-sm":"bg-white border-gray-200 hover:border-gray-400"}`,onClick:()=>{l(n?{...s,selectedControlIds:s.selectedControlIds.filter(C=>C!==a)}:{...s,selectedControlIds:[...s.selectedControlIds,a]})},children:[e.jsx(M,{checked:n,onCheckedChange:()=>{},className:"mt-1 data-[state=checked]:bg-black data-[state=checked]:text-white data-[state=checked]:border-black"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm font-semibold text-black",children:[((g=t.control)==null?void 0:g.controlId)||t.refCode," - ",((N=t.control)==null?void 0:N.name)||t.name||"Unknown Control"]}),e.jsx("div",{className:"text-sm mt-0.5 text-black",children:((k=t.control)==null?void 0:k.description)||t.description})]})]},a)}))||e.jsx("div",{className:"text-sm text-gray-400 p-2",children:"No controls found."})})}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-gray-200 flex items-center justify-between shadow-sm",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-black",children:"Residual Score"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Projected after controls"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`text-2xl font-bold ${J(I(p))}`,children:p}),e.jsx(Y,{score:p})]})]}),e.jsx(we,{inherentScore:h,residualScore:p,appetiteThreshold:10})]})]})]})})}function S({icon:c,title:o,description:d,selected:j,onClick:r}){return e.jsxs("div",{onClick:r,className:`p-4 border rounded-xl cursor-pointer transition-all ${j?"border-blue-600 bg-blue-50":"border-gray-200 hover:bg-gray-50"}`,children:[e.jsx(c,{className:`w-6 h-6 mb-2 ${j?"text-blue-600":"text-gray-500"}`}),e.jsx("h3",{className:"font-semibold",children:o}),e.jsx("p",{className:"text-xs text-gray-500",children:d})]})}function Y({score:c}){const o=I(c),d=ve(o);return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-bold ${d}`,children:o})}export{Ge as H,Pe as R};
