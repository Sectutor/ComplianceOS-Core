import{ab as re,b as le,r as n,t as j,i as x,j as e,c as p,I as Q,C as N,d as y,e as b,m as D,N as ne,O as oe,P as w,Q as f,V as ce,W as o,k as de,D as he,o as me,p as ue,q as xe,s as pe,L as c,E as U,G,H as V,J as q,K as v,w as ge,T as je,F as fe}from"./index-DOc7Nwb7.js";import{T as C}from"./textarea-BtxBxzdY.js";import{A as ve,a as Ne,b as ye,c as be,d as De,e as we,f as Ce,g as Ae}from"./alert-dialog-V7xGXdVc.js";import{B as Pe}from"./Breadcrumb-CRi3LAxS.js";import{P as Ie}from"./PageGuide-CPKKXXS6.js";import{P as Se}from"./plus-BaQ35Jcx.js";import{S as ke}from"./search-CwuIBBPE.js";import{C as M}from"./clipboard-check-CQkJX5J0.js";import{S as Te}from"./square-pen-ClRv15cM.js";import{T as Me}from"./trash-2-CFEfisbM.js";import{C as Re}from"./circle-check-big-BSqJVrgh.js";import{C as Fe}from"./clock-osbacZli.js";import{f as Le}from"./format-H2tx8_vS.js";import"./scroll-area-DPaNxEJD.js";import"./separator-BWuYil37.js";import"./book-open-BffBrdze.js";import"./link-FmUqdGRG.js";import"./info-By5wLOUH.js";import"./en-US-Bfz1jvxT.js";import"./differenceInCalendarDays-nctqlg7V.js";import"./getTimezoneOffsetInMilliseconds-em2BGgN1.js";function as(){var z;const{id:W}=re(),[Ee,J]=le(),g=parseInt(W||"0"),[A,K]=n.useState(""),[X,d]=n.useState(!1),[t,r]=n.useState({title:"",description:"",scope:"",identifiedRisks:"",mitigationMeasures:"",status:"draft",activityId:void 0,assignedTo:void 0}),{data:i,isLoading:Y,refetch:P}=j.dpia.list.useQuery({clientId:g}),{data:l}=j.processingActivities.list.useQuery({clientId:g}),[R,F]=n.useState(!1),[L,E]=n.useState(null),[O,_]=n.useState(null),[Z,I]=n.useState(!1),S=j.dpia.update.useMutation({onSuccess:()=>{x.success("DPIA record updated successfully"),d(!1),T(),P()},onError:s=>{x.error(`Failed to update DPIA: ${s.message}`)}}),k=j.dpia.create.useMutation({onSuccess:()=>{x.success("DPIA record created successfully"),d(!1),T(),P()},onError:s=>{x.error(`Failed to create DPIA: ${s.message}`)}}),$=j.dpia.delete.useMutation({onSuccess:()=>{x.success("DPIA record deleted successfully"),I(!1),_(null),P()},onError:s=>{x.error(`Failed to delete DPIA: ${s.message}`)}}),T=()=>{r({title:"",description:"",scope:"",identifiedRisks:"",mitigationMeasures:"",status:"draft",activityId:void 0,assignedTo:void 0}),F(!1),E(null)},ee=()=>{const s={clientId:g,...t};R&&L?S.mutate({id:L,...s}):k.mutate(s)},B=s=>{F(!0),E(s.id),r({title:s.title,description:s.description,scope:s.scope,identifiedRisks:s.identifiedRisks,mitigationMeasures:s.mitigationMeasures,status:s.status,activityId:s.activityId||void 0,assignedTo:s.assignedTo||void 0}),d(!0)},se=s=>{_(s),I(!0)},te=()=>{O&&$.mutate({id:O})},h=i==null?void 0:i.filter(s=>s.title.toLowerCase().includes(A.toLowerCase())||s.status.toLowerCase().includes(A.toLowerCase())),ie=s=>{switch(s){case"draft":return"bg-gray-100 text-gray-800";case"in_progress":return"bg-blue-100 text-blue-800";case"under_review":return"bg-yellow-100 text-yellow-800";case"completed":return"bg-green-100 text-green-800";default:return"bg-gray-100 text-gray-800"}},ae=s=>{switch(s){case"draft":return e.jsx(fe,{className:"h-4 w-4"});case"in_progress":return e.jsx(Fe,{className:"h-4 w-4"});case"under_review":return e.jsx(je,{className:"h-4 w-4"});case"completed":return e.jsx(Re,{className:"h-4 w-4"});default:return null}};return e.jsxs("div",{className:"space-y-6 flex flex-col h-full",children:[e.jsx(Pe,{items:[{label:"Dashboard",href:"/dashboard"},{label:"Privacy",href:`/clients/${g}/privacy`},{label:"DPIA Manager"}]}),e.jsxs("div",{className:"flex justify-between items-center -mb-2 animate-slide-down",children:[e.jsx(Ie,{title:"DPI Assessment Manager",description:"Conduct and manage Data Protection Impact Assessments (DPIAs).",rationale:"Mandatory under GDPR Art. 35 for high-risk processing activities.",howToUse:[{step:"Screen",description:"Identify high-risk activities needing assessment."},{step:"Assess",description:"Analyze necessity, proportionality, and risks."},{step:"Consult",description:"Seek DPO advice and consult supervisory authority if needed."}]}),e.jsxs(p,{onClick:()=>{T(),d(!0)},children:[e.jsx(Se,{className:"mr-2 h-4 w-4"})," New Assessment"]})]}),e.jsx("div",{className:"flex gap-4",children:e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ke,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(Q,{placeholder:"Search assessments...",value:A,onChange:s=>K(s.target.value),className:"pl-10"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(N,{children:[e.jsx(y,{className:"pb-2",children:e.jsx(b,{className:"text-sm font-medium text-muted-foreground",children:"Total Assessments"})}),e.jsx(D,{children:e.jsx("div",{className:"text-2xl font-bold",children:(i==null?void 0:i.length)||0})})]}),e.jsxs(N,{children:[e.jsx(y,{className:"pb-2",children:e.jsx(b,{className:"text-sm font-medium text-muted-foreground",children:"In Progress"})}),e.jsx(D,{children:e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:(i==null?void 0:i.filter(s=>s.status==="in_progress").length)||0})})]}),e.jsxs(N,{children:[e.jsx(y,{className:"pb-2",children:e.jsx(b,{className:"text-sm font-medium text-muted-foreground",children:"Under Review"})}),e.jsx(D,{children:e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:(i==null?void 0:i.filter(s=>s.status==="under_review").length)||0})})]}),e.jsxs(N,{children:[e.jsx(y,{className:"pb-2",children:e.jsx(b,{className:"text-sm font-medium text-muted-foreground",children:"Completed"})}),e.jsx(D,{children:e.jsx("div",{className:"text-2xl font-bold text-green-600",children:(i==null?void 0:i.filter(s=>s.status==="completed").length)||0})})]})]}),e.jsx("div",{className:"rounded-md border bg-white shadow-sm overflow-hidden",children:e.jsxs(ne,{children:[e.jsx(oe,{className:"bg-slate-50",children:e.jsxs(w,{children:[e.jsx(f,{className:"font-semibold",children:"Title"}),e.jsx(f,{className:"font-semibold",children:"Processing Activity"}),e.jsx(f,{className:"font-semibold",children:"Status"}),e.jsx(f,{className:"font-semibold",children:"Last Updated"}),e.jsx(f,{className:"text-right font-semibold",children:"Actions"})]})}),e.jsx(ce,{children:Y?e.jsx(w,{children:e.jsx(o,{colSpan:5,className:"text-center py-8",children:"Loading assessments..."})}):(h==null?void 0:h.length)===0?e.jsx(w,{children:e.jsxs(o,{colSpan:5,className:"text-center py-12 text-muted-foreground bg-slate-50/50",children:[e.jsx(M,{className:"mx-auto h-12 w-12 text-slate-200 mb-4"}),e.jsx("p",{className:"text-lg font-medium text-slate-400",children:"No DPIA records found"}),e.jsx("p",{className:"max-w-xs mx-auto mt-1",children:"Start a high-risk processing assessment by clicking 'New Assessment'."})]})}):h==null?void 0:h.map(s=>{var m;return e.jsxs(w,{className:"cursor-pointer hover:bg-slate-50 transition-colors",onClick:()=>B(s),children:[e.jsx(o,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded bg-primary/10 flex items-center justify-center",children:e.jsx(M,{className:"h-4 w-4 text-primary"})}),s.title]})}),e.jsx(o,{children:((m=l==null?void 0:l.find(a=>a.id===s.activityId))==null?void 0:m.activityName)||e.jsx("span",{className:"text-muted-foreground italic text-xs",children:"Unlinked"})}),e.jsx(o,{children:e.jsxs(de,{className:`flex items-center gap-1.5 w-fit ${ie(s.status)}`,children:[ae(s.status),s.status.replace("_"," ")]})}),e.jsx(o,{className:"text-muted-foreground text-sm",children:s.updatedAt?Le(new Date(s.updatedAt),"MMM d, yyyy"):"-"}),e.jsx(o,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-1",children:[e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 flex items-center gap-1.5 bg-indigo-50 text-indigo-700 border-indigo-200 hover:bg-indigo-100",onClick:a=>{a.stopPropagation(),J(`/clients/${g}/privacy/dpia/${s.id}/questionnaire`)},children:[e.jsx(M,{className:"h-3.5 w-3.5"}),"Conduct Assessment"]}),e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:a=>{a.stopPropagation(),B(s)},children:e.jsx(Te,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-600 hover:bg-red-50",onClick:a=>{a.stopPropagation(),se(s.id)},children:e.jsx(Me,{className:"h-4 w-4"})})]})})]},s.id)})})]})}),e.jsx(he,{open:X,onOpenChange:d,children:e.jsxs(me,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ue,{children:[e.jsxs(xe,{children:[R?"Edit":"New"," Data Protection Impact Assessment"]}),e.jsx(pe,{children:"Assess high-risk processing activities to ensure compliance with GDPR Article 35."})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsx("div",{className:"grid grid-cols-2 gap-4",children:e.jsxs("div",{className:"space-y-2 col-span-2",children:[e.jsx(c,{htmlFor:"title",children:"Assessment Title *"}),e.jsx(Q,{id:"title",value:t.title,onChange:s=>r({...t,title:s.target.value}),placeholder:"e.g., AI-Driven Customer Profiling DPIA"})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"activity",children:"Processing Activity (ROPA)"}),e.jsxs(U,{value:(z=t.activityId)==null?void 0:z.toString(),onValueChange:s=>{const m=parseInt(s),a=l==null?void 0:l.find(u=>u.id===m);r(a?u=>{var H;return{...u,activityId:m,description:u.description||a.description||"",scope:u.scope||`Purposes: ${((H=a.purposes)==null?void 0:H.join(", "))||"N/A"}. Legal Basis: ${a.legalBasis}`,mitigationMeasures:u.mitigationMeasures||[...a.technicalMeasures||[],...a.organizationalMeasures||[]].join(`
`)||a.securityDescription||""}}:{...t,activityId:m})},children:[e.jsx(G,{children:e.jsx(V,{placeholder:"Link to activity..."})}),e.jsx(q,{children:l==null?void 0:l.map(s=>e.jsx(v,{value:s.id.toString(),children:s.activityName},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"status",children:"Assessment Status"}),e.jsxs(U,{value:t.status,onValueChange:s=>r({...t,status:s}),children:[e.jsx(G,{children:e.jsx(V,{})}),e.jsxs(q,{children:[e.jsx(v,{value:"draft",children:"Draft"}),e.jsx(v,{value:"in_progress",children:"In Progress"}),e.jsx(v,{value:"under_review",children:"Under Review"}),e.jsx(v,{value:"completed",children:"Completed"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"description",children:"Process Description *"}),e.jsx(C,{id:"description",value:t.description,onChange:s=>r({...t,description:s.target.value}),placeholder:"Describe the systematic processing operations...",rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"scope",children:"Scope and Purpose *"}),e.jsx(C,{id:"scope",value:t.scope,onChange:s=>r({...t,scope:s.target.value}),placeholder:"Explain the necessity and proportionality...",rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"risks",children:"Identified Risks to Rights & Freedoms *"}),e.jsx(C,{id:"risks",value:t.identifiedRisks,onChange:s=>r({...t,identifiedRisks:s.target.value}),placeholder:"What are the potential impacts on data subjects?",rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"mitigation",children:"Risk Mitigation Measures *"}),e.jsx(C,{id:"mitigation",value:t.mitigationMeasures,onChange:s=>r({...t,mitigationMeasures:s.target.value}),placeholder:"What technical or organizational measures address these risks?",rows:4})]})]}),e.jsxs(ge,{className:"bg-slate-50 p-4 -mx-6 -mb-6 border-t mt-4 sticky bottom-0 z-10",children:[e.jsx(p,{variant:"ghost",onClick:()=>d(!1),children:"Cancel"}),e.jsx(p,{onClick:ee,disabled:k.isPending||S.isPending||!t.title||!t.description,className:"px-8 shadow-md",children:k.isPending||S.isPending?"Saving...":"Save Assessment"})]})]})}),e.jsx(ve,{open:Z,onOpenChange:I,children:e.jsxs(Ne,{children:[e.jsxs(ye,{children:[e.jsx(be,{children:"Delete DPIA Record?"}),e.jsx(De,{children:"This action cannot be undone. Removing a DPIA record may impact your compliance evidence for high-risk processing activities."})]}),e.jsxs(we,{children:[e.jsx(Ce,{children:"Cancel"}),e.jsx(Ae,{onClick:te,className:"bg-red-600 hover:bg-red-700",children:$.isPending?"Deleting...":"Delete Permanently"})]})]})})]})}export{as as default};
