import{t as A,r as y,i as C,j as e,x as M,C as O,k as P,F as ae,Z as $e,_ as ze,c as S,$ as Be,a1 as D,D as Qe,o as Ve,p as He,q as Ue,s as Ke,L,w as We,d as we,e as Ce,f as Ye,m as U,a3 as Je,aa as Ze,R as he,v as De,E as q,G as ee,H as se,J as te,K as T,T as ge,l as fe,I as Xe,ab as qe,b as es,ao as ss}from"./index-DOc7Nwb7.js";import{o as ts,p as rs,q as as,D as X}from"./DashboardLayout-aHnUqq57.js";import{E as ns}from"./EmailQuestionsDialog-uF8LYkjM.js";import{E as je}from"./enhanced-dialog-CeRPsI16.js";import{S as ls}from"./scroll-area-DPaNxEJD.js";import{A as os,a as is,b as cs,c as ds}from"./accordion-BvRtf4FI.js";import{M as ne}from"./mail-xRDvl6QK.js";import{C as ms}from"./calendar-BlLJlGbj.js";import{E as xs}from"./ellipsis-vertical-DBvk9Y0C.js";import{C as ps}from"./copy-CXVMffmd.js";import{E as us}from"./external-link-C3PXjBR9.js";import{A as Se}from"./archive-D1rnNb-W.js";import{C as K}from"./circle-check-C5kiwRoG.js";import{E as hs}from"./eye-CIq9q9s6.js";import{C as re}from"./clock-osbacZli.js";import{f as gs}from"./format-H2tx8_vS.js";import{T as E}from"./textarea-BtxBxzdY.js";import{T as fs,a as js,b as be,c as ve}from"./tabs-CBDTXbEn.js";import{S as $}from"./sparkles-CoQ80pK2.js";import{C as ke}from"./circle-check-big-BSqJVrgh.js";import{c as H}from"./utils-BC5CVi_C.js";import{B as bs}from"./book-open-BffBrdze.js";import{U as Ne}from"./user-CqRnJLgW.js";import{S as vs,a as Ns}from"./slotNames-XB2IFQPg.js";import{H as ys}from"./hammer-BQtgYNwo.js";import{F as ws}from"./filter-Ceo--4mb.js";import{R as Cs,T as Ss}from"./generateCategoricalChart-KNLgM3hn.js";import{R as ks,P as As,a as Rs}from"./RadarChart-Jh4tpWfl.js";import{P as Is,a as Es}from"./PolarAngleAxis-BO8F-h7c.js";import{A as Ts}from"./arrow-left-CpuUojG-.js";import{D as Ms}from"./download-ByfWg1Mi.js";import"./index--2vFva6Y.js";import"./search-CwuIBBPE.js";import"./clipboard-check-CQkJX5J0.js";import"./send-FW7-3cjH.js";import"./settings-CIu9FFiX.js";import"./en-US-Bfz1jvxT.js";import"./getTimezoneOffsetInMilliseconds-em2BGgN1.js";import"./rocket-C2MuHhsn.js";import"./scale-BCebIfgE.js";import"./layout-grid-CGqkIAJU.js";import"./zap-B01fFOkT.js";import"./star-BTvaCCU4.js";import"./briefcase-BxorFA78.js";import"./target-cfAj3L6j.js";import"./database-Bjtecw5f.js";import"./activity-B1F2IRm3.js";import"./shield-check-ETs8j4-d.js";import"./shield-alert-iAruRy4W.js";import"./brain-C-Zi22rJ.js";import"./link-FmUqdGRG.js";import"./lock-czWF3qbC.js";import"./globe-BMGZmoaJ.js";import"./message-square-5hBo7zY3.js";import"./upload-BBmUECj8.js";import"./differenceInCalendarDays-nctqlg7V.js";import"./isEqual-D_xcZLCn.js";function Ls({status:n,appliedAt:t}){if(!n)return null;let u=n;n==="completed"&&t&&(u="approved"),n==="archived"&&(u="archived");const s={pending:"bg-slate-100 text-slate-600 border-slate-200",viewed:"bg-blue-50 text-blue-600 border-blue-200",completed:"bg-indigo-50 text-indigo-600 border-indigo-200",approved:"bg-green-50 text-green-600 border-green-200",archived:"bg-gray-100 text-gray-500 border-gray-200",expired:"bg-red-50 text-red-600 border-red-200"},x={pending:re,viewed:hs,completed:ne,approved:K,archived:Se,expired:M},g={completed:"Response Received",approved:"Approved",archived:"Archived"},i=x[u]||re;return e.jsxs(P,{variant:"outline",className:`${s[u]||s.pending} gap-1 pl-1.5`,children:[e.jsx(i,{className:"h-3 w-3"}),e.jsx("span",{className:"capitalize",children:g[u]||u})]})}function Os({open:n,onOpenChange:t,assessmentId:u}){const{data:s,isLoading:x}=A.gapQuestionnaire.listByAssessment.useQuery({assessmentId:u},{enabled:n}),[g,i]=y.useState(null),c=A.useContext(),b=A.gapQuestionnaire.approveResponses.useMutation({onSuccess:r=>{C.success(`Successfully approved and applied ${r.count} responses.`),c.gapQuestionnaire.listByAssessment.invalidate({assessmentId:u}),c.gapAnalysis.get.invalidate({id:u}),i(null)},onError:r=>{C.error("Failed to approve responses: "+r.message)}}),d=A.gapQuestionnaire.archiveRequest.useMutation({onSuccess:()=>{C.success("Questionnaire archived."),c.gapQuestionnaire.listByAssessment.invalidate({assessmentId:u})}}),o=r=>{const j=`${window.location.origin}/respond-gap/${r}`;navigator.clipboard.writeText(j),C.success("Link copied to clipboard")},h=r=>{confirm("Are you sure you want to archive this response?")&&d.mutate({requestId:r})},v=r=>{i(r)},k=()=>{g&&b.mutate({requestId:g})};return e.jsxs(e.Fragment,{children:[e.jsx(je,{open:n,onOpenChange:t,title:"Questionnaire History",description:"View sent questionnaires and responses.",size:"lg",children:e.jsx("div",{className:"h-[400px] flex flex-col",children:x?e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(M,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):!s||s.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-muted-foreground gap-2",children:[e.jsx(ne,{className:"h-12 w-12 text-slate-200"}),e.jsx("p",{children:"No questionnaires sent yet."})]}):e.jsx(ls,{className:"flex-1 pr-4",children:e.jsx("div",{className:"space-y-4",children:s.map(r=>{var j;return e.jsxs(O,{className:"overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b bg-slate-50/50 flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold text-sm",children:r.recipientName||r.recipientEmail}),e.jsx(P,{variant:"outline",className:"text-[10px] font-normal",children:r.recipientEmail})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ms,{className:"h-3 w-3"}),gs(new Date(r.createdAt),"MMM d, yyyy")]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{className:"h-3 w-3"}),((j=r.controlIds)==null?void 0:j.length)||0," Controls"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ls,{status:r.status,appliedAt:r.appliedAt}),e.jsxs($e,{children:[e.jsx(ze,{asChild:!0,children:e.jsx(S,{variant:"ghost",size:"icon",className:"h-6 w-6",children:e.jsx(xs,{className:"h-3 w-3"})})}),e.jsxs(Be,{align:"end",children:[e.jsxs(D,{onClick:()=>o(r.token),children:[e.jsx(ps,{className:"h-3.5 w-3.5 mr-2"}),"Copy Link"]}),e.jsx(D,{asChild:!0,children:e.jsxs("a",{href:`/respond-gap/${r.token}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center",children:[e.jsx(us,{className:"h-3.5 w-3.5 mr-2"}),"Open Form"]})}),r.status!=="archived"&&e.jsxs(D,{onClick:()=>h(r.id),className:"text-red-600 focus:text-red-600",children:[e.jsx(Se,{className:"h-3.5 w-3.5 mr-2"}),"Archive"]})]})]})]})]}),r.respondentName&&e.jsxs("div",{className:"px-4 pb-2 text-xs text-muted-foreground italic bg-slate-50/50 border-b flex items-center gap-1.5",children:[e.jsx(K,{className:"h-3 w-3 text-green-600"}),"Response submitted by: ",e.jsx("span",{className:"font-medium text-slate-700",children:r.respondentName})]}),(r.status==="completed"||r.status==="archived")&&r.responses&&e.jsx(os,{type:"single",collapsible:!0,children:e.jsxs(is,{value:"responses",className:"border-b-0",children:[e.jsx(cs,{className:"px-4 py-2 text-xs hover:no-underline hover:bg-slate-50",children:"View Responses"}),e.jsxs(ds,{className:"px-4 pb-4 pt-2 bg-slate-50/30",children:[e.jsx("div",{className:"space-y-3",children:r.responses.map((f,N)=>e.jsxs("div",{className:"text-sm border-l-2 border-slate-200 pl-3 py-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-mono text-xs font-semibold",children:f.controlId||`ID: ${f.controlId}`}),e.jsx(Ps,{status:f.currentStatus})]}),f.notes&&e.jsxs("p",{className:"text-muted-foreground text-xs italic",children:['"',f.notes,'"']})]},N))}),r.appliedAt?e.jsx("div",{className:"mt-3 pt-2 border-t border-slate-200/50",children:e.jsxs("div",{className:"flex items-center gap-1.5 text-green-600 text-xs font-medium justify-end",children:[e.jsx(K,{className:"h-3.5 w-3.5"}),"Approved & Applied"]})}):e.jsx("div",{className:"mt-4 pt-3 border-t border-slate-200 flex justify-end",children:e.jsxs(S,{size:"sm",className:"h-8 text-xs bg-green-600 hover:bg-green-700",onClick:()=>v(r.id),disabled:b.isLoading,children:[b.isLoading&&e.jsx(M,{className:"mr-1.5 h-3 w-3 animate-spin"}),"Approve & Apply Answers"]})})]})]})})]},r.id)})})})})}),e.jsx(je,{open:!!g,onOpenChange:r=>!r&&i(null),title:"Approve Responses?",description:"This will apply the external responses to your Gap Analysis, overwriting any current values for these controls.",size:"sm",footer:e.jsxs(e.Fragment,{children:[e.jsx(S,{variant:"ghost",onClick:()=>i(null),children:"Cancel"}),e.jsxs(S,{className:"bg-green-600 hover:bg-green-700 text-white",onClick:k,disabled:b.isLoading,children:[b.isLoading&&e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}),"Yes, Approve & Apply"]})]}),children:e.jsx("div",{className:"py-2 text-sm text-slate-600",children:e.jsx("p",{children:"Are you sure you want to proceed? This action cannot be easily undone."})})})]})}function Ps({status:n}){const t={implemented:"text-green-600 bg-green-50 border-green-200",in_progress:"text-yellow-600 bg-yellow-50 border-yellow-200",not_implemented:"text-red-600 bg-red-50 border-red-200",not_applicable:"text-slate-500 bg-slate-100 border-slate-200"};return e.jsx(P,{variant:"outline",className:`${t[n]} text-[10px] h-5 px-1.5 border`,children:n.replace("_"," ")})}function Fs({open:n,onOpenChange:t,assessmentId:u,initialData:s,onSave:x}){const[g,i]=y.useState((s==null?void 0:s.executiveSummary)||""),[c,b]=y.useState((s==null?void 0:s.introduction)||"This report details the findings of the Gap Analysis conducted against the standard. The objective was to assess the current implementation status of required controls and identify gaps requiring remediation."),[d,o]=y.useState((s==null?void 0:s.scope)||""),[h,v]=y.useState((s==null?void 0:s.methodology)||""),[k,r]=y.useState((s==null?void 0:s.assumptions)||""),[j,f]=y.useState((s==null?void 0:s.references)||""),[N,F]=y.useState(((s==null?void 0:s.keyRecommendations)||[]).join(`
`)),[G,z]=y.useState(!1),B=A.gapAnalysis.generateReportContent.useMutation(),W=A.gapAnalysis.updateReportDetails.useMutation();y.useEffect(()=>{n&&s&&(s.executiveSummary&&i(s.executiveSummary),s.introduction&&b(s.introduction),s.keyRecommendations&&F(s.keyRecommendations.join(`
`)),s.scope&&o(s.scope),s.methodology&&v(s.methodology),s.assumptions&&r(s.assumptions),s.references&&f(s.references))},[n,s]);const Q=async()=>{try{z(!0);const l=await B.mutateAsync({assessmentId:u});l.executiveSummary&&i(l.executiveSummary),l.keyRecommendations&&F(l.keyRecommendations.join(`
`)),l.scope&&o(l.scope),l.methodology&&v(l.methodology),l.assumptions&&r(l.assumptions),l.references&&f(l.references),C.success("AI Content Generated!")}catch(l){console.error(l),C.error("Failed to generate content")}finally{z(!1)}},_=async()=>{try{await W.mutateAsync({assessmentId:u,executiveSummary:g,introduction:c,scope:d,methodology:h,assumptions:k,references:j,keyRecommendations:N.split(`
`).filter(l=>l.trim().length>0)}),C.success("Report settings saved"),t(!1),x&&x()}catch(l){console.error(l),C.error("Failed to save settings")}};return e.jsx(Qe,{open:n,onOpenChange:t,children:e.jsxs(Ve,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(He,{children:[e.jsx(Ue,{children:"Report Configuration"}),e.jsx(Ke,{children:"Customize the content for the exported Gap Analysis report."})]}),e.jsxs(fs,{defaultValue:"content",className:"w-full",children:[e.jsxs(js,{className:"grid w-full grid-cols-2",children:[e.jsx(be,{value:"content",children:"Report Content"}),e.jsx(be,{value:"preview",children:"Preview Report"})]}),e.jsxs(ve,{value:"content",className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg border flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium flex items-center gap-2",children:[e.jsx($,{className:"w-4 h-4 text-purple-600"})," AI Assistance"]}),e.jsx("p",{className:"text-sm text-slate-600",children:"Auto-generate the executive summary and recommendations based on your assessment data."})]}),e.jsxs(S,{onClick:Q,disabled:G,variant:"secondary",className:"border-purple-200 text-purple-700 hover:bg-purple-50",children:[G?e.jsx(M,{className:"w-4 h-4 animate-spin mr-2"}):e.jsx($,{className:"w-4 h-4 mr-2"}),"Generate Content"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Executive Summary"}),e.jsx(E,{value:g,onChange:l=>i(l.target.value),rows:6,placeholder:"Enter executive summary..."}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"High-level overview of findings."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Introduction"}),e.jsx(E,{value:c,onChange:l=>b(l.target.value),rows:4,placeholder:"Enter report introduction..."}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Sets the context and scope for the report."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Scope"}),e.jsx(E,{value:d,onChange:l=>o(l.target.value),rows:3,placeholder:"Defined ISMS boundaries (e.g. Departments, Locations)..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Methodology"}),e.jsx(E,{value:h,onChange:l=>v(l.target.value),rows:3,placeholder:"Data collection methods, scale, tools..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Assumptions & Limitations"}),e.jsx(E,{value:k,onChange:l=>r(l.target.value),rows:3,placeholder:"E.g. Based on provided evidence; excludes out-of-scope areas..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"References"}),e.jsx(E,{value:j,onChange:l=>f(l.target.value),rows:3,placeholder:"ISO 27001:2022, Internal Policies..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Key Recommendations"}),e.jsx(E,{value:N,onChange:l=>F(l.target.value),rows:6,placeholder:"Enter recommendations (one per line)..."}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Strategic actions to take (one per line)."})]})]}),e.jsx(ve,{value:"preview",className:"mt-4",children:e.jsxs("div",{className:"bg-white border rounded-lg p-8 shadow-sm h-[600px] overflow-y-auto font-serif",children:[e.jsx("h1",{className:"text-3xl font-bold mb-8 text-center text-slate-900",children:"Gap Analysis Report"}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-4 text-slate-900 border-b pb-2",children:"1. Executive Summary"}),e.jsx("div",{className:"whitespace-pre-wrap text-slate-800 leading-relaxed text-lg",children:g||e.jsx("span",{className:"text-slate-400 italic",children:"No executive summary provided."})})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-4 text-slate-900 border-b pb-2",children:"2. Introduction"}),e.jsx("div",{className:"whitespace-pre-wrap text-slate-800 leading-relaxed text-lg",children:c||e.jsx("span",{className:"text-slate-400 italic",children:"No introduction content provided."})})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-4 text-slate-900 border-b pb-2",children:"3. Scope"}),e.jsx("div",{className:"whitespace-pre-wrap text-slate-800 leading-relaxed text-lg",children:d||e.jsx("span",{className:"text-slate-400 italic",children:"No scope provided."})})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-4 text-slate-900 border-b pb-2",children:"4. Methodology"}),e.jsx("div",{className:"whitespace-pre-wrap text-slate-800 leading-relaxed text-lg",children:h||e.jsx("span",{className:"text-slate-400 italic",children:"No methodology provided."})})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-4 text-slate-900 border-b pb-2",children:"5. Assumptions & Limitations"}),e.jsx("div",{className:"whitespace-pre-wrap text-slate-800 leading-relaxed text-lg",children:k||e.jsx("span",{className:"text-slate-400 italic",children:"No assumptions provided."})})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-4 text-slate-900 border-b pb-2",children:"6. References"}),e.jsx("div",{className:"whitespace-pre-wrap text-slate-800 leading-relaxed text-lg",children:j||e.jsx("span",{className:"text-slate-400 italic",children:"No references provided."})})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold mb-4 text-slate-900 border-b pb-2",children:"7. Strategic Recommendations"}),N.trim()?e.jsx("ul",{className:"list-disc pl-5 space-y-2 text-lg text-slate-800",children:N.split(`
`).filter(l=>l.trim()).map((l,w)=>e.jsx("li",{children:l},w))}):e.jsx("span",{className:"text-slate-400 italic",children:"No recommendations provided."})]})]})})]}),e.jsxs(We,{children:[e.jsx(S,{variant:"outline",onClick:()=>t(!1),children:"Cancel"}),e.jsxs(S,{onClick:_,className:"gap-2",children:[e.jsx(ke,{className:"w-4 h-4"})," Save Configuration"]})]})]})})}function Gs({controlId:n,controlName:t,category:u,framework:s}){const[x,g]=y.useState(null),{data:i=[],isLoading:c}=A.remediationPlaybooks.getSuggestions.useQuery({controlId:n,controlName:t,category:u,framework:s},{staleTime:6e4});if(c||i.length===0)return null;const b=d=>{switch(d){case"critical":return"bg-red-600";case"high":return"bg-orange-500";case"medium":return"bg-yellow-500";default:return"bg-blue-500"}};return e.jsxs(O,{className:"border-purple-200 bg-purple-50/30",children:[e.jsxs(we,{className:"pb-2",children:[e.jsxs(Ce,{className:"text-sm flex items-center gap-2 text-purple-700",children:[e.jsx(bs,{className:"h-4 w-4"}),"Remediation Playbooks"]}),e.jsxs(Ye,{className:"text-xs",children:[i.length," playbook",i.length>1?"s":""," available for this gap"]})]}),e.jsx(U,{className:"space-y-2",children:i.slice(0,3).map(d=>e.jsxs(ts,{open:x===d.id,onOpenChange:o=>g(o?d.id:null),children:[e.jsx(rs,{asChild:!0,children:e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-md bg-white border cursor-pointer hover:bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[x===d.id?e.jsx(Je,{className:"h-4 w-4 text-muted-foreground"}):e.jsx(Ze,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium text-sm",children:d.title}),e.jsx(P,{className:`${b(d.severity)} text-white text-[10px]`,children:d.severity})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(re,{className:"h-3 w-3"}),d.estimatedEffort]})]})}),e.jsx(as,{children:e.jsxs("div",{className:"mt-2 p-3 bg-white rounded-md border space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider",children:"Steps"}),(d.steps||[]).map((o,h)=>e.jsxs("div",{className:"flex items-start gap-2 text-sm",children:[e.jsx("div",{className:"flex-shrink-0 w-5 h-5 rounded-full bg-purple-100 text-purple-700 flex items-center justify-center text-xs font-medium",children:o.order}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:o.title}),e.jsx("div",{className:"text-xs text-muted-foreground",children:o.description}),o.owner&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground mt-0.5",children:[e.jsx(Ne,{className:"h-3 w-3"})," ",o.owner]}),o.checklist&&o.checklist.length>0&&e.jsx("ul",{className:"mt-1 space-y-0.5",children:o.checklist.map((v,k)=>e.jsxs("li",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(K,{className:"h-3 w-3 text-green-500"})," ",v]},k))})]})]},h))]}),d.ownerTemplate&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1",children:"Recommended Owner"}),e.jsxs("div",{className:"text-xs bg-muted/50 p-2 rounded flex items-center gap-1.5",children:[e.jsx(Ne,{className:"h-3.5 w-3.5 text-purple-600"}),d.ownerTemplate]})]}),d.policyLanguage&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1",children:"Sample Policy Language"}),e.jsxs("div",{className:"text-xs bg-blue-50 p-2 rounded border border-blue-100 flex items-start gap-1.5",children:[e.jsx(ae,{className:"h-3.5 w-3.5 text-blue-600 mt-0.5"}),e.jsx("span",{className:"italic",children:d.policyLanguage})]})]}),e.jsx("div",{className:"flex justify-end pt-1",children:e.jsxs(S,{size:"sm",variant:"outline",className:"text-xs gap-1 text-purple-700 border-purple-200 hover:bg-purple-50",children:[e.jsx($,{className:"h-3 w-3"}),"Start Remediation"]})})]})})]},d.id))})]})}function _s({control:n,response:t,selected:u,onSelect:s,onUpdate:x,onRaiseRisk:g}){var f;const i=t==null?void 0:t.currentStatus,[c,b]=he.useState(!1),[d,o]=he.useState(!1),h=A.governance.create.useMutation(),v=async()=>{try{await h.mutateAsync({clientId:3,title:`Remediate Gap: ${n.controlId} - ${n.name}`,description:(t==null?void 0:t.notes)||`Implement control ${n.controlId}.`,priority:((t==null?void 0:t.priorityScore)||0)>80?"critical":((t==null?void 0:t.priorityScore)||0)>50?"high":"medium",type:"control_implementation",entityType:"control",entityId:n.id}),C.success("Task created in Governance Workbench"),b(!0)}catch(N){console.error(N),C.error("Failed to create task")}},k=()=>{g(),o(!0)},r=t==null?void 0:t.targetStatus,j=r==="required"&&i!=="implemented";return e.jsx(O,{className:`transition-all ${j?"border-orange-200 bg-orange-50/10":""}`,children:e.jsxs(U,{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-6",children:[e.jsxs("div",{className:"col-span-12 lg:col-span-5 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(De,{checked:u,onCheckedChange:N=>s(N)}),e.jsx(P,{variant:"secondary",className:"font-mono text-xs",children:n.controlId}),n.domain&&e.jsx("span",{className:"text-xs text-muted-foreground",children:n.domain})]}),e.jsx("h3",{className:"font-semibold",children:n.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:n.description}),n.implementationGuidance&&e.jsxs("div",{className:"mt-3 p-3 bg-blue-50/50 border border-blue-100 rounded-lg",children:[e.jsx("p",{className:"text-[10px] font-bold text-blue-600 uppercase tracking-wider mb-1",children:(f=n.framework)!=null&&f.includes("800-171")?"Assessment Objectives (800-171A)":"Implementation Guidance"}),e.jsx("p",{className:"text-xs text-slate-600 leading-relaxed whitespace-pre-wrap",children:n.implementationGuidance})]})]}),e.jsxs("div",{className:"col-span-12 lg:col-span-7 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Current State"}),e.jsxs(q,{value:i||"",onValueChange:N=>x("currentStatus",N),children:[e.jsx(ee,{className:H("transition-all font-medium",i==="implemented"&&"bg-[var(--success-bg)] text-[var(--success-foreground)] border-[var(--success-foreground)]/20",i==="partially_implemented"&&"bg-[var(--evaluation-bg)] text-[var(--evaluation-foreground)] border-[var(--evaluation-foreground)]/20",i==="not_implemented"&&"bg-[var(--error-bg)] text-[var(--error-foreground)] border-[var(--error-foreground)]/20",i==="not_applicable"&&"bg-[var(--info-bg)] text-[var(--info-foreground)] border-[var(--info-foreground)]/20"),children:e.jsx(se,{placeholder:"Select Status"})}),e.jsxs(te,{children:[e.jsx(T,{value:"not_implemented",children:"Not Implemented"}),e.jsx(T,{value:"partially_implemented",children:"Partially Implemented"}),e.jsx(T,{value:"implemented",children:"Implemented"}),e.jsx(T,{value:"not_applicable",children:"Not Applicable"})]})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Target State"}),e.jsxs(q,{value:r||"",onValueChange:N=>x("targetStatus",N),children:[e.jsx(ee,{className:H("transition-all font-medium",r==="required"&&"bg-[var(--info-bg)] text-[var(--info-foreground)] border-[var(--info-foreground)]/20",r==="not_required"&&"bg-slate-100 text-slate-600 border-slate-200"),children:e.jsx(se,{placeholder:"Select Target"})}),e.jsxs(te,{children:[e.jsx(T,{value:"required",children:"Required"}),e.jsx(T,{value:"not_required",children:"Not Required"})]})]})]})]}),e.jsxs("div",{className:"space-y-1.5 relative",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Notes / Remediation"}),e.jsx("div",{className:"flex gap-2",children:e.jsx(vs,{name:Ns.GAP_ANALYSIS_AI_BUTTON,props:{clientId:3,controlId:n.id,controlName:n.name,description:n.description,framework:n.framework,currentStatus:i,notes:t==null?void 0:t.notes,onUpdate:N=>x("notes",N)}})})]}),e.jsx(E,{placeholder:"Add implementation notes, evidence links, or questions...",className:"h-[108px] resize-none",value:(t==null?void 0:t.notes)||"",onChange:N=>x("notes",N.target.value)})]})]})]}),j&&e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3 text-sm text-orange-800 bg-orange-50/80 p-3 rounded-xl border border-orange-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("div",{className:"bg-orange-200/50 p-1.5 rounded-lg",children:e.jsx(ge,{className:"w-4 h-4 text-orange-600"})}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"font-bold text-orange-900 block sm:inline mr-2",children:"Gap Identified:"}),e.jsx("span",{className:"text-orange-700",children:"Current state does not meet target requirement."})]}),(t==null?void 0:t.priorityScore)!==null&&(t==null?void 0:t.priorityScore)!==void 0&&e.jsxs("div",{className:"flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-white border border-orange-200 shadow-sm",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${t.priorityScore>=80?"bg-red-500":t.priorityScore>=60?"bg-orange-500":t.priorityScore>=40?"bg-yellow-500":"bg-green-500"}`}),e.jsxs("span",{className:"text-[11px] font-bold text-slate-700",children:["Priority Score: ",t.priorityScore]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(S,{size:"sm",variant:"outline",disabled:c,className:H("h-9 px-4 font-bold transition-all shadow-sm",c?"border-green-200 bg-green-50 text-green-700":"border-blue-200 bg-white hover:bg-blue-600 hover:text-white hover:border-blue-600 text-blue-700"),onClick:()=>v(),children:[c?e.jsx(fe,{className:"w-3.5 h-3.5 mr-2"}):e.jsx(ys,{className:"w-3.5 h-3.5 mr-2"}),c?"Task Created":"Create Task"]}),e.jsxs(S,{size:"sm",variant:"outline",disabled:d,className:H("h-9 px-4 font-bold transition-all shadow-sm",d?"border-green-200 bg-green-50 text-green-700":"border-orange-200 bg-white hover:bg-orange-600 hover:text-white hover:border-orange-600 text-orange-700"),onClick:k,children:[d?e.jsx(fe,{className:"w-3.5 h-3.5 mr-2"}):e.jsx(ge,{className:"w-3.5 h-3.5 mr-2"}),d?"Risk Raised":"Raise Risk"]})]})]}),(t==null?void 0:t.priorityReason)&&e.jsxs("div",{className:"text-xs text-purple-700 bg-purple-50 p-2 rounded border border-purple-200 flex items-start gap-2",children:[e.jsx($,{className:"w-3.5 h-3.5 mt-0.5 shrink-0"}),e.jsxs("span",{children:[e.jsx("strong",{children:"AI Reason:"})," ",t.priorityReason]})]}),e.jsx(Gs,{controlId:n.controlId,controlName:n.name,category:n.domain,framework:n.framework})]})]})})}function $s({filterDomain:n,setFilterDomain:t,searchTerm:u,setSearchTerm:s,domains:x,totalCount:g}){return e.jsxs("div",{className:"flex flex-col md:flex-row items-center gap-4 bg-white/50 p-4 rounded-xl border shadow-sm backdrop-blur-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 w-full",children:[e.jsx("div",{className:"bg-slate-100 p-2 rounded-lg",children:e.jsx(ws,{className:"w-4 h-4 text-slate-600"})}),e.jsxs(q,{value:n,onValueChange:t,children:[e.jsx(ee,{className:"w-full md:w-[220px] bg-white",children:e.jsx(se,{placeholder:"All Domains"})}),e.jsxs(te,{children:[e.jsx(T,{value:"All",children:"All Domains"}),x.map(i=>e.jsx(T,{value:i,children:i},i))]})]}),e.jsx("div",{className:"relative flex-1 max-w-sm",children:e.jsx(Xe,{placeholder:"Search controls or descriptions...",className:"bg-white pl-3 text-sm",value:u,onChange:i=>s(i.target.value)})})]}),e.jsxs("div",{className:"text-sm font-medium text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full border border-slate-200",children:["Found ",e.jsx("span",{className:"text-slate-900 font-bold",children:g})," controls"]})]})}const ye={fully_implemented:100,implemented:100,partially_implemented:60,in_progress:40,planned:20,not_implemented:0,not_applicable:100},zs={"NIST CSF":["GOVERN","IDENTIFY","PROTECT","DETECT","RESPOND","RECOVER"],"NIST CSF 2.0":["GOVERN","IDENTIFY","PROTECT","DETECT","RESPOND","RECOVER"],"ISO 27001":["Context","Leadership","Planning","Support","Operation","Performance","Improvement"],"ISO 27001:2022":["Context","Leadership","Planning","Support","Operation","Performance","Improvement"],"SOC 2":["Security","Availability","Processing Integrity","Confidentiality","Privacy"]};function Bs({controls:n,responses:t,framework:u}){const s=c=>t.find(b=>b.controlId===c),g=(()=>{const c={};n.forEach(o=>{const h=o.category||"Other";c[h]||(c[h]=[]),c[h].push(o)});const b=zs[u]||[],d=[];return b.forEach(o=>{const h=c[o];if(h&&h.length>0){const v=h.reduce((k,r)=>{const j=s(r.controlId),f=(j==null?void 0:j.currentStatus)||"not_implemented";return k+(ye[f]??0)},0);d.push({domain:o.length>10?o.substring(0,10)+"...":o,score:Math.round(v/h.length),fullMark:100}),delete c[o]}}),Object.keys(c).sort().forEach(o=>{const h=c[o];if(h.length>0){const v=h.reduce((k,r)=>{const j=s(r.controlId),f=(j==null?void 0:j.currentStatus)||"not_implemented";return k+(ye[f]??0)},0);d.push({domain:o.length>10?o.substring(0,10)+"...":o,score:Math.round(v/h.length),fullMark:100})}}),d})(),i=g.length>0?Math.round(g.reduce((c,b)=>c+b.score,0)/g.length):0;return g.length===0?e.jsx(O,{className:"lg:col-span-5 bg-white border-slate-200 shadow-sm",children:e.jsx(U,{className:"p-8 flex items-center justify-center text-muted-foreground",children:"No domain data available"})}):e.jsxs(O,{className:"lg:col-span-5 bg-white border-slate-200 shadow-sm",children:[e.jsx(we,{className:"pb-0",children:e.jsxs(Ce,{className:"text-sm font-bold text-slate-700 flex items-center justify-between",children:[e.jsx("span",{children:"Compliance by Domain"}),e.jsxs("span",{className:"text-2xl font-black text-slate-900",children:[i,"%"]})]})}),e.jsx(U,{className:"p-4",children:e.jsx(Cs,{width:"100%",height:220,children:e.jsxs(ks,{data:g,margin:{top:10,right:30,bottom:10,left:30},children:[e.jsx(As,{stroke:"#e2e8f0"}),e.jsx(Is,{dataKey:"domain",tick:{fill:"#64748b",fontSize:10,fontWeight:600}}),e.jsx(Es,{angle:90,domain:[0,100],tick:{fill:"#94a3b8",fontSize:9},tickCount:5}),e.jsx(Rs,{name:"Current",dataKey:"score",stroke:"#0ea5e9",fill:"#0ea5e9",fillOpacity:.3,strokeWidth:2}),e.jsx(Ss,{formatter:c=>[`${c}%`,"Compliance"],contentStyle:{backgroundColor:"white",border:"1px solid #e2e8f0",borderRadius:"8px",fontSize:"12px"}})]})})})]})}function Kt(){const n=qe(),[t,u]=es(),s=Number(n.id),x=Number(n.assessmentId),{data:g,isLoading:i,refetch:c}=A.gapAnalysis.get.useQuery({id:x}),{data:b,isLoading:d}=A.controls.list.useQuery({}),o=A.gapAnalysis.updateResponse.useMutation(),h=A.gapAnalysis.complete.useMutation(),[v,k]=y.useState("All"),[r,j]=y.useState(""),[f,N]=y.useState([]),[F,G]=y.useState(!1),[z,B]=y.useState(!1),[W,Q]=y.useState(!1),_=a=>a&&typeof a=="object"&&"json"in a&&(Array.isArray(a.json)||typeof a.json=="object")?a.json:a,l=_(g),w=l==null?void 0:l.assessment,le=(l==null?void 0:l.responses)||[],oe=_(b),Ae=Array.isArray(oe)?oe:[],ie=a=>le.find(m=>m.controlId===a),ce=Ae.filter(a=>{if(w!=null&&w.framework&&a.framework){const m=w.framework.toLowerCase(),p=a.framework.toLowerCase();if(m.includes("nist csf")||m.includes("cybersecurity framework")){if(!p.includes("nist csf")&&!p.includes("cybersecurity framework"))return!1}else if(m.includes("800-53")||m.includes("800-171")){if(p.includes("nist csf")||!p.includes(m)&&!m.includes(p))return!1}else if(m.includes("iso")&&m.includes("27001")){if(!p.includes("iso")||!p.includes("27001"))return!1}else if(!p.includes(m)&&!m.includes(p))return!1}return!0}),Y=Array.from(new Set(ce.map(a=>a.category).filter(Boolean))).sort(),R=ce.filter(a=>{var m;if(v!=="All"&&a.category!==v)return!1;if(r){const p=r.toLowerCase();return a.controlId&&a.controlId.toLowerCase().includes(p)||a.name.toLowerCase().includes(p)||((m=a.description)==null?void 0:m.toLowerCase().includes(p))}return!0})||[];y.useEffect(()=>{v!=="All"&&!Y.includes(v)&&k("All")},[Y.join(","),v]);const de=R.length,Re=R.filter(a=>{const m=ie(a.controlId);return m==null?void 0:m.currentStatus}).length,Ie=de>0?Re/de*100:0,Ee=async(a,m,p)=>{try{await o.mutateAsync({assessmentId:x,controlId:a,[m]:p}),c()}catch{C.error("Failed to save changes")}},Te=async()=>{try{await h.mutateAsync({id:x}),C.success("Assessment completed!"),c()}catch{C.error("Failed to complete assessment")}},Me=A.risks.createRiskAssessment.useMutation();A.actions.create.useMutation();const Le=A.gapAnalysis.exportReport.useMutation(),[me,xe]=y.useState(!1),[pe,ue]=y.useState(!1),Oe=A.gapAnalysis.calculatePriorities.useMutation(),Pe=async()=>{try{ue(!0),await Oe.mutateAsync({assessmentId:x}),C.success("Gaps prioritized! Refresh to see scores."),window.location.reload()}catch(a){console.error(a),C.error("Failed to calculate priorities")}finally{ue(!1)}},Fe=async()=>{try{xe(!0);const a=await Le.mutateAsync({assessmentId:x}),m=_(a),p=atob(m.base64),I=new Array(p.length);for(let V=0;V<p.length;V++)I[V]=p.charCodeAt(V);const J=new Uint8Array(I),_e=new Blob([J],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}),Z=document.createElement("a");Z.href=window.URL.createObjectURL(_e),Z.download=m.filename,Z.click(),C.success("Report downloaded successfully")}catch(a){console.error(a),C.error("Failed to generate report")}finally{xe(!1)}},Ge=async(a,m)=>{try{await Me.mutateAsync({clientId:s,assessmentId:`RISK-${a.controlId}-${Date.now()}`,title:`Gap: ${a.controlId} - ${a.name}`,gapResponseId:m==null?void 0:m.id,vulnerabilityDescription:"Control Not Implemented",threatDescription:"Potential exploitation due to missing control",impact:3,likelihood:3,status:"draft",affectedAssets:[],existingControls:"None"}),C.success("Risk raised successfully. View in Risk Register.")}catch(p){console.error(p),C.error("Failed to raise risk")}};return i||d?e.jsx(X,{children:e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx(M,{className:"w-8 h-8 animate-spin text-primary"})})}):w?e.jsxs(X,{children:[e.jsxs("div",{className:"p-8 space-y-6 max-w-7xl mx-auto",children:[e.jsxs("div",{className:"space-y-4 mb-8",children:[e.jsxs(S,{variant:"ghost",className:"w-fit pl-0 text-slate-500 hover:text-slate-900 transition-colors",onClick:()=>u(`/clients/${s}/gap-analysis`),children:[e.jsx(Ts,{className:"w-4 h-4 mr-2"})," Back to Gap Assessments"]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-6",children:[e.jsx(Bs,{controls:R,responses:le,framework:w.framework||""}),e.jsx(O,{className:"lg:col-span-2 border-slate-200 shadow-sm bg-gradient-to-b from-teal-50/50 to-white flex flex-col p-4",children:e.jsxs(S,{variant:"outline",onClick:Fe,disabled:me,className:"flex-1 flex flex-col items-center justify-center gap-4 bg-white border-teal-200 text-teal-700 hover:bg-teal-600 hover:text-white hover:border-teal-600 transition-all shadow-sm group py-8",children:[e.jsx("div",{className:"p-4 rounded-full bg-teal-50 group-hover:bg-white/20 transition-colors",children:me?e.jsx(M,{className:"w-8 h-8 animate-spin"}):e.jsx(Ms,{className:"w-8 h-8"})}),e.jsx("span",{className:"font-black uppercase text-xs tracking-widest px-2 text-center",children:"Export Report"})]})}),e.jsxs(O,{className:"lg:col-span-5 border-slate-200 shadow-sm p-6 flex flex-col justify-between bg-slate-50/20",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs(S,{variant:"outline",onClick:()=>Q(!0),className:"flex-1 h-12 bg-white border-slate-200 shadow-sm hover:shadow-md transition-all font-bold text-slate-700 gap-2",children:[e.jsx(ae,{className:"w-4 h-4 text-slate-400"}),"Report Configuration"]}),e.jsxs(S,{variant:"outline",onClick:()=>G(!0),disabled:f.length===0,className:"flex-1 h-12 bg-blue-50/50 border-blue-100 text-blue-700 hover:bg-blue-600 hover:text-white transition-all font-bold gap-2",children:[e.jsx(ne,{className:"w-4 h-4"}),"Email Questions",f.length>0&&e.jsx(P,{className:"ml-1 bg-blue-600 h-5 w-5 p-0 flex items-center justify-center rounded-full text-[10px]",children:f.length})]}),e.jsx(S,{variant:"ghost",size:"icon",onClick:()=>B(!0),className:"h-12 w-12 border border-slate-200 bg-white",children:e.jsx(ss,{className:"w-4 h-4 text-slate-500"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs(S,{onClick:Pe,disabled:pe,className:"h-12 bg-gradient-to-r from-indigo-600 to-purple-600 text-white border-none font-bold shadow-lg shadow-indigo-100 hover:scale-[1.02] active:scale-[0.98] transition-all",children:[pe?e.jsx(M,{className:"w-4 h-4 animate-spin mr-2"}):e.jsx($,{className:"w-4 h-4 mr-2"}),"AI Prioritize"]}),w.status!=="completed"&&e.jsxs(S,{onClick:Te,disabled:Ie<100,className:"h-12 bg-gradient-to-r from-emerald-600 to-teal-600 text-white border-none font-bold shadow-lg shadow-emerald-100 hover:scale-[1.02] active:scale-[0.98] transition-all",children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"Complete"]})]})]}),e.jsxs("div",{className:"mt-4 p-3 bg-white border border-slate-100 rounded-xl",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 truncate",children:w.name}),e.jsx("p",{className:"text-[10px] text-slate-500 mt-0.5",children:"Focus on high-impact gaps to improve compliance posture."})]})]})]})]}),e.jsx($s,{filterDomain:v,setFilterDomain:k,searchTerm:r,setSearchTerm:j,domains:Y,totalCount:R.length}),e.jsx("div",{className:"space-y-4",children:R.map(a=>{const m=ie(a.controlId);return e.jsx(_s,{control:a,response:m,selected:f.includes(a.id),onSelect:p=>{N(I=>p?[...I,a.id]:I.filter(J=>J!==a.id))},onUpdate:(p,I)=>Ee(a.controlId,p,I),onRaiseRisk:()=>Ge(a,m)},a.id)})})]}),e.jsx(ns,{open:F,onOpenChange:G,assessmentId:x,selectedControlIds:f,controls:(R==null?void 0:R.map(a=>({id:a.id,controlId:a.controlId,name:a.name})))||[]}),e.jsx(Fs,{open:W,onOpenChange:Q,assessmentId:x,initialData:{executiveSummary:w==null?void 0:w.executiveSummary,introduction:w==null?void 0:w.introduction,keyRecommendations:w==null?void 0:w.keyRecommendations},onSave:c}),e.jsx(Os,{open:z,onOpenChange:B,assessmentId:x})]}):e.jsx(X,{children:e.jsx("div",{children:"Assessment not found"})})}export{Kt as default};
