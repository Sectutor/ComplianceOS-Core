import{r as x,j as e,c as g,l as K,t as u,C as F,d as G,e as H,T as we,f as z,m as Q,x as W,k as X,i as p,b as Re,au as Ie,ac as De,S as _,F as te,L as m,I as ae,E as y,G as N,H as k,J as w,K as h}from"./index-DOc7Nwb7.js";import{T as J}from"./textarea-BtxBxzdY.js";import{T as Ae,a as Ce,b as Se,c as B}from"./tabs-CBDTXbEn.js";import{c as ie}from"./riskCalculations-D9ghekGI.js";import{C as re,R as Te,a as Ee}from"./RiskTreatmentCard-70xqcJLZ.js";import{S as ne}from"./separator-BWuYil37.js";import{P as Me,g as Pe,h as Oe,a as Le,b as Ve,c as $e,d as Fe,e as Ge,f as He,D as ze}from"./DashboardLayout-aHnUqq57.js";import{P as Qe}from"./PageGuide-CPKKXXS6.js";import{c as le}from"./utils-BC5CVi_C.js";import{C as Ue}from"./chevrons-up-down-COXP-OtJ.js";import{P as Z}from"./plus-BaQ35Jcx.js";import{S as Ye}from"./search-CwuIBBPE.js";import{A as _e}from"./arrow-right-M96iV-v9.js";import{S as ce,a as oe}from"./slotNames-XB2IFQPg.js";import{A as Be}from"./arrow-left-CpuUojG-.js";import{S as Ke}from"./save-CvVmWchr.js";import{A as We}from"./activity-B1F2IRm3.js";import{C as de}from"./calendar-BlLJlGbj.js";import"./circle-check-big-BSqJVrgh.js";import"./ban-TJUJ_p7U.js";import"./sparkles-CoQ80pK2.js";import"./globe-BMGZmoaJ.js";import"./user-CqRnJLgW.js";import"./dollar-sign-M9UCfTjq.js";import"./clock-osbacZli.js";import"./square-pen-ClRv15cM.js";import"./trash-2-CFEfisbM.js";import"./index--2vFva6Y.js";import"./filter-Ceo--4mb.js";import"./clipboard-check-CQkJX5J0.js";import"./send-FW7-3cjH.js";import"./scroll-area-DPaNxEJD.js";import"./settings-CIu9FFiX.js";import"./circle-check-C5kiwRoG.js";import"./en-US-Bfz1jvxT.js";import"./getTimezoneOffsetInMilliseconds-em2BGgN1.js";import"./rocket-C2MuHhsn.js";import"./scale-BCebIfgE.js";import"./layout-grid-CGqkIAJU.js";import"./book-open-BffBrdze.js";import"./zap-B01fFOkT.js";import"./star-BTvaCCU4.js";import"./briefcase-BxorFA78.js";import"./target-cfAj3L6j.js";import"./database-Bjtecw5f.js";import"./shield-check-ETs8j4-d.js";import"./shield-alert-iAruRy4W.js";import"./brain-C-Zi22rJ.js";import"./link-FmUqdGRG.js";import"./lock-czWF3qbC.js";import"./message-square-5hBo7zY3.js";import"./upload-BBmUECj8.js";import"./info-By5wLOUH.js";function me({items:C,value:f,onChange:S,onCreate:c,placeholder:r="Select item...",searchPlaceholder:d="Search...",className:T,isLoading:E}){const[R,j]=x.useState(!1),[v,D]=x.useState(""),I=C.find(i=>i.value===f),M=async()=>{c&&v&&(await c(v),j(!1),D(""))};return e.jsxs(Me,{open:R,onOpenChange:j,children:[e.jsx(Pe,{asChild:!0,children:e.jsxs(g,{variant:"outline",role:"combobox","aria-expanded":R,className:le("w-full justify-between h-auto min-h-[2.5rem] py-2",T),children:[I?e.jsxs("div",{className:"flex flex-col items-start text-left",children:[e.jsx("span",{className:"font-medium",children:I.label}),I.description&&e.jsx("span",{className:"text-xs text-muted-foreground truncate max-w-[300px]",children:I.description})]}):e.jsx("span",{className:"text-muted-foreground",children:r}),e.jsx(Ue,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(Oe,{className:"w-[--radix-popover-trigger-width] p-0",children:e.jsxs(Le,{children:[e.jsx(Ve,{placeholder:d,value:v,onValueChange:D}),e.jsxs($e,{children:[e.jsxs(Fe,{className:"py-2 px-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"No results found."}),c&&v&&e.jsxs(g,{variant:"secondary",size:"sm",className:"w-full justify-start",onClick:M,children:[e.jsx(Z,{className:"mr-2 h-4 w-4"}),'Create "',v,'"']})]}),e.jsx(Ge,{children:C.map(i=>e.jsxs(He,{value:i.label,keywords:[i.label,...i.description?[i.description]:[]],onSelect:()=>{S(i.value===f?null:i.value),setTimeout(()=>j(!1),0)},className:"cursor-pointer",children:[e.jsx(K,{className:le("mr-2 h-4 w-4",f===i.value?"opacity-100":"opacity-0")}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:i.label}),i.description&&e.jsx("span",{className:"text-xs text-muted-foreground",children:i.description})]})]},i.value))})]})]})})]})}function qe({clientId:C,threat:f,vulnerability:S,onControlAdopted:c}){const[r,d]=x.useState(null),[T,E]=x.useState(!1),[R,j]=x.useState(null),v=u.risks.analyzeGaps.useMutation(),D=u.clientControls.create.useMutation(),I=async()=>{if(!f||!S){p.error("Please enter Threat and Vulnerability first.");return}E(!0);try{const i=await v.mutateAsync({clientId:C,threat:f,vulnerability:S});d(i.gaps)}catch(i){console.error("Analysis failed",i),p.error("Failed to perform gap analysis.")}finally{E(!1)}},M=async i=>{j(i.controlId);try{await D.mutateAsync({clientId:C,controlId:i.controlId,status:"not_implemented",customDescription:i.details.name}),p.success(`Adopted control: ${i.details.code}`),d(P=>P?P.filter(A=>A.controlId!==i.controlId):null),c&&c()}catch(P){console.error("Adoption failed",P),p.error("Failed to adopt control.")}finally{j(null)}};return e.jsxs(F,{className:"border-orange-200 bg-orange-50/30",children:[e.jsxs(G,{className:"pb-3",children:[e.jsxs(H,{className:"text-base flex items-center text-orange-800",children:[e.jsx(we,{className:"w-4 h-4 mr-2 text-orange-600"}),"Gap Analysis: Missing Controls"]}),e.jsx(z,{children:"Identify critical controls you are missing that would mitigate this risk."})]}),e.jsxs(Q,{className:"space-y-4",children:[!r&&!T&&e.jsxs(g,{variant:"outline",onClick:I,className:"w-full border-orange-300 text-orange-700 hover:bg-orange-100 hover:border-orange-400",disabled:!f||!S,children:[e.jsx(Ye,{className:"w-4 h-4 mr-2"}),"Run Gap Analysis"]}),T&&e.jsxs("div",{className:"flex flex-col items-center justify-center p-6 space-y-2",children:[e.jsx(W,{className:"w-6 h-6 animate-spin text-orange-600"}),e.jsx("span",{className:"text-sm text-orange-700 font-medium",children:"Scanning Master Control Library..."})]}),r&&e.jsxs("div",{className:"space-y-3",children:[r.length===0?e.jsx("div",{className:"text-center p-4 text-green-700 bg-green-50 rounded-md border border-green-200 text-sm",children:"No critical gaps found! You likely have good coverage options."}):r.map(i=>e.jsxs("div",{className:"bg-white border border-orange-200 rounded-md p-3 shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(X,{variant:i.priority==="HIGH"?"destructive":"default",className:i.priority==="HIGH"?"bg-red-500 hover:bg-red-600":"bg-orange-500 hover:bg-orange-600",children:[i.priority," PRIORITY"]}),e.jsx("span",{className:"font-bold text-slate-800",children:i.details.code})]}),e.jsx(g,{size:"sm",onClick:()=>M(i),disabled:R===i.controlId,className:"bg-orange-600 hover:bg-orange-700 text-white h-7 text-xs",children:R===i.controlId?e.jsx(W,{className:"w-3 h-3 animate-spin"}):e.jsxs(e.Fragment,{children:["Adopt ",e.jsx(_e,{className:"w-3 h-3 ml-1"})]})})]}),e.jsx("h4",{className:"text-sm font-semibold text-slate-900 mb-1",children:i.details.name}),e.jsx("p",{className:"text-xs text-slate-600 mb-2",children:i.details.description}),e.jsxs("div",{className:"bg-orange-50 p-2 rounded text-xs text-orange-800 italic",children:['" ',i.reasoning,' "']})]},i.controlId)),e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>d(null),className:"w-full text-xs text-slate-500",children:"Clear Results"})]})]})]})}function Js(){const[C,f]=Re(),[S,c]=Ie("/clients/:clientId/risks/assessments/:assessmentId"),r=c!=null&&c.clientId?parseInt(c.clientId):0,d=(c==null?void 0:c.assessmentId)==="new"?null:c!=null&&c.assessmentId?parseInt(c.assessmentId):null,{selectedClientId:T}=De();x.useEffect(()=>{},[r,T]);const[E,R]=x.useState(!1),[j,v]=x.useState(!1),[D,I]=x.useState("identification"),[M,i]=x.useState(!1),[P,A]=x.useState(null),[Je,he]=x.useState(null),[t,l]=x.useState({assessmentId:`RA-${new Date().getFullYear()}-${Math.floor(Math.random()*1e3)}`,title:"",assessmentDate:new Date().toISOString().split("T")[0],assessor:"",method:"Qualitative",threatId:void 0,threatDescription:"",vulnerabilityId:void 0,vulnerabilityDescription:"",affectedAssets:[],affectedProcessIds:[],likelihood:"Possible",impact:"High",inherentRisk:"Medium",controlEffectiveness:"Effective",residualRisk:"Low",riskOwner:"",treatmentOption:"None",recommendedActions:"",priority:"Medium",targetResidualRisk:"Low",reviewDueDate:"",status:"draft",notes:"",nextReviewDate:"",controlIds:[]}),{data:L}=u.clientControls.list.useQuery({clientId:r},{enabled:!!r}),{data:V}=u.risks.getAssets.useQuery({clientId:r},{enabled:!!r}),{data:O}=u.clients.getUsers.useQuery({clientId:r},{enabled:!!r}),{data:U}=u.risks.getThreats.useQuery({clientId:r},{enabled:!!r}),{data:Y}=u.risks.getVulnerabilities.useQuery({clientId:r},{enabled:!!r}),{data:$}=u.businessContinuity.processes.list.useQuery({clientId:r},{enabled:!!r}),{data:n,isLoading:ue}=u.risks.getRiskAssessments.useQuery({clientId:r},{select:s=>s.find(a=>a.id===d),enabled:!!d&&!!r});x.useEffect(()=>{if(n){const s=ie(n.inherentRisk,n.controlEffectiveness),a=n.residualRisk!==s;v(a),l({assessmentId:n.assessmentId,title:n.title||"",assessmentDate:n.assessmentDate?new Date(n.assessmentDate).toISOString().split("T")[0]:"",assessor:n.assessor||"",method:n.method||"Qualitative",threatId:n.threatId,threatDescription:n.threatDescription||"",vulnerabilityId:n.vulnerabilityId,vulnerabilityDescription:n.vulnerabilityDescription||"",affectedAssets:Array.isArray(n.affectedAssets)?n.affectedAssets:[],likelihood:n.likelihood||"Possible",impact:n.impact||"High",inherentRisk:n.inherentRisk||"Medium",controlEffectiveness:n.controlEffectiveness||"Effective",residualRisk:n.residualRisk||"Low",riskOwner:n.riskOwner||"",treatmentOption:n.treatmentOption||"Mitigate",recommendedActions:n.recommendedActions||"",priority:n.priority||"Medium",targetResidualRisk:n.targetResidualRisk||"Low",reviewDueDate:n.reviewDueDate?new Date(n.reviewDueDate).toISOString().split("T")[0]:"",status:n.status||"draft",notes:n.notes||"",nextReviewDate:n.nextReviewDate?new Date(n.nextReviewDate).toISOString().split("T")[0]:"",controlIds:Array.isArray(n.controlIds)?n.controlIds.filter(o=>typeof o=="number"):[]})}},[n]),x.useEffect(()=>{if(!j&&t.inherentRisk){const s=ie(t.inherentRisk,t.controlEffectiveness);s&&s!==t.residualRisk&&l(a=>({...a,residualRisk:s}))}},[t.inherentRisk,t.controlEffectiveness,j]);const xe=u.risks.createRiskAssessment.useMutation({onSuccess:()=>{p.success("Risk Assessment created successfully"),f(`/clients/${r}/risks/assessments`)},onError:s=>p.error(`Failed to create: ${s.message}`)}),pe=u.risks.updateRiskAssessment.useMutation({onSuccess:()=>{p.success("Risk Assessment updated successfully"),f(`/clients/${r}/risks/assessments`)},onError:s=>p.error(`Failed to update: ${s.message}`)}),fe=u.risks.createThreat.useMutation({onSuccess:s=>{p.success("Threat created"),l(a=>({...a,threatId:s.id,threatDescription:s.name}))}}),je=u.risks.createVulnerability.useMutation({onSuccess:s=>{p.success("Vulnerability created"),l(a=>({...a,vulnerabilityId:s.id,vulnerabilityDescription:s.name}))}}),ve=async s=>{try{await fe.mutateAsync({clientId:r,name:s,threatId:`T-${new Date().getFullYear()}-${Math.floor(Math.random()*1e3)}`,status:"active"})}catch(a){p.error(a.message)}},ge=async s=>{try{await je.mutateAsync({clientId:r,name:s,vulnerabilityId:`VULN-${new Date().getFullYear()}-${Math.floor(Math.random()*1e3)}`,status:"open"})}catch(a){p.error(a.message)}},be=async()=>{R(!0);try{if(d){const s={id:d,title:t.title,assessmentDate:t.assessmentDate||void 0,assessor:t.assessor,method:t.method,threatId:t.threatId||void 0,threatDescription:t.threatDescription,vulnerabilityId:t.vulnerabilityId||void 0,vulnerabilityDescription:t.vulnerabilityDescription,affectedAssets:t.affectedAssets,affectedProcessIds:t.affectedProcessIds,likelihood:t.likelihood,impact:t.impact,inherentRisk:t.inherentRisk,controlEffectiveness:t.controlEffectiveness,residualRisk:t.residualRisk,riskOwner:t.riskOwner,treatmentOption:t.treatmentOption,recommendedActions:t.recommendedActions,priority:t.priority,targetResidualRisk:t.targetResidualRisk,reviewDueDate:t.reviewDueDate||void 0,status:t.status,notes:t.notes,nextReviewDate:t.nextReviewDate||void 0,controlIds:t.controlIds};console.log("Submitting Update Payload:",s),await pe.mutateAsync(s)}else{const s={clientId:r,assessmentId:t.assessmentId,title:t.title,assessmentDate:t.assessmentDate||void 0,assessor:t.assessor,method:t.method,threatId:t.threatId||void 0,threatDescription:t.threatDescription,vulnerabilityId:t.vulnerabilityId||void 0,vulnerabilityDescription:t.vulnerabilityDescription,affectedAssets:t.affectedAssets,affectedProcessIds:t.affectedProcessIds,likelihood:t.likelihood,impact:t.impact,inherentRisk:t.inherentRisk,controlEffectiveness:t.controlEffectiveness,residualRisk:t.residualRisk,riskOwner:t.riskOwner,treatmentOption:t.treatmentOption,recommendedActions:t.recommendedActions,priority:t.priority,targetResidualRisk:t.targetResidualRisk,reviewDueDate:t.reviewDueDate||void 0,status:t.status,notes:t.notes,nextReviewDate:t.nextReviewDate||void 0,controlIds:t.controlIds};console.log("Submitting Create Payload:",s),await xe.mutateAsync(s)}}catch(s){console.error(s)}finally{R(!1)}},{data:q,refetch:ee}=u.risks.getRiskTreatments.useQuery({riskAssessmentId:d||0},{enabled:!!d});u.risks.deleteRiskTreatment.useMutation({onSuccess:()=>{p.success("Treatment deleted"),ee()},onError:s=>p.error(`Failed to delete: ${s.message}`)});const ye=s=>{he(s)},se=s=>{l(a=>{const o=a.controlIds.includes(s);return{...a,controlIds:o?a.controlIds.filter(b=>b!==s):[...a.controlIds,s]}})},Ne=s=>{l(a=>{const o=a.affectedAssets.includes(s);return{...a,affectedAssets:o?a.affectedAssets.filter(b=>b!==s):[...a.affectedAssets,s]}})},ke=s=>{l(a=>{const o=(a.affectedProcessIds||[]).includes(s);return{...a,affectedProcessIds:o?(a.affectedProcessIds||[]).filter(b=>b!==s):[...a.affectedProcessIds||[],s]}})};return ue?e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx(W,{className:"animate-spin"})}):e.jsx(ze,{children:e.jsxs("div",{className:"px-6 py-8 pb-20",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>f(`/clients/${r}/risks/assessments`),children:e.jsx(Be,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(_,{className:"w-6 h-6 text-[#1C4D8D]"}),d?"Edit Risk Assessment":"New Risk Assessment"]}),e.jsxs("p",{className:"text-muted-foreground flex items-center gap-2",children:[t.assessmentId,(n==null?void 0:n.gapResponseId)&&e.jsx(g,{variant:"link",size:"sm",className:"text-orange-600 p-0 h-auto",onClick:()=>f(`/clients/${r}/gap-analysis`),children:"View Source Gap →"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{variant:"outline",onClick:()=>f(`/clients/${r}/risks/assessments`),children:"Cancel"}),e.jsxs(g,{onClick:be,disabled:E,children:[E&&e.jsx(W,{className:"w-4 h-4 mr-2 animate-spin"}),e.jsx(Ke,{className:"w-4 h-4 mr-2"}),"Save Assessment"]}),e.jsx(Qe,{title:d?"Edit Risk Assessment":"New Risk Assessment",description:"Score the likelihood and impact of a specific threat scenario.",rationale:"Standardized scoring ('Low', 'Medium', 'High') removes subjectivity and helps prioritize resources.",howToUse:[{step:"Define Scenario",description:"Combine a Threat and a Vulnerability to describe the risk event."},{step:"Score Inherent Risk",description:"Estimate the risk level assuming NO controls are in place."},{step:"Apply Controls",description:"Select existing controls to reduce the risk to a 'Residual' level."},{step:"Plan Treatment",description:"If residual risk is still too high, define a treatment plan (e.g., Avoid, Mitigate, Transfer)."}],integrations:[{name:"Gap Analysis",description:"Click 'View Source Gap' to see the original compliance gap that triggered this risk."},{name:"Control Effectiveness",description:"The status of linked controls directly influences the residual risk score."}]})]})]}),e.jsxs(Ae,{value:D,onValueChange:I,className:"w-full space-y-8",children:[e.jsx(Ce,{className:"w-full h-auto p-1.5 bg-slate-100/50 border border-slate-200 grid grid-cols-1 md:grid-cols-4 gap-2",children:[{id:"identification",label:"Identification",icon:te,desc:"Basic Details"},{id:"analysis",label:"Risk Analysis",icon:re,desc:"Score Risk"},{id:"controls",label:"Controls",icon:_,desc:"Mitigation"},{id:"treatment",label:"Treatment",icon:We,desc:"Action Plan"}].map(s=>e.jsxs(Se,{value:s.id,className:"flex items-center gap-3 px-4 py-3 h-auto data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:text-[#1C4D8D] border border-transparent data-[state=active]:border-slate-200 transition-all",children:[e.jsx("div",{className:`p-2 rounded-md transition-colors ${D===s.id?"bg-[#1C4D8D]/10 text-[#1C4D8D]":"bg-slate-200/50 text-slate-500"}`,children:e.jsx(s.icon,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex flex-col items-start transition-all",children:[e.jsx("span",{className:"text-sm font-bold tracking-tight",children:s.label}),e.jsx("span",{className:"text-[10px] font-medium opacity-70 uppercase tracking-wider",children:s.desc})]})]},s.id))}),e.jsxs("div",{className:"w-full",children:[e.jsx(B,{value:"identification",className:"mt-0 focus-visible:ring-0",children:e.jsxs(F,{children:[e.jsxs(G,{children:[e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(te,{className:"w-5 h-5 text-gray-500"}),"Identification"]}),e.jsx(z,{children:"Basic details about the risk assessment."})]}),e.jsxs(Q,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Title / Name"}),e.jsx(ae,{value:t.title,onChange:s=>l({...t,title:s.target.value}),placeholder:"e.g. Annual Review of AWS Access Controls"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Assessment Date"}),e.jsxs("div",{className:"relative",children:[e.jsx(de,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500"}),e.jsx(ae,{type:"date",className:"pl-9",value:t.assessmentDate,onChange:s=>l({...t,assessmentDate:s.target.value})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Assessor"}),e.jsxs(y,{onValueChange:s=>l({...t,assessor:s}),value:t.assessor,children:[e.jsx(N,{children:e.jsx(k,{placeholder:"Select Assessor"})}),e.jsx(w,{children:O==null?void 0:O.map(s=>e.jsx(h,{value:s.name||s.email,children:s.name},s.id))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Affected Assets"}),e.jsxs("div",{className:"border rounded-md p-3 min-h-[100px] max-h-[200px] overflow-y-auto space-y-1 bg-slate-50/50",children:[V==null?void 0:V.map(s=>e.jsxs("div",{className:`flex items-center gap-2 p-2 rounded text-sm cursor-pointer transition-colors ${t.affectedAssets.includes(s.name)?"bg-blue-100 text-blue-800 border-blue-200":"hover:bg-slate-100"}`,onClick:()=>Ne(s.name),children:[e.jsx("div",{className:`w-4 h-4 border rounded flex items-center justify-center ${t.affectedAssets.includes(s.name)?"bg-blue-600 border-blue-600":"border-gray-400"}`,children:t.affectedAssets.includes(s.name)&&e.jsx(K,{className:"w-3 h-3 text-white"})}),e.jsx("span",{children:s.name})]},s.id)),(!V||V.length===0)&&e.jsx("p",{className:"text-muted-foreground text-sm italic",children:"No assets found"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Affected Business Processes"}),e.jsxs("div",{className:"border rounded-md p-3 min-h-[100px] max-h-[200px] overflow-y-auto space-y-1 bg-slate-50/50",children:[$==null?void 0:$.map(s=>{const a=(t.affectedProcessIds||[]).includes(s.id);return e.jsxs("div",{className:`flex items-center gap-2 p-2 rounded text-sm cursor-pointer transition-colors ${a?"bg-purple-100 text-purple-800 border-purple-200":"hover:bg-slate-100"}`,onClick:()=>ke(s.id),children:[e.jsx("div",{className:`w-4 h-4 border rounded flex items-center justify-center ${a?"bg-[#1C4D8D] border-[#1C4D8D]":"border-gray-400"}`,children:a&&e.jsx(K,{className:"w-3 h-3 text-white"})}),e.jsx("span",{children:s.name}),s.criticalityTier&&e.jsx(X,{variant:"outline",className:"ml-auto text-xs",children:s.criticalityTier})]},s.id)}),(!$||$.length===0)&&e.jsx("p",{className:"text-muted-foreground text-sm italic",children:"No processes found"})]})]})]})]})}),e.jsx(B,{value:"analysis",className:"mt-0 focus-visible:ring-0",children:e.jsxs(F,{children:[e.jsxs(G,{children:[e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-5 h-5 text-gray-500"}),"Risk Analysis"]}),e.jsx(z,{children:"Analyze the threat, vulnerability, and inherent risk."})]}),e.jsxs(Q,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Threat Scenario"}),e.jsx(me,{items:(U||[]).map(s=>({label:s.name,value:s.id,description:s.description||void 0})),value:t.threatId,onChange:s=>{const a=U==null?void 0:U.find(o=>o.id===s);l({...t,threatId:s,threatDescription:(a==null?void 0:a.name)||""})},onCreate:ve,placeholder:"Select or create a threat...",searchPlaceholder:"Search threats..."}),e.jsx(J,{placeholder:"Additional details about the threat event...",value:t.threatDescription,onChange:s=>l({...t,threatDescription:s.target.value}),className:"min-h-[60px] text-sm text-muted-foreground"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Vulnerability"}),e.jsx(me,{items:(Y||[]).map(s=>({label:s.name,value:s.id,description:s.description||void 0})),value:t.vulnerabilityId,onChange:s=>{const a=Y==null?void 0:Y.find(o=>o.id===s);l({...t,vulnerabilityId:s,vulnerabilityDescription:(a==null?void 0:a.name)||""})},onCreate:ge,placeholder:"Select or create a vulnerability...",searchPlaceholder:"Search vulnerabilities..."}),e.jsx(J,{placeholder:"Additional details about the vulnerability...",value:t.vulnerabilityDescription,onChange:s=>l({...t,vulnerabilityDescription:s.target.value}),className:"min-h-[60px] text-sm text-muted-foreground"})]})]}),e.jsx("div",{className:"flex justify-end pt-2",children:e.jsx(ce,{name:oe.RISK_AUTO_TRIAGE,props:{clientId:parseInt((r==null?void 0:r.toString())||"0"),threatDescription:t.threatDescription,vulnerabilityDescription:t.vulnerabilityDescription,affectedAssets:t.affectedAssets,onAnalysisComplete:s=>{l(a=>({...a,likelihood:s.likelihood,impact:s.impact,inherentRisk:s.inherentRisk}))}}})}),e.jsx(ne,{}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Likelihood"}),e.jsxs(y,{onValueChange:s=>l({...t,likelihood:s}),value:t.likelihood,children:[e.jsx(N,{children:e.jsx(k,{})}),e.jsx(w,{children:["Rare","Unlikely","Possible","Likely","Almost Certain"].map(s=>e.jsx(h,{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Impact"}),e.jsxs(y,{onValueChange:s=>l({...t,impact:s}),value:t.impact,children:[e.jsx(N,{children:e.jsx(k,{})}),e.jsx(w,{children:["Low","Medium","High","Very High"].map(s=>e.jsx(h,{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{className:"text-blue-700",children:"Inherent Risk (Pre-Control)"}),e.jsxs(y,{onValueChange:s=>l({...t,inherentRisk:s}),value:t.inherentRisk,children:[e.jsx(N,{className:"bg-blue-50/50 border-blue-200",children:e.jsx(k,{})}),e.jsx(w,{children:["Low","Medium","High","Very High"].map(s=>e.jsx(h,{value:s,children:s},s))})]})]})]})]})]})}),e.jsx(B,{value:"controls",className:"mt-0 focus-visible:ring-0",children:e.jsxs(F,{children:[e.jsxs(G,{children:[e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"w-5 h-5 text-gray-500"}),"Existing Controls & Residual Risk"]}),e.jsx(z,{children:"Evaluate current controls and calculate residual risk."})]}),e.jsxs(Q,{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-3 flex gap-3 text-sm text-blue-900",children:[e.jsx(_,{className:"w-5 h-5 text-[#1C4D8D] shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold block mb-1",children:"Active Defenses (Current State)"}),"Select controls that are ",e.jsx("strong",{children:"currently active"}),". These give you immediate credit and lower your ",e.jsx("em",{children:"Residual Risk"})," score now."]})]}),e.jsx(ce,{name:oe.RISK_CONTROL_SUGGESTION,props:{clientId:parseInt((r==null?void 0:r.toString())||"0"),threat:t.threatDescription||"",vulnerability:t.vulnerabilityDescription||"",selectedControlIds:t.controlIds,onAddControl:s=>{t.controlIds.includes(s)||se(s)}}}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Applicable Controls"}),e.jsxs("div",{className:"border rounded-md p-4 max-h-60 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-2 bg-slate-50/50",children:[L==null?void 0:L.map(s=>{const{clientControl:a,control:o}=s,b=t.controlIds.includes(a.id);return e.jsxs("div",{className:`flex items-start gap-3 p-2.5 rounded text-sm cursor-pointer border transition-colors ${b?"bg-white border-blue-500 shadow-sm":"border-transparent hover:bg-white hover:border-slate-200"}`,onClick:()=>se(a.id),children:[e.jsx("div",{className:`mt-0.5 w-4 h-4 border rounded flex items-center justify-center shrink-0 ${b?"bg-blue-600 border-blue-600":"border-gray-300"}`,children:b&&e.jsx(K,{className:"w-3 h-3 text-white"})}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold block text-slate-700",children:(o==null?void 0:o.controlId)||a.controlId}),e.jsx("span",{className:"text-slate-500 text-xs line-clamp-2",children:(o==null?void 0:o.name)||a.customDescription})]})]},a.id)}),(!L||L.length===0)&&e.jsx("p",{className:"text-muted-foreground text-sm",children:"No controls available in library."})]})]}),e.jsx(qe,{clientId:parseInt(r),threat:t.threatDescription||"",vulnerability:t.vulnerabilityDescription||"",onControlAdopted:()=>{window.location.reload()}}),e.jsx(ne,{}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Control Effectiveness"}),e.jsxs(y,{onValueChange:s=>l({...t,controlEffectiveness:s}),value:t.controlEffectiveness,children:[e.jsx(N,{children:e.jsx(k,{})}),e.jsxs(w,{children:[e.jsx(h,{value:"Effective",children:"Effective"}),e.jsx(h,{value:"Partially Effective",children:"Partially Effective"}),e.jsx(h,{value:"Ineffective",children:"Ineffective"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(m,{className:"text-violet-700 font-semibold",children:"Residual Risk (Post-Control)"}),!j&&e.jsx(X,{variant:"outline",className:"text-[10px] font-normal gap-1 bg-violet-50 text-violet-700 border-violet-200",children:"Auto-calculated"})]}),e.jsxs(y,{onValueChange:s=>{l({...t,residualRisk:s}),v(!0)},value:t.residualRisk,children:[e.jsx(N,{className:"bg-violet-50/50 border-violet-200 font-medium",children:e.jsx(k,{})}),e.jsx(w,{children:["Low","Medium","High","Very High"].map(s=>e.jsx(h,{value:s,children:s},s))})]}),j&&e.jsx("button",{type:"button",onClick:()=>v(!1),className:"text-xs text-blue-600 hover:underline",children:"Reset to auto-calculate"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Target Risk Level"}),e.jsxs(y,{onValueChange:s=>l({...t,targetResidualRisk:s}),value:t.targetResidualRisk,children:[e.jsx(N,{children:e.jsx(k,{})}),e.jsx(w,{children:["Low","Medium","High"].map(s=>e.jsx(h,{value:s,children:s},s))})]})]})]})]})]})}),e.jsx(B,{value:"treatment",className:"mt-0 focus-visible:ring-0",children:e.jsxs(F,{children:[e.jsxs(G,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(H,{children:"Risk Treatment"}),e.jsx(z,{children:"Decide how to respond to the residual risk."})]}),d&&!M&&e.jsxs(g,{size:"sm",onClick:()=>{A(null),i(!0)},className:"gap-2",children:[e.jsx(Z,{className:"w-4 h-4"}),"Add Treatment"]})]}),e.jsxs(Q,{className:"space-y-6",children:[e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-md p-3 flex gap-3 text-sm text-amber-900",children:[e.jsx(de,{className:"w-5 h-5 text-amber-600 shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold block mb-1",children:"What is a Treatment Plan?"}),"Treatment Plans are ",e.jsx("strong",{children:"future actions"})," or projects. Use this if your Residual Risk is still too high after applying existing controls."]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Treatment Decision"}),e.jsxs(y,{onValueChange:s=>l({...t,treatmentOption:s}),value:t.treatmentOption,children:[e.jsx(N,{children:e.jsx(k,{})}),e.jsxs(w,{children:[e.jsx(h,{value:"None",children:"None (Not Decided)"}),e.jsx(h,{value:"Mitigate",children:"Mitigate"}),e.jsx(h,{value:"Accept",children:"Accept"}),e.jsx(h,{value:"Transfer",children:"Transfer"}),e.jsx(h,{value:"Avoid",children:"Avoid"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Risk Owner"}),e.jsxs(y,{onValueChange:s=>l({...t,riskOwner:s}),value:t.riskOwner,children:[e.jsx(N,{children:e.jsx(k,{placeholder:"Select Owner"})}),e.jsx(w,{children:O==null?void 0:O.map(s=>e.jsx(h,{value:s.name||s.email,children:s.name},s.id))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Recommended Actions"}),e.jsx(J,{value:t.recommendedActions,onChange:s=>l({...t,recommendedActions:s.target.value}),placeholder:"Summary of actions required..."})]}),d?e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"text-sm font-semibold text-gray-900 uppercase tracking-wider",children:"Active Treatment Plans"})}),M?e.jsx("div",{className:"mt-4",children:e.jsx(Te,{clientId:r,riskAssessmentId:d,onSuccess:()=>{ee(),i(!1),A(null)},onCancel:()=>{i(!1),A(null)},initialData:P,riskContext:{threat:t.threatDescription||"",vulnerability:t.vulnerabilityDescription||"",riskDetails:`Impact: ${t.impact}, Likelihood: ${t.likelihood}, Risk: ${t.inherentRisk}`}})}):q&&q.length>0?e.jsx("div",{className:"grid gap-4",children:q.map(s=>e.jsx(Ee,{treatment:s,onEdit:a=>{A(a),i(!0)},onDelete:ye},s.id))}):e.jsxs("div",{className:"text-center py-8 border-2 border-dashed rounded-lg",children:[e.jsx("p",{className:"text-sm text-muted-foreground italic mb-3",children:"No treatment plans added yet."}),e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>{A(null),i(!0)},className:"gap-2",children:[e.jsx(Z,{className:"w-4 h-4"}),"Create First Treatment"]})]})]}):e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-md p-4 text-sm text-amber-800 flex gap-2",children:[e.jsx("div",{className:"shrink-0",children:"⚠️"}),e.jsx("p",{children:"You must save the risk assessment first before adding detailed treatment plans."})]})]})]})})]})]})]})})}export{Js as default};
