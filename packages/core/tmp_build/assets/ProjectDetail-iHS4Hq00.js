import{r as f,t as v,R as he,j as e,L as m,I as O,S as be,l as Ne,c as g,E as M,G as D,H as k,J as A,K as h,i as $,ac as Ce,ab as Se,b as we,k as E,C as Q,d as U,e as B,f as G,m as Y,N as ie,O as le,P as V,Q as w,V as re,W as b,F as Te}from"./index-DOc7Nwb7.js";import{T as Ie,a as Re,b as H,c as W}from"./tabs-CBDTXbEn.js";import{D as Me,L as De}from"./DashboardLayout-aHnUqq57.js";import{B as ke}from"./Breadcrumb-CRi3LAxS.js";import{P as Ae}from"./PageGuide-CPKKXXS6.js";import{E as Z}from"./enhanced-dialog-CeRPsI16.js";import{T as ee}from"./textarea-BtxBxzdY.js";import{S as Le}from"./search-CwuIBBPE.js";import{I as Pe}from"./info-By5wLOUH.js";import{A as Ee}from"./arrow-left-CpuUojG-.js";import{G as $e}from"./github-DD1rPXyC.js";import{S as Fe}from"./shield-alert-iAruRy4W.js";import{P as ne}from"./pencil-Bud7U1sU.js";import{T as de}from"./trash-2-CFEfisbM.js";import{C as ce}from"./circle-check-C5kiwRoG.js";import{S as Oe}from"./sparkles-CoQ80pK2.js";import{L as ze}from"./layers-ZuBPQb1T.js";import{f as oe}from"./format-H2tx8_vS.js";import"./index--2vFva6Y.js";import"./filter-Ceo--4mb.js";import"./clipboard-check-CQkJX5J0.js";import"./send-FW7-3cjH.js";import"./scroll-area-DPaNxEJD.js";import"./settings-CIu9FFiX.js";import"./en-US-Bfz1jvxT.js";import"./getTimezoneOffsetInMilliseconds-em2BGgN1.js";import"./rocket-C2MuHhsn.js";import"./scale-BCebIfgE.js";import"./layout-grid-CGqkIAJU.js";import"./book-open-BffBrdze.js";import"./zap-B01fFOkT.js";import"./star-BTvaCCU4.js";import"./briefcase-BxorFA78.js";import"./target-cfAj3L6j.js";import"./database-Bjtecw5f.js";import"./activity-B1F2IRm3.js";import"./shield-check-ETs8j4-d.js";import"./brain-C-Zi22rJ.js";import"./link-FmUqdGRG.js";import"./lock-czWF3qbC.js";import"./globe-BMGZmoaJ.js";import"./calendar-BlLJlGbj.js";import"./message-square-5hBo7zY3.js";import"./upload-BBmUECj8.js";import"./user-CqRnJLgW.js";import"./separator-BWuYil37.js";import"./differenceInCalendarDays-nctqlg7V.js";function Ve({open:y,onOpenChange:j,riskId:s,clientId:u,onSuccess:n}){const[d,r]=f.useState(!1),[l,c]=f.useState(""),[p,L]=f.useState([]),[P,a]=f.useState(""),{data:i}=v.clientControls.list.useQuery({clientId:u},{enabled:y});he.useEffect(()=>{y&&(L([]),a(""),c(""))},[y]);const o=i==null?void 0:i.filter(x=>{var N,I,S,R;return((I=(N=x.control)==null?void 0:N.code)==null?void 0:I.toLowerCase().includes(l.toLowerCase()))||((R=(S=x.control)==null?void 0:S.name)==null?void 0:R.toLowerCase().includes(l.toLowerCase()))}).slice(0,5),z=v.risks.createRiskTreatment.useMutation(),F=v.risks.linkControl.useMutation(),T=async()=>{if(p.length!==0){r(!0);try{const N=`Implement controls: ${((i==null?void 0:i.filter(S=>p.includes(S.clientControl.id)))||[]).map(S=>{var R;return(R=S.control)==null?void 0:R.controlId}).join(", ")}`,I=await z.mutateAsync({clientId:u,riskAssessmentId:s,riskScenarioId:s,treatmentType:"mitigate",strategy:N,justification:P});await Promise.all(p.map(S=>F.mutateAsync({clientId:u,treatmentId:I.id,controlId:S}))),n(),j(!1),L([]),a(""),c("")}catch(x){console.error("Failed to link control",x)}finally{r(!1)}}},J=x=>{L(N=>N.includes(x)?N.filter(I=>I!==x):[...N,x])};return e.jsx(Z,{open:y,onOpenChange:j,title:"Treat Risk with Controls",description:"Select controls to mitigate this risk.",size:"md",footer:e.jsxs(e.Fragment,{children:[e.jsx(g,{variant:"outline",onClick:()=>j(!1),children:"Cancel"}),e.jsx(g,{onClick:T,disabled:d||p.length===0,children:d?"Linking...":"Apply Treatment"})]}),children:e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(m,{children:"Select Controls"}),e.jsxs("div",{className:"relative",children:[e.jsx(Le,{className:"absolute left-3 top-3 h-4 w-4 text-gray-400"}),e.jsx(O,{placeholder:"Search controls (e.g., Access, Backup)...",className:"pl-9",value:l,onChange:x=>c(x.target.value)})]}),e.jsxs("div",{className:"border rounded-md divide-y max-h-[200px] overflow-y-auto bg-gray-50",children:[(o==null?void 0:o.length)===0&&e.jsxs("div",{className:"p-4 text-center text-gray-500 text-sm",children:['No controls found matching "',l,'"']}),o==null?void 0:o.map(x=>{var I,S,R;const N=p.includes(x.clientControl.id);return e.jsxs("div",{onClick:()=>J(x.clientControl.id),className:`p-3 cursor-pointer flex items-start gap-3 hover:bg-blue-50 transition-colors ${N?"bg-blue-50 border-l-4 border-blue-500":""}`,children:[e.jsx("div",{className:`p-1.5 rounded bg-white border ${N?"border-blue-200 text-blue-600":"border-gray-200 text-gray-500"}`,children:e.jsx(be,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-sm text-gray-900",children:[(I=x.control)==null?void 0:I.code," - ",(S=x.control)==null?void 0:S.name]}),e.jsx("div",{className:"text-xs text-gray-500 line-clamp-1",children:(R=x.control)==null?void 0:R.description})]}),N&&e.jsx(Ne,{className:"w-4 h-4 text-blue-600 ml-auto mt-1"})]},x.clientControl.id)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Justification / Implementation Notes"}),e.jsx(ee,{placeholder:"Explain how this control modifies the risk likelihood or impact...",value:P,onChange:x=>a(x.target.value)})]})]})})}function Qe({open:y,onOpenChange:j,treatment:s,clientId:u,onSuccess:n}){const[d,r]=f.useState(!1),[l,c]=f.useState({treatmentType:(s==null?void 0:s.treatmentType)||"mitigate",strategy:(s==null?void 0:s.strategy)||"",justification:(s==null?void 0:s.justification)||"",owner:(s==null?void 0:s.owner)||"",dueDate:s!=null&&s.dueDate?new Date(s.dueDate).toISOString().split("T")[0]:"",priority:(s==null?void 0:s.priority)||"medium",status:(s==null?void 0:s.status)||"planned",estimatedCost:(s==null?void 0:s.estimatedCost)||""}),{data:p,isLoading:L}=v.clients.getUsers.useQuery({clientId:u},{enabled:y&&!!u});f.useEffect(()=>{y&&(console.log("[TreatmentEditDialog] clientId:",u),console.log("[TreatmentEditDialog] orgUsers:",p))},[y,p,u]),f.useEffect(()=>{s&&c({treatmentType:s.treatmentType||"mitigate",strategy:s.strategy||"",justification:s.justification||"",owner:s.owner||"",dueDate:s.dueDate?new Date(s.dueDate).toISOString().split("T")[0]:"",priority:s.priority||"medium",status:s.status||"planned",estimatedCost:s.estimatedCost||""})},[s]);const P=v.risks.updateRiskTreatment.useMutation(),a=async()=>{r(!0);try{await P.mutateAsync({id:s.id,...l}),$.success("Treatment updated successfully"),n(),j(!1)}catch(i){console.error("Failed to update treatment",i),$.error("Failed to update treatment")}finally{r(!1)}};return e.jsx(Z,{open:y,onOpenChange:j,title:"Edit Risk Treatment",description:"Update the treatment strategy for this risk.",size:"lg",footer:e.jsxs(e.Fragment,{children:[e.jsx(g,{variant:"outline",onClick:()=>j(!1),children:"Cancel"}),e.jsx(g,{onClick:a,disabled:d,children:d?"Saving...":"Save Changes"})]}),children:e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Treatment Type"}),e.jsxs(M,{value:l.treatmentType,onValueChange:i=>c({...l,treatmentType:i}),children:[e.jsx(D,{children:e.jsx(k,{})}),e.jsxs(A,{children:[e.jsx(h,{value:"mitigate",children:"Mitigate"}),e.jsx(h,{value:"transfer",children:"Transfer"}),e.jsx(h,{value:"accept",children:"Accept"}),e.jsx(h,{value:"avoid",children:"Avoid"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Status"}),e.jsxs(M,{value:l.status,onValueChange:i=>c({...l,status:i}),children:[e.jsx(D,{children:e.jsx(k,{})}),e.jsxs(A,{children:[e.jsx(h,{value:"planned",children:"Planned"}),e.jsx(h,{value:"in_progress",children:"In Progress"}),e.jsx(h,{value:"completed",children:"Completed"}),e.jsx(h,{value:"on_hold",children:"On Hold"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Strategy"}),e.jsx(O,{placeholder:"e.g., Implement MFA, Add encryption, etc.",value:l.strategy,onChange:i=>c({...l,strategy:i.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Justification / Notes"}),e.jsx(ee,{placeholder:"Explain how this treatment addresses the risk...",value:l.justification,onChange:i=>c({...l,justification:i.target.value}),rows:3})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Owner"}),e.jsxs(M,{value:l.owner,onValueChange:i=>c({...l,owner:i}),children:[e.jsx(D,{children:e.jsx(k,{placeholder:"Select owner..."})}),e.jsx(A,{children:p&&p.length>0?p.filter(i=>{const o=i.user||i;return(o==null?void 0:o.name)&&(o==null?void 0:o.email)}).map(i=>{const o=i.user||i;return e.jsxs(h,{value:o.name,children:[o.name," (",o.email,")"]},o.id)}):e.jsx("div",{className:"px-2 py-1.5 text-sm text-slate-500",children:"No users found"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Due Date"}),e.jsx(O,{type:"date",value:l.dueDate,onChange:i=>c({...l,dueDate:i.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Priority"}),e.jsxs(M,{value:l.priority,onValueChange:i=>c({...l,priority:i}),children:[e.jsx(D,{children:e.jsx(k,{})}),e.jsxs(A,{children:[e.jsx(h,{value:"critical",children:"Critical"}),e.jsx(h,{value:"high",children:"High"}),e.jsx(h,{value:"medium",children:"Medium"}),e.jsx(h,{value:"low",children:"Low"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Estimated Cost"}),e.jsx(O,{placeholder:"e.g., $5,000",value:l.estimatedCost,onChange:i=>c({...l,estimatedCost:i.target.value})})]})]})})}function Ue({open:y,onOpenChange:j,risk:s,clientId:u,onSuccess:n}){const[d,r]=f.useState(!1),[l,c]=f.useState({title:(s==null?void 0:s.title)||"",description:(s==null?void 0:s.description)||"",threatCategory:(s==null?void 0:s.threatCategory)||"General",status:(s==null?void 0:s.status)||"identified",owner:(s==null?void 0:s.owner)||"",likelihood:(s==null?void 0:s.likelihood)||1,impact:(s==null?void 0:s.impact)||1,residualLikelihood:s==null?void 0:s.residualLikelihood,residualImpact:s==null?void 0:s.residualImpact,residualScore:s==null?void 0:s.residualScore}),{data:p}=v.clients.getUsers.useQuery({clientId:u},{enabled:y&&!!u});f.useEffect(()=>{s&&c({title:s.title||"",description:s.description||"",threatCategory:s.threatCategory||"General",status:s.status||"identified",owner:s.owner||"",likelihood:s.likelihood?Number(s.likelihood):1,impact:s.impact?Number(s.impact):1,residualLikelihood:s.residualLikelihood?Number(s.residualLikelihood):void 0,residualImpact:s.residualImpact?Number(s.residualImpact):void 0,residualScore:s.residualScore?Number(s.residualScore):void 0})},[s]);const L=v.devProjects.updateRisk.useMutation(),P=async()=>{r(!0);const a={id:s.id,clientId:u,...l};console.log("[RiskEditDialog] Submitting mutation with payload:",JSON.stringify(a,null,2));try{const i=await L.mutateAsync(a);console.log("[RiskEditDialog] Mutation result:",JSON.stringify(i,null,2)),$.success("Risk updated successfully"),n(),j(!1)}catch(i){console.error("[RiskEditDialog] Failed to update risk",i),$.error("Failed to update risk")}finally{r(!1)}};return e.jsx(Z,{open:y,onOpenChange:j,title:"Edit Risk",description:"Update the details for this risk.",size:"lg",footer:e.jsxs(e.Fragment,{children:[e.jsx(g,{variant:"outline",onClick:()=>j(!1),children:"Cancel"}),e.jsx(g,{onClick:P,disabled:d,children:d?"Saving...":"Save Changes"})]}),children:e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx("div",{className:"bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Pe,{className:"h-5 w-5 text-blue-600 mt-0.5"}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsx("h4",{className:"font-semibold text-slate-900",children:"Risk Assessment Methodology"}),e.jsxs("p",{className:"text-slate-600 leading-relaxed text-xs",children:["Risks are evaluated using a standard 5x5 matrix: ",e.jsx("br",{}),e.jsx("span",{className:"font-mono bg-slate-200 px-1.5 py-0.5 rounded text-[10px]",children:"Likelihood (1-5) × Impact (1-5) = Risk Score"})]}),e.jsxs("ul",{className:"grid grid-cols-2 gap-x-4 gap-y-1 text-[10px] text-slate-500 font-medium",children:[e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-red-600"})," 15-25: Critical"]}),e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-orange-500"})," 9-14: High"]}),e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-amber-500"})," 4-8: Medium"]}),e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-emerald-600"})," 1-3: Low"]})]}),e.jsxs("div",{className:"pt-2 border-t border-slate-200 flex gap-4 text-[10px]",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"text-slate-700",children:"Inherent:"})," Before controls"]}),e.jsxs("div",{children:[e.jsx("strong",{className:"text-slate-700",children:"Residual:"})," After mitigations"]})]})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Title"}),e.jsx(O,{value:l.title,onChange:a=>c({...l,title:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Description"}),e.jsx(ee,{value:l.description,onChange:a=>c({...l,description:a.target.value}),rows:3})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Category"}),e.jsx(O,{value:l.threatCategory,onChange:a=>c({...l,threatCategory:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Status"}),e.jsxs(M,{value:l.status,onValueChange:a=>c({...l,status:a}),children:[e.jsx(D,{children:e.jsx(k,{})}),e.jsxs(A,{children:[e.jsx(h,{value:"identified",children:"Identified"}),e.jsx(h,{value:"assessed",children:"Assessed"}),e.jsx(h,{value:"mitigated",children:"Mitigated"}),e.jsx(h,{value:"accepted",children:"Accepted"}),e.jsx(h,{value:"closed",children:"Closed"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Likelihood (1-5)"}),e.jsx("p",{className:"text-[10px] text-slate-500",children:"Frequency of threat event"}),e.jsxs(M,{value:String(l.likelihood),onValueChange:a=>c({...l,likelihood:parseInt(a)}),children:[e.jsx(D,{children:e.jsx(k,{})}),e.jsx(A,{children:[1,2,3,4,5].map(a=>e.jsx(h,{value:String(a),children:a},a))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Impact (1-5)"}),e.jsx("p",{className:"text-[10px] text-slate-500",children:"Severity of potential loss"}),e.jsxs(M,{value:String(l.impact),onValueChange:a=>c({...l,impact:parseInt(a)}),children:[e.jsx(D,{children:e.jsx(k,{})}),e.jsx(A,{children:[1,2,3,4,5].map(a=>e.jsx(h,{value:String(a),children:a},a))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Residual Likelihood (Opt.)"}),e.jsxs(M,{value:String(l.residualLikelihood||""),onValueChange:a=>c({...l,residualLikelihood:a?parseInt(a):void 0}),children:[e.jsx(D,{children:e.jsx(k,{placeholder:"-"})}),e.jsx(A,{children:[1,2,3,4,5].map(a=>e.jsx(h,{value:String(a),children:a},a))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Residual Impact (Opt.)"}),e.jsxs(M,{value:String(l.residualImpact||""),onValueChange:a=>c({...l,residualImpact:a?parseInt(a):void 0}),children:[e.jsx(D,{children:e.jsx(k,{placeholder:"-"})}),e.jsx(A,{children:[1,2,3,4,5].map(a=>e.jsx(h,{value:String(a),children:a},a))})]})]})]}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Residual Score (Manual)"}),e.jsx(O,{type:"number",placeholder:"Auto-calculated if L/I set",value:l.residualScore||"",onChange:a=>c({...l,residualScore:a.target.value?parseInt(a.target.value):void 0})})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Owner"}),e.jsxs(M,{value:l.owner,onValueChange:a=>c({...l,owner:a}),children:[e.jsx(D,{children:e.jsx(k,{placeholder:"Select owner..."})}),e.jsx(A,{children:p&&p.length>0?p.filter(a=>{const i=a.user||a;return(i==null?void 0:i.name)&&(i==null?void 0:i.email)}).map(a=>{const i=a.user||a;return e.jsxs(h,{value:i.name,children:[i.name," (",i.email,")"]},i.id)}):e.jsx("div",{className:"px-2 py-1.5 text-sm text-slate-500",children:"No users found"})})]})]})]})})}const $s=()=>{var ae;const{selectedClientId:y}=Ce(),j=Se(),[s,u]=we(),n=j.clientId?parseInt(j.clientId):y,d=parseInt(j.projectId||"0"),{data:r,isLoading:l,error:c}=v.devProjects.get.useQuery({id:d,clientId:n},{enabled:!!n&&!!d,retry:!1}),{data:p}=v.projects.get.useQuery({id:d,clientId:n},{enabled:!!n&&!!d&&(!!c||!r),retry:!1});he.useEffect(()=>{p&&u(`/clients/${n}/projects/${d}`)},[p,n,d,u]);const[L,P]=f.useState("threat-models"),{data:a,refetch:i}=v.devProjects.getRisks.useQuery({clientId:n,devProjectId:d},{enabled:!!n&&!!d}),{data:o,refetch:z}=v.devProjects.getTreatments.useQuery({clientId:n,devProjectId:d},{enabled:!!n&&!!d}),{data:F}=v.advisor.getOwaspIntelligence.useQuery({tags:(r==null?void 0:r.techStack)||[],limit:20},{enabled:!!(r!=null&&r.techStack)&&r.techStack.length>0}),{data:T,refetch:J}=v.devProjects.getComplianceMappings.useQuery({devProjectId:d},{enabled:!!d}),x=v.devProjects.mapRequirement.useMutation(),N=v.devProjects.createTask.useMutation(),I=async t=>{var C;try{await x.mutateAsync({clientId:n,devProjectId:d,framework:"OWASP",requirementId:t.identifier,notes:`Automatically suggested requirement based on tech stack (${(C=r==null?void 0:r.techStack)==null?void 0:C.join(", ")})`}),$.success(`Mapped ${t.identifier} to project.`),J()}catch(ye){console.error("Failed to map requirement",ye),$.error("Failed to map requirement.")}},S=async t=>{try{await N.mutateAsync({clientId:n,devProjectId:d,title:`Implement ${t.identifier}: ${t.title}`,description:`Implementation guidance: ${t.guidance||t.description}`,priority:"medium"}),$.success(`Created implementation task for ${t.identifier}.`)}catch(C){console.error("Failed to create task",C),$.error("Failed to create task.")}},[R,se]=f.useState(!1),[te,xe]=f.useState(null),[_,K]=f.useState(null),[q,X]=f.useState(null),me=v.risks.deleteRiskTreatment.useMutation(),ue=v.devProjects.deleteRisk.useMutation(),je=t=>{xe(t),se(!0)},pe=t=>{K(t)},ge=t=>{X(t)},ve=async t=>{if(confirm("Are you sure you want to delete this mitigation?"))try{await me.mutateAsync({id:t}),z(),i()}catch(C){console.error("Failed to delete treatment",C)}},fe=async t=>{if(confirm("Are you sure you want to delete this risk?"))try{await ue.mutateAsync({id:t,clientId:n}),i(),z()}catch(C){console.error("Failed to delete risk",C)}};return l?e.jsx("div",{className:"p-8",children:"Loading project details..."}):r?e.jsx(Me,{children:e.jsxs("div",{className:"space-y-6 page-transition",children:[e.jsx(ke,{items:[{label:"Dashboard",href:"/dashboard"},{label:"Threat Modeling",href:`/clients/${n}/dev/projects`},{label:r.name}]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>u(`/clients/${n}/dev/projects`),children:e.jsx(Ee,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:r.name}),r.repositoryUrl&&e.jsx("a",{href:r.repositoryUrl,target:"_blank",rel:"noopener noreferrer",className:"text-slate-400 hover:text-slate-600",children:e.jsx($e,{className:"h-5 w-5"})})]}),e.jsx("p",{className:"text-slate-500 mt-1",children:r.description})]}),e.jsxs("div",{className:"ml-auto flex gap-2 items-center",children:[e.jsx(Ae,{title:"Project Security Hub",description:"Central view for all security aspects of this application.",rationale:"Consolidates threat models, risks, and compliance requirements.",howToUse:[{step:"Threat Models",description:"Create and review architectural diagrams."},{step:"Risk Register",description:"Track specific vulnerabilities."},{step:"Compliance",description:"Map OWASP requirements to your stack."}]}),e.jsx(E,{variant:"outline",className:"text-sm px-3 py-1 bg-white",children:r.owner||"No Owner"})]})]}),e.jsxs(Ie,{value:L,onValueChange:P,className:"w-full",children:[e.jsxs(Re,{className:"bg-transparent border-b rounded-none w-full justify-start h-auto p-0 mb-6",children:[e.jsx(H,{value:"threat-models",className:"border-b-2 border-transparent data-[state=active]:border-blue-600 data-[state=active]:shadow-none rounded-none px-4 py-2",children:"Threat Models"}),e.jsx(H,{value:"risks",className:"border-b-2 border-transparent data-[state=active]:border-blue-600 data-[state=active]:shadow-none rounded-none px-4 py-2",children:"Risk Register"}),e.jsx(H,{value:"mitigations",className:"border-b-2 border-transparent data-[state=active]:border-blue-600 data-[state=active]:shadow-none rounded-none px-4 py-2",children:"Mitigations"}),e.jsx(H,{value:"compliance",className:"border-b-2 border-transparent data-[state=active]:border-blue-600 data-[state=active]:shadow-none rounded-none px-4 py-2",children:"Compliance (OWASP)"})]}),e.jsx(W,{value:"threat-models",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Threat Models"}),e.jsx(g,{onClick:()=>u(`/clients/${n}/dev/projects/${d}/threat-model/new`),children:"Create Threat Model"})]}),r.threatModels&&r.threatModels.length>0?e.jsx("div",{className:"grid gap-4",children:r.threatModels.map(t=>e.jsx("div",{className:"cursor-pointer transition-all hover:scale-[1.01]",onClick:()=>{console.log("Navigating to threat model:",t.id),u(`/clients/${n}/dev/projects/${d}/threat-model/${t.id}`)},children:e.jsx(Q,{className:"hover:bg-slate-50 border-blue-100/50 hover:border-blue-300 transition-colors",children:e.jsxs(U,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Fe,{className:"h-5 w-5 text-blue-500"}),e.jsxs("div",{children:[e.jsx(B,{className:"text-base text-blue-950",children:t.name}),e.jsxs(G,{children:[t.methodology," • ",oe(new Date(t.updatedAt),"MMM d, yyyy")]})]})]}),e.jsx(E,{variant:t.status==="active"?"default":"secondary",className:t.status==="active"?"bg-blue-100 text-blue-700 hover:bg-blue-200":"",children:t.status})]})})},t.id))}):e.jsx("div",{className:"text-center py-10 border border-dashed rounded-lg text-slate-500",children:"No threat models found. Create one to analyze risks."})]})}),e.jsx(W,{value:"risks",children:e.jsxs(Q,{children:[e.jsxs(U,{children:[e.jsx(B,{children:"Risk Register"}),e.jsxs(G,{children:["Identified security risks for ",r.name]})]}),e.jsx(Y,{children:e.jsxs(ie,{children:[e.jsx(le,{children:e.jsxs(V,{children:[e.jsx(w,{children:"Risk Title"}),e.jsx(w,{children:"Category"}),e.jsx(w,{className:"text-center",children:"Likelihood"}),e.jsx(w,{className:"text-center",children:"Impact"}),e.jsx(w,{children:"Inherent Risk"}),e.jsx(w,{children:"Residual Risk"}),e.jsx(w,{children:"Status"}),e.jsx(w,{className:"text-right",children:"Actions"})]})}),e.jsxs(re,{children:[a==null?void 0:a.map(t=>e.jsxs(V,{children:[e.jsxs(b,{className:"font-medium",children:[e.jsx("div",{children:t.title}),e.jsx("div",{className:"text-xs text-slate-500 line-clamp-1",children:t.description})]}),e.jsx(b,{children:e.jsx(E,{variant:"outline",children:t.threatCategory||"General"})}),e.jsx(b,{className:"text-center",children:t.likelihood?e.jsx("div",{className:`inline-flex items-center justify-center w-8 h-8 rounded-md text-white font-bold text-sm shadow-sm ${Number(t.likelihood)>=5?"bg-red-600":Number(t.likelihood)>=4?"bg-orange-500":Number(t.likelihood)>=3?"bg-amber-500":"bg-emerald-600"}`,children:t.likelihood}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(b,{className:"text-center",children:t.impact?e.jsx("div",{className:`inline-flex items-center justify-center w-8 h-8 rounded-md text-white font-bold text-sm shadow-sm ${Number(t.impact)>=5?"bg-red-600":Number(t.impact)>=4?"bg-orange-500":Number(t.impact)>=3?"bg-amber-500":"bg-emerald-600"}`,children:t.impact}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(b,{children:e.jsxs("div",{className:`font-bold ${Number(t.inherentScore)>=15?"text-red-600":Number(t.inherentScore)>=9?"text-amber-600":"text-green-600"}`,children:[t.inherentScore," ",e.jsxs("span",{className:"text-xs font-normal text-muted-foreground",children:["(",t.inherentRisk,")"]})]})}),e.jsx(b,{children:t.residualScore?e.jsxs("div",{className:`font-bold ${Number(t.residualScore)>=15?"text-red-600":Number(t.residualScore)>=9?"text-amber-600":"text-green-600"}`,children:[t.residualScore," ",e.jsxs("span",{className:"text-xs font-normal text-muted-foreground",children:["(",t.residualRisk||"-",")"]})]}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(b,{children:e.jsx(E,{variant:t.status==="mitigated"?"default":"secondary",children:t.status})}),e.jsx(b,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(g,{size:"sm",variant:"outline",onClick:()=>je(t.id),children:"Mitigate"}),e.jsx(g,{size:"icon",variant:"ghost",onClick:()=>ge(t),children:e.jsx(ne,{className:"h-4 w-4"})}),e.jsx(g,{size:"icon",variant:"ghost",className:"text-red-500 hover:text-red-700 hover:bg-red-50",onClick:()=>fe(t.id),children:e.jsx(de,{className:"h-4 w-4"})})]})})]},t.id)),(!a||a.length===0)&&e.jsx(V,{children:e.jsx(b,{colSpan:8,className:"text-center py-10 text-slate-500 italic",children:"No risks identified yet. Run a Threat Model to generate risks."})})]})]})})]})}),e.jsx(W,{value:"mitigations",children:e.jsxs(Q,{children:[e.jsxs(U,{children:[e.jsx(B,{children:"Mitigations"}),e.jsx(G,{children:"Risk treatment strategy and status"})]}),e.jsx(Y,{children:e.jsxs(ie,{children:[e.jsx(le,{children:e.jsxs(V,{children:[e.jsx(w,{children:"Risk"}),e.jsx(w,{children:"Strategy"}),e.jsx(w,{children:"Status"}),e.jsx(w,{children:"Due Date"}),e.jsx(w,{className:"text-right",children:"Actions"})]})}),e.jsxs(re,{children:[o==null?void 0:o.map(t=>e.jsxs(V,{children:[e.jsx(b,{className:"font-medium",children:t.riskTitle}),e.jsxs(b,{children:[e.jsx("div",{className:"capitalize font-semibold",children:t.treatment.treatmentType}),e.jsx("div",{className:"text-xs text-slate-500",children:t.treatment.strategy||t.treatment.justification})]}),e.jsx(b,{children:e.jsx(E,{variant:"secondary",children:t.treatment.status})}),e.jsx(b,{className:"text-slate-500",children:t.treatment.dueDate?oe(new Date(t.treatment.dueDate),"MMM d, yyyy"):"No date"}),e.jsx(b,{className:"text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(g,{size:"sm",variant:"outline",onClick:()=>pe(t.treatment),children:e.jsx(ne,{className:"h-3 w-3"})}),e.jsx(g,{size:"sm",variant:"outline",className:"text-red-600 hover:bg-red-50 hover:border-red-300",onClick:()=>ve(t.treatment.id),children:e.jsx(de,{className:"h-3 w-3"})})]})})]},t.treatment.id)),(!o||o.length===0)&&e.jsx(V,{children:e.jsx(b,{colSpan:5,className:"text-center py-10 text-slate-500 italic",children:"No mitigations planned yet."})})]})]})})]})}),e.jsx(W,{value:"compliance",children:e.jsxs(Q,{children:[e.jsxs(U,{children:[e.jsx(B,{children:"OWASP Security Requirements"}),e.jsxs(G,{children:["Recommended security controls based on your tech stack: ",(ae=r.techStack)==null?void 0:ae.join(", ")]})]}),e.jsx(Y,{children:e.jsxs("div",{className:"space-y-4",children:[F==null?void 0:F.map(t=>e.jsxs("div",{className:"p-4 border rounded-lg bg-slate-50 hover:bg-white transition-colors group",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(E,{className:"bg-blue-600",children:t.identifier}),e.jsx(E,{variant:"outline",className:"text-[10px] uppercase",children:"OWASP"}),(T==null?void 0:T.some(C=>C.requirementId===t.identifier))&&e.jsxs(E,{className:"bg-green-100 text-green-700 border-green-200",children:[e.jsx(ce,{className:"w-3 h-3 mr-1"}),"Mapped to Controls"]})]}),e.jsx("h3",{className:"font-bold text-lg text-blue-950 group-hover:text-blue-600 transition-colors",children:t.title})]}),e.jsxs(g,{size:"sm",variant:"ghost",className:"opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(Te,{className:"h-4 w-4 mr-2"}),"View Guidelines"]})]}),e.jsx("p",{className:"text-sm text-slate-600 mt-2 line-clamp-2",children:t.description}),t.guidance&&e.jsxs("div",{className:"mt-3 p-3 bg-white/50 rounded border border-blue-100/50 italic text-xs text-blue-800",children:[e.jsx(Oe,{className:"w-3 h-3 inline mr-1 text-blue-500"}),e.jsx("strong",{children:"Paved Road:"})," ",t.guidance]}),e.jsxs("div",{className:"flex gap-2 mt-4 pt-4 border-t border-slate-200/50",children:[e.jsxs(g,{size:"sm",variant:"outline",className:"h-8",onClick:()=>I(t),disabled:T==null?void 0:T.some(C=>C.requirementId===t.identifier),children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),T!=null&&T.some(C=>C.requirementId===t.identifier)?"Mapped":"Map to Control"]}),e.jsxs(g,{size:"sm",variant:"secondary",className:"h-8",onClick:()=>S(t),children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"Create Implementation Task"]})]})]},t.id)),(!F||F.length===0)&&e.jsxs("div",{className:"text-center py-10 text-slate-500 italic flex flex-col items-center",children:[e.jsx(ze,{className:"h-10 w-10 mb-4 opacity-20"}),e.jsx("p",{children:"No explicit OWASP requirements found for this tech stack."}),e.jsx("p",{className:"text-xs mt-1",children:"Add technologies like 'React', 'API', or 'Python' to get specific suggestions."})]})]})})]})})]}),R&&te&&e.jsx(Ve,{open:R,onOpenChange:se,riskId:te,clientId:n,onSuccess:()=>{z(),i()}}),_&&e.jsx(Qe,{open:!!_,onOpenChange:t=>!t&&K(null),treatment:_,clientId:n,onSuccess:()=>{z(),i(),K(null)}}),q&&e.jsx(Ue,{open:!!q,onOpenChange:t=>!t&&X(null),risk:q,clientId:n,onSuccess:()=>{i(),X(null)}})]})}):e.jsxs("div",{className:"p-8",children:[e.jsx("h1",{className:"text-xl font-bold text-red-600",children:"Project not found"}),e.jsxs("div",{className:"mt-4 p-4 border rounded bg-slate-50 text-sm font-mono",children:[e.jsx("p",{children:"Debug Information:"}),e.jsxs("ul",{className:"list-disc ml-5 mt-2",children:[e.jsxs("li",{children:["clientId: ",String(n)," (type: ",typeof n,")"]}),e.jsxs("li",{children:["projectId: ",String(d)," (type: ",typeof d,")"]}),e.jsxs("li",{children:["params.clientId: ",j.clientId]}),e.jsxs("li",{children:["params.id (legacy): ",j.id]}),e.jsxs("li",{children:["params.projectId: ",j.projectId]}),e.jsxs("li",{children:["selectedClientId (context): ",String(y)]})]})]}),e.jsx(g,{className:"mt-4",onClick:()=>u(`/clients/${n}/dev/projects`),children:"Back to Threat Modeling"})]})};export{$s as ProjectDetail};
