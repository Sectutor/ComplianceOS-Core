import{ab as Z,r as m,t as g,i as j,j as e,c as b,I as x,C as v,m as N,z as ee,k as h,d as y,e as S,N as se,O as ae,P as w,Q as f,V as te,W as o,F as ie,D as re,o as le,p as ce,q as ne,L as n,E,G as F,H as k,J as B,K as c,w as oe}from"./index-DOc7Nwb7.js";import{T as de}from"./textarea-BtxBxzdY.js";import{A as me,a as xe,b as he,c as ue,d as pe,e as ge,f as je,g as ve}from"./alert-dialog-V7xGXdVc.js";import{P as Ne}from"./PageGuide-CPKKXXS6.js";import{P as fe}from"./plus-BaQ35Jcx.js";import{S as be}from"./search-CwuIBBPE.js";import{C as Ce}from"./clock-osbacZli.js";import{S as ye}from"./square-pen-ClRv15cM.js";import{T as Se}from"./trash-2-CFEfisbM.js";import"./scroll-area-DPaNxEJD.js";import"./separator-BWuYil37.js";import"./book-open-BffBrdze.js";import"./link-FmUqdGRG.js";import"./info-By5wLOUH.js";function He(){const{id:q}=Z(),C=parseInt(q||"0"),[A,z]=m.useState(""),[G,u]=m.useState(!1),[a,r]=m.useState({activityName:"",activityId:"",description:"",role:"controller",purposes:"",legalBasis:"contract",dataCategories:"",dataSubjectCategories:"",recipients:"",status:"draft"}),{data:t,isLoading:J,refetch:D}=g.processingActivities.list.useQuery({clientId:C}),{data:l}=g.processingActivities.checkExemption.useQuery({clientId:C}),{data:d}=g.processingActivities.getOverdueReviews.useQuery({clientId:C}),[I,O]=m.useState(!1),[L,M]=m.useState(null),[H,Q]=m.useState(null),[K,P]=m.useState(!1),R=g.processingActivities.update.useMutation({onSuccess:()=>{j.success("Processing activity updated successfully"),u(!1),_(),D()},onError:s=>{j.error(`Failed to update activity: ${s.message}`)}}),V=g.processingActivities.delete.useMutation({onSuccess:()=>{j.success("Processing activity deleted successfully"),P(!1),Q(null),D()},onError:s=>{j.error(`Failed to delete activity: ${s.message}`)}}),_=()=>{r({activityName:"",activityId:"",description:"",role:"controller",purposes:"",legalBasis:"contract",dataCategories:"",dataSubjectCategories:"",recipients:"",status:"draft"}),O(!1),M(null)},T=g.processingActivities.create.useMutation({onSuccess:()=>{j.success("Processing activity created successfully"),u(!1),r({activityName:"",activityId:"",description:"",role:"controller",purposes:"",legalBasis:"contract",dataCategories:"",dataSubjectCategories:"",recipients:""}),D()},onError:s=>{j.error(`Failed to create activity: ${s.message}`)}}),U=()=>{const s={clientId:C,activityName:a.activityName,activityId:a.activityId,description:a.description,role:a.role,purposes:a.purposes.split(",").map(i=>i.trim()).filter(Boolean),legalBasis:a.legalBasis,dataCategories:a.dataCategories.split(",").map(i=>i.trim()).filter(Boolean),dataSubjectCategories:a.dataSubjectCategories.split(",").map(i=>i.trim()).filter(Boolean),recipients:a.recipients.split(",").map(i=>({name:i.trim(),type:"internal"})).filter(i=>i.name),status:a.status};I&&L?R.mutate({id:L,...s}):T.mutate(s)},$=s=>{console.log("[ROPA] Edit clicked (Row or Button) for ID:",s.id),O(!0),M(s.id),r({activityName:s.activityName,activityId:s.activityId,description:s.description||"",role:s.role,purposes:Array.isArray(s.purposes)?s.purposes.join(", "):"",legalBasis:s.legalBasis,dataCategories:Array.isArray(s.dataCategories)?s.dataCategories.join(", "):"",dataSubjectCategories:Array.isArray(s.dataSubjectCategories)?s.dataSubjectCategories.join(", "):"",recipients:Array.isArray(s.recipients)?s.recipients.map(i=>i.name).join(", "):"",status:s.status||"draft"}),u(!0)},W=s=>{Q(s),P(!0)},X=()=>{H&&V.mutate({id:H})},p=t==null?void 0:t.filter(s=>s.activityName.toLowerCase().includes(A.toLowerCase())||s.activityId.toLowerCase().includes(A.toLowerCase())),Y=s=>{switch(s){case"active":return"bg-green-100 text-green-800";case"draft":return"bg-yellow-100 text-yellow-800";case"archived":return"bg-gray-100 text-gray-800";default:return"bg-blue-100 text-blue-800"}};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center animate-slide-down",children:[e.jsx(Ne,{title:"Records of Processing Activities (ROPA)",description:"GDPR Article 30 documentation of data processing.",rationale:"Mandatory regulatory record of how personal data is handled.",howToUse:[{step:"Document",description:"Record purpose, legal basis, and retention."},{step:"Identify",description:"Map data categories and subject types."},{step:"Maintain",description:"Regularly review and update activities."}]}),e.jsxs(b,{onClick:()=>{_(),u(!0)},children:[e.jsx(fe,{className:"mr-2 h-4 w-4"})," New Processing Activity"]})]}),e.jsx("div",{className:"flex gap-4",children:e.jsxs("div",{className:"relative flex-1",children:[e.jsx(be,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(x,{placeholder:"Search by name or ID...",value:A,onChange:s=>z(s.target.value),className:"pl-10"})]})}),l&&e.jsx(v,{className:l.isExempt?"bg-blue-50 border-blue-200":"bg-purple-50 border-purple-200",children:e.jsx(N,{className:"pt-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ee,{className:`h-5 w-5 mt-0.5 ${l.isExempt?"text-blue-600":"text-purple-600"}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:`font-semibold mb-1 ${l.isExempt?"text-blue-900":"text-purple-900"}`,children:l.isExempt?"Potential Exemption":"ROPA Required"}),e.jsx("p",{className:`text-sm mb-2 ${l.isExempt?"text-blue-800":"text-purple-800"}`,children:l.recommendation}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs",children:[e.jsxs(h,{variant:"outline",className:l.criteria.isSmallOrg?"bg-green-50":"bg-red-50",children:[l.criteria.employeeCount," employees"]}),e.jsx(h,{variant:"outline",className:l.criteria.isLowRisk?"bg-green-50":"bg-red-50",children:l.criteria.isLowRisk?"Low Risk":"High Risk"}),e.jsxs(h,{variant:"outline",className:l.criteria.isOccasional?"bg-green-50":"bg-red-50",children:[l.criteria.activityCount," activities"]})]})]})]})})}),d&&d.length>0&&e.jsx(v,{className:"bg-orange-50 border-orange-200",children:e.jsx(N,{className:"pt-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ce,{className:"h-5 w-5 mt-0.5 text-orange-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h3",{className:"font-semibold text-orange-900 mb-1",children:[d.length," ",d.length===1?"Activity":"Activities"," Overdue for Review"]}),e.jsx("p",{className:"text-sm text-orange-800 mb-2",children:"The following processing activities require review to maintain compliance:"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[d.slice(0,3).map(s=>e.jsx(h,{variant:"outline",className:"bg-white",children:s.activityName},s.id)),d.length>3&&e.jsxs(h,{variant:"outline",className:"bg-white",children:["+",d.length-3," more"]})]})]})]})})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(v,{children:[e.jsx(y,{className:"pb-2",children:e.jsx(S,{className:"text-sm font-medium text-muted-foreground",children:"Total Activities"})}),e.jsx(N,{children:e.jsx("div",{className:"text-2xl font-bold",children:(t==null?void 0:t.length)||0})})]}),e.jsxs(v,{children:[e.jsx(y,{className:"pb-2",children:e.jsx(S,{className:"text-sm font-medium text-muted-foreground",children:"Active"})}),e.jsx(N,{children:e.jsx("div",{className:"text-2xl font-bold text-green-600",children:(t==null?void 0:t.filter(s=>s.status==="active").length)||0})})]}),e.jsxs(v,{children:[e.jsx(y,{className:"pb-2",children:e.jsx(S,{className:"text-sm font-medium text-muted-foreground",children:"International Transfers"})}),e.jsx(N,{children:e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:(t==null?void 0:t.filter(s=>s.hasInternationalTransfers).length)||0})})]}),e.jsxs(v,{children:[e.jsx(y,{className:"pb-2",children:e.jsx(S,{className:"text-sm font-medium text-muted-foreground",children:"Special Categories"})}),e.jsx(N,{children:e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:(t==null?void 0:t.filter(s=>s.specialCategories&&s.specialCategories.length>0).length)||0})})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(se,{children:[e.jsx(ae,{children:e.jsxs(w,{children:[e.jsx(f,{children:"Activity Name"}),e.jsx(f,{children:"Reference ID"}),e.jsx(f,{children:"Role"}),e.jsx(f,{children:"Status"}),e.jsx(f,{className:"hidden md:table-cell",children:"Description"}),e.jsx(f,{className:"text-right",children:"Actions"})]})}),e.jsx(te,{children:J?e.jsx(w,{children:e.jsx(o,{colSpan:6,className:"text-center py-8",children:"Loading activities..."})}):(p==null?void 0:p.length)===0?e.jsx(w,{children:e.jsx(o,{colSpan:6,className:"text-center py-8 text-muted-foreground",children:"No processing activities found. Create your first one!"})}):p==null?void 0:p.map(s=>e.jsxs(w,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>$(s),children:[e.jsx(o,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4 text-blue-500"}),s.activityName]})}),e.jsx(o,{children:s.activityId}),e.jsx(o,{children:e.jsx(h,{variant:"outline",className:"capitalize",children:s.role.replace("_"," ")})}),e.jsx(o,{children:e.jsx(h,{className:Y(s.status||"draft"),children:s.status||"draft"})}),e.jsx(o,{className:"hidden md:table-cell max-w-[200px] truncate text-muted-foreground",children:s.description||"-"}),e.jsx(o,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-1",children:[e.jsx(b,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:i=>{i.stopPropagation(),$(s)},children:e.jsx(ye,{className:"h-4 w-4"})}),e.jsx(b,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-600 hover:bg-red-50",onClick:i=>{i.stopPropagation(),W(s.id)},children:e.jsx(Se,{className:"h-4 w-4"})})]})})]},s.id))})]})}),e.jsx(re,{open:G,onOpenChange:u,children:e.jsxs(le,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ce,{children:e.jsxs(ne,{children:[I?"Edit":"New"," Processing Activity"]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"activityName",children:"Activity Name *"}),e.jsx(x,{id:"activityName",value:a.activityName,onChange:s=>r({...a,activityName:s.target.value}),placeholder:"e.g., Customer Data Processing"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"activityId",children:"Activity ID *"}),e.jsx(x,{id:"activityId",value:a.activityId,onChange:s=>r({...a,activityId:s.target.value}),placeholder:"e.g., ROPA-001"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"description",children:"Description"}),e.jsx(de,{id:"description",value:a.description,onChange:s=>r({...a,description:s.target.value}),placeholder:"Describe the processing activity...",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"role",children:"Role *"}),e.jsxs(E,{value:a.role,onValueChange:s=>r({...a,role:s}),children:[e.jsx(F,{children:e.jsx(k,{})}),e.jsxs(B,{children:[e.jsx(c,{value:"controller",children:"Controller"}),e.jsx(c,{value:"processor",children:"Processor"}),e.jsx(c,{value:"joint_controller",children:"Joint Controller"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"status",children:"Status"}),e.jsxs(E,{value:a.status,onValueChange:s=>r({...a,status:s}),children:[e.jsx(F,{children:e.jsx(k,{})}),e.jsxs(B,{children:[e.jsx(c,{value:"draft",children:"Draft"}),e.jsx(c,{value:"active",children:"Active"}),e.jsx(c,{value:"archived",children:"Archived"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"legalBasis",children:"Legal Basis *"}),e.jsxs(E,{value:a.legalBasis,onValueChange:s=>r({...a,legalBasis:s}),children:[e.jsx(F,{children:e.jsx(k,{})}),e.jsxs(B,{children:[e.jsx(c,{value:"consent",children:"Consent"}),e.jsx(c,{value:"contract",children:"Contract"}),e.jsx(c,{value:"legal_obligation",children:"Legal Obligation"}),e.jsx(c,{value:"vital_interests",children:"Vital Interests"}),e.jsx(c,{value:"public_task",children:"Public Task"}),e.jsx(c,{value:"legitimate_interests",children:"Legitimate Interests"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"purposes",children:"Purposes * (comma-separated)"}),e.jsx(x,{id:"purposes",value:a.purposes,onChange:s=>r({...a,purposes:s.target.value}),placeholder:"e.g., Service Delivery, Customer Support"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"dataCategories",children:"Data Categories * (comma-separated)"}),e.jsx(x,{id:"dataCategories",value:a.dataCategories,onChange:s=>r({...a,dataCategories:s.target.value}),placeholder:"e.g., name, email, phone"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"dataSubjectCategories",children:"Data Subject Categories * (comma-separated)"}),e.jsx(x,{id:"dataSubjectCategories",value:a.dataSubjectCategories,onChange:s=>r({...a,dataSubjectCategories:s.target.value}),placeholder:"e.g., customers, employees"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"recipients",children:"Recipients * (comma-separated)"}),e.jsx(x,{id:"recipients",value:a.recipients,onChange:s=>r({...a,recipients:s.target.value}),placeholder:"e.g., Sales Team, Marketing Department"})]})]}),e.jsxs(oe,{children:[e.jsx(b,{variant:"outline",onClick:()=>u(!1),children:"Cancel"}),e.jsx(b,{onClick:U,disabled:T.isPending||R.isPending||!a.activityName||!a.activityId,children:T.isPending||R.isPending?"Saving...":I?"Save Changes":"Create Activity"})]})]})}),e.jsx(me,{open:K,onOpenChange:P,children:e.jsxs(xe,{children:[e.jsxs(he,{children:[e.jsx(ue,{children:"Are you absolutely sure?"}),e.jsx(pe,{children:"This action cannot be undone. This will permanently delete the processing activity record."})]}),e.jsxs(ge,{children:[e.jsx(je,{children:"Cancel"}),e.jsx(ve,{onClick:X,className:"bg-red-600 hover:bg-red-700",children:V.isPending?"Deleting...":"Delete"})]})]})})]})}export{He as default};
