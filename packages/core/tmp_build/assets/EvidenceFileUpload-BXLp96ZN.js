import{M as ce,j as s,r as u,t as b,i as p,D as de,o as me,p as ue,q as pe,s as xe,I as he,x as H,c as A,C as J,m as K,z as ge}from"./index-DOc7Nwb7.js";import{S as fe}from"./scroll-area-DPaNxEJD.js";import{S as je}from"./search-CwuIBBPE.js";import{U as Ne}from"./upload-BBmUECj8.js";import{C as ve}from"./circle-check-C5kiwRoG.js";import{D as we}from"./download-ByfWg1Mi.js";import{T as ye}from"./trash-2-CFEfisbM.js";/**
 * @license lucide-react v0.364.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=ce("File",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]]),W=["image/png","image/jpeg","image/gif","image/webp","application/pdf","text/plain","text/csv","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/json","application/zip"],Fe=10*1024*1024,Se=100*1024*1024;function Ue({evidenceId:o,clientId:F}){if(!o||!F)return console.warn("EvidenceFileUpload: Missing props",{evidenceId:o,clientId:F}),s.jsx("div",{className:"p-4 text-red-500 text-sm",children:"Error: Unable to load file uploader. Missing context."});console.log("EvidenceFileUpload mounted with:",{evidenceId:o,clientId:F});const[X,k]=u.useState(!1),[U,$]=u.useState(!1),[T,V]=u.useState(""),[Y,E]=u.useState(null),[x,i]=u.useState([]),S=u.useRef(null),{data:h,refetch:C}=b.evidenceFiles.list.useQuery({evidenceId:o}),{data:d}=b.evidenceFiles.listAll.useQuery({clientId:F,search:T},{enabled:U}),P=b.evidenceFiles.linkExisting.useMutation({onSuccess:()=>{p.success("File linked successfully"),E(null),$(!1),C()},onError:e=>{p.error(e.message),E(null)}}),G=e=>{E(e.id),P.mutate({targetEvidenceId:o,sourceFileId:e.id})},ee=b.evidenceFiles.create.useMutation({onSuccess:()=>{C()},onError:e=>p.error(e.message)}),se=b.evidenceFiles.delete.useMutation({onSuccess:()=>{p.success("File deleted"),C()},onError:e=>p.error(e.message)}),te=e=>{const a=[],g=[];let f=0;for(const t of e){if(!W.includes(t.type)){a.push(`${t.name}: File type not allowed`);continue}if(t.size>Fe){a.push(`${t.name}: File too large (max 10MB)`);continue}f+=t.size,g.push(t)}return f>Se?(a.push("Total file size exceeds 100MB limit"),{valid:[],errors:a}):{valid:g,errors:a}},O=async e=>{const{valid:a,errors:g}=te(e);if(g.length>0&&(g.forEach(t=>p.error(t)),a.length===0))return;const f=a.map((t,r)=>({id:`${Date.now()}-${r}`,name:t.name,size:t.size,progress:0,status:"uploading"}));i(f);for(let t=0;t<a.length;t++){const r=a[t],m=f[t];try{const j=new FileReader;await new Promise((ne,q)=>{j.onload=async()=>{try{const N=j.result.split(",")[1],c=Date.now(),v=Math.random().toString(36).substring(2,8),ie=r.name.split(".").pop()||"",Q=`evidence-${o}-${c}-${v}.${ie}`;i(w=>w.map(n=>n.id===m.id?{...n,progress:30}:n));const Z=await fetch("/api/upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:Q,data:N,contentType:r.type,folder:"evidence"})});if(!Z.ok)throw new Error("Upload failed");const{key:oe,url:le}=await Z.json();i(w=>w.map(n=>n.id===m.id?{...n,progress:70}:n)),await new Promise((w,n)=>{ee.mutate({evidenceId:o,filename:Q,originalFilename:r.name,mimeType:r.type,size:r.size,fileKey:oe,url:le},{onSuccess:()=>{i(D=>D.map(y=>y.id===m.id?{...y,progress:100,status:"success"}:y)),w()},onError:D=>{i(y=>y.map(L=>L.id===m.id?{...L,status:"error",error:D.message}:L)),n(D)}})}),ne()}catch(l){const N=l instanceof Error?l.message:"Upload failed";i(c=>c.map(v=>v.id===m.id?{...v,status:"error",error:N}:v)),q(l)}},j.onerror=()=>{const l="Failed to read file";i(N=>N.map(c=>c.id===m.id?{...c,status:"error",error:l}:c)),q(new Error(l))},j.readAsDataURL(r)})}catch{}}setTimeout(()=>{i(t=>t.filter(r=>r.status!=="success"))},2e3),S.current&&(S.current.value="")},ae=async e=>{const a=Array.from(e.target.files||[]);a.length!==0&&await O(a)},M=e=>{e.preventDefault(),e.stopPropagation(),e.type==="dragenter"||e.type==="dragover"?k(!0):e.type==="dragleave"&&k(!1)},re=async e=>{e.preventDefault(),e.stopPropagation(),k(!1);const a=Array.from(e.dataTransfer.files||[]);a.length!==0&&await O(a)},z=e=>e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`,B=e=>e.startsWith("image/")?"ðŸ–¼ï¸":e==="application/pdf"?"ðŸ“„":e.includes("spreadsheet")||e.includes("excel")?"ðŸ“Š":e.includes("word")||e.includes("document")?"ðŸ“":"ðŸ“Ž",I=x.length>0,_=x.filter(e=>e.status==="success").length,R=x.filter(e=>e.status==="error").length;return s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between hidden",children:[s.jsx("h4",{className:"text-sm font-medium",children:"Attached Files"}),s.jsx("div",{children:s.jsx("input",{id:"evidence-upload-input",ref:S,type:"file",className:"hidden",onChange:ae,accept:W.join(","),multiple:!0})})]}),s.jsx(de,{open:U,onOpenChange:$,children:s.jsxs(me,{className:"sm:max-w-[600px] max-h-[80vh] flex flex-col",children:[s.jsxs(ue,{children:[s.jsx(pe,{children:"Select from Evidence Library"}),s.jsx(xe,{children:"Choose an existing file to link to this request."})]}),s.jsx("div",{className:"py-2",children:s.jsxs("div",{className:"relative",children:[s.jsx(je,{className:"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"}),s.jsx(he,{placeholder:"Search files...",value:T,onChange:e=>V(e.target.value),className:"pl-8"})]})}),s.jsx(fe,{className:"flex-1 min-h-[300px] border rounded-md p-2",children:s.jsxs("div",{className:"space-y-2",children:[d==null?void 0:d.map(e=>s.jsxs("div",{className:"flex items-center justify-between p-2 hover:bg-muted rounded-lg cursor-pointer border border-transparent hover:border-border transition-colors group",onClick:()=>G(e),children:[s.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[s.jsx("span",{className:"text-xl",children:B(e.contentType||"application/octet-stream")}),s.jsxs("div",{className:"min-w-0 text-left",children:[s.jsx("p",{className:"text-sm font-medium truncate",children:e.filename}),s.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:[z(e.fileSize||0)," â€¢ ",e.evidenceTitle||"Uncategorized"," â€¢ ",new Date(e.createdAt).toLocaleDateString()]})]})]}),P.isLoading&&Y===e.id?s.jsx(H,{className:"h-4 w-4 animate-spin text-blue-600"}):s.jsx(A,{size:"sm",variant:"ghost",className:"opacity-0 group-hover:opacity-100",children:"Select"})]},e.id)),(d==null?void 0:d.length)===0&&s.jsx("div",{className:"text-center py-8 text-muted-foreground text-sm",children:"No files found matching your search."})]})})]})}),s.jsxs("div",{onDragEnter:M,onDragLeave:M,onDragOver:M,onDrop:re,className:`border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer ${X?"border-primary bg-primary/5":"border-muted-foreground/25 hover:border-muted-foreground/50"}`,onClick:()=>{var e;return(e=S.current)==null?void 0:e.click()},children:[s.jsx(Ne,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),s.jsx("p",{className:"text-sm font-medium",children:"Drag and drop files here"}),s.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"or click to select files (max 10MB each, 100MB total)"}),s.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Supported: Images, PDFs, Documents, Spreadsheets, Logs, JSON, ZIP"})]}),I&&s.jsx(J,{className:"border-blue-200 bg-blue-50",children:s.jsx(K,{className:"p-4",children:s.jsxs("div",{className:"space-y-3",children:[s.jsx("div",{className:"flex items-center justify-between",children:s.jsxs("p",{className:"text-sm font-medium",children:["Uploading ",x.filter(e=>e.status==="uploading").length," file(s)",_>0&&s.jsxs("span",{className:"text-green-600",children:[" â€¢ ",_," complete"]}),R>0&&s.jsxs("span",{className:"text-red-600",children:[" â€¢ ",R," failed"]})]})}),x.map(e=>s.jsxs("div",{className:"space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between text-sm",children:[s.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.status==="uploading"&&s.jsx(H,{className:"h-4 w-4 animate-spin text-blue-600 flex-shrink-0"}),e.status==="success"&&s.jsx(ve,{className:"h-4 w-4 text-green-600 flex-shrink-0"}),e.status==="error"&&s.jsx(ge,{className:"h-4 w-4 text-red-600 flex-shrink-0"}),s.jsx("span",{className:"truncate",children:e.name})]}),s.jsx("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:z(e.size)})]}),e.status==="uploading"&&s.jsx("div",{className:"w-full bg-gray-200 rounded-full h-1.5",children:s.jsx("div",{className:"bg-blue-600 h-1.5 rounded-full transition-all",style:{width:`${e.progress}%`}})}),e.status==="error"&&e.error&&s.jsx("p",{className:"text-xs text-red-600",children:e.error})]},e.id))]})})}),h&&h.length>0?s.jsxs("div",{className:"space-y-2",children:[s.jsxs("p",{className:"text-xs text-muted-foreground font-medium",children:[h.length," file",h.length!==1?"s":""," uploaded"]}),h.map(e=>s.jsx(J,{className:"bg-muted/50",children:s.jsx(K,{className:"p-3",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[s.jsx("span",{className:"text-xl",children:B(e.contentType||"application/octet-stream")}),s.jsxs("div",{className:"min-w-0",children:[s.jsx("p",{className:"text-sm font-medium truncate",children:e.filename}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:[z(e.size)," â€¢ ",new Date(e.createdAt).toLocaleDateString()]})]})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(A,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>window.open(e.fileUrl,"_blank"),title:"Download file",children:s.jsx(we,{className:"h-4 w-4"})}),s.jsx(A,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive",onClick:()=>se.mutate({id:e.id}),title:"Delete file",children:s.jsx(ye,{className:"h-4 w-4"})})]})]})})},e.id))]}):I?null:s.jsxs("div",{className:"text-center py-6 text-muted-foreground text-sm border border-dashed rounded-lg",children:[s.jsx(be,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),s.jsx("p",{children:"No files attached"}),s.jsx("p",{className:"text-xs",children:"Upload screenshots, logs, or documents to support this evidence"})]})]})}export{Ue as default};
