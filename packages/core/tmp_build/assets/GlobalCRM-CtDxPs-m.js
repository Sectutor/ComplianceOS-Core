import{b as ts,t as C,r as n,j as e,c as d,D as ce,ap as rs,o as de,p as me,q as he,s as ue,L as N,I as S,E as Z,G as X,H as Y,J as ee,K as m,N as ns,O as is,P as O,Q as v,v as xe,V as os,W as x,k as se,Z as pe,_ as ge,$ as je,a1 as k,C as cs,m as ds,i as o}from"./index-DOc7Nwb7.js";import{T as ms,a as hs,b as fe}from"./tabs-CBDTXbEn.js";import{T as us}from"./textarea-BtxBxzdY.js";import{A as Ce,a as Ne,b as ve,c as be,d as ye,e as we,f as Se,g as ke}from"./alert-dialog-V7xGXdVc.js";import{L as xs}from"./list-BZOuFwEg.js";import{L as ps}from"./layout-grid-CGqkIAJU.js";import{U as De}from"./upload-BBmUECj8.js";import{D as gs}from"./download-ByfWg1Mi.js";import{P as js}from"./plus-BaQ35Jcx.js";import{S as fs}from"./search-CwuIBBPE.js";import{T as Cs}from"./tag-CaMuQCYj.js";import{M as Ns}from"./mail-xRDvl6QK.js";import{P as vs}from"./phone-BFakwHvb.js";import{E as bs}from"./ellipsis-BXWwt8ER.js";import{S as ys}from"./square-pen-ClRv15cM.js";import{C as ws}from"./clock-osbacZli.js";import{T as Ae}from"./trash-2-CFEfisbM.js";import{G as Ss}from"./grip-vertical-CCl7NTKs.js";import{C as ks}from"./circle-check-C5kiwRoG.js";const Ds=[{key:"lead",label:"Leads",color:"bg-primary"},{key:"prospect",label:"Prospects",color:"bg-purple-500"},{key:"customer",label:"Customers",color:"bg-green-500"},{key:"churned",label:"Churned",color:"bg-red-500"}];function Js(){const[,ae]=ts(),{data:i,isLoading:Te,refetch:D}=C.globalCrm.list.useQuery(),Le=C.globalCrm.create.useMutation(),le=C.globalCrm.update.useMutation(),R=C.globalCrm.remove.useMutation(),Pe=C.globalCrm.importCsv.useMutation(),[A,Ee]=n.useState(""),[V,Ie]=n.useState("all"),[I,$e]=n.useState("table"),[Me,$]=n.useState(!1),[Fe,B]=n.useState(!1),[E,U]=n.useState(null),[z,te]=n.useState(null),[c,T]=n.useState([]),[Oe,G]=n.useState(!1),[g,re]=n.useState(null),[Re,H]=n.useState(!1),ne=n.useRef(null),Ve=C.globalCrm.bulkUpdateStatus.useMutation(),q=C.globalCrm.bulkDelete.useMutation(),{data:Q}=C.globalCrm.listAllTags.useQuery(),[_,Be]=n.useState("all"),[t,h]=n.useState({firstName:"",lastName:"",email:"",company:"",role:"",phone:"",status:"lead",notes:""}),ie=()=>{h({firstName:"",lastName:"",email:"",company:"",role:"",phone:"",status:"lead",notes:""})},Ue=async()=>{try{E?(await le.mutateAsync({id:E.id,...t}),o.success("Contact updated")):(await Le.mutateAsync(t),o.success("Contact created")),ie(),$(!1),U(null),D()}catch(s){o.error("Failed to save contact: "+s.message)}},ze=(s,a)=>{a.stopPropagation(),re(s),G(!0)},Ge=async s=>{if(s.preventDefault(),!!g)try{await R.mutateAsync({id:g.id}),o.success("Contact deleted"),G(!1),re(null),D()}catch(a){console.error("Delete error:",a),o.error("Failed to delete: "+a.message)}},He=(s,a)=>{a.stopPropagation(),U(s),h({firstName:s.firstName||"",lastName:s.lastName||"",email:s.email||"",company:s.company||"",role:s.role||"",phone:s.phone||"",status:s.status||"lead",notes:s.notes||""}),$(!0)},oe=s=>{ae(`/admin/crm/${s}`)},qe=s=>{T(a=>a.includes(s)?a.filter(l=>l!==s):[...a,s])},Qe=s=>{T(s?j.map(a=>a.id):[])},M=async s=>{if(c.length!==0)try{await Ve.mutateAsync({ids:c,status:s}),o.success(`Updated ${c.length} contacts`),T([]),D()}catch{o.error("Bulk update failed")}},_e=()=>{c.length!==0&&H(!0)},Je=async s=>{s.preventDefault();try{await q.mutateAsync({ids:c}),o.success(`Deleted ${c.length} contacts`),T([]),H(!1),D()}catch{o.error("Bulk delete failed")}},J=(s,a,l)=>{l.stopPropagation(),a==="email"?window.location.href=`mailto:${s.email}`:a==="call"?window.location.href=`tel:${s.phone||""}`:a==="task"&&ae(`/admin/crm/${s.id}?action=add_task`)},Ke=()=>{if(!(i!=null&&i.length))return;const s=["First Name","Last Name","Email","Company","Role","Phone","Status","Source","Notes"],a=i.map(r=>[r.firstName||"",r.lastName||"",r.email,r.company||"",r.role||"",r.phone||"",r.status||"",r.source||"",r.notes||""]),l=[s,...a].map(r=>r.map(b=>`"${b}"`).join(",")).join(`
`),L=new Blob([l],{type:"text/csv"}),P=URL.createObjectURL(L),p=document.createElement("a");p.href=P,p.download=`global-crm-contacts-${new Date().toISOString().split("T")[0]}.csv`,p.click()},We=async s=>{var L;const a=(L=s.target.files)==null?void 0:L[0];if(!a)return;const l=new FileReader;l.onload=async P=>{var p;try{const b=((p=P.target)==null?void 0:p.result).split(`
`).filter(y=>y.trim()),W=b[0].split(",").map(y=>y.trim().toLowerCase().replace(/['"]/g,"")),ss=b.slice(1).map(y=>{const as=(y.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[]).map(u=>u.replace(/^["']|["']$/g,"").trim()),f={};return W.forEach((u,ls)=>{const w=as[ls]||"";u.includes("first")?f.firstName=w:u.includes("last")?f.lastName=w:u.includes("email")?f.email=w:u.includes("company")?f.company=w:u.includes("role")||u.includes("title")?f.role=w:u.includes("phone")?f.phone=w:u.includes("status")&&(f.status=w)}),f}).filter(y=>y.email),F=await Pe.mutateAsync({contacts:ss});o.success(`Imported ${F.imported} contacts, skipped ${F.skipped} duplicates`),F.errors.length>0&&console.error("Import errors:",F.errors),B(!1),D()}catch(r){o.error("Failed to import: "+r.message)}},l.readAsText(a),s.target.value=""},Ze=s=>{te(s)},Xe=s=>{s.preventDefault()},Ye=async s=>{if(!(!z||z.status===s)){try{await le.mutateAsync({id:z.id,status:s}),o.success(`Moved to ${s}`),D()}catch{o.error("Failed to update stage")}te(null)}},j=(i==null?void 0:i.filter(s=>{var P,p,r,b;const a=A===""||s.email.toLowerCase().includes(A.toLowerCase())||(((P=s.firstName)==null?void 0:P.toLowerCase())||"").includes(A.toLowerCase())||(((p=s.lastName)==null?void 0:p.toLowerCase())||"").includes(A.toLowerCase())||(((r=s.company)==null?void 0:r.toLowerCase())||"").includes(A.toLowerCase()),l=V==="all"||s.status===V,L=_==="all"||((b=s.tags)==null?void 0:b.some(W=>W.id===_));return a&&l&&L}))||[],es=s=>{const a={lead:"bg-primary/20 text-primary border-primary/30",prospect:"bg-purple-500/20 text-purple-400 border-purple-500/30",customer:"bg-green-500/20 text-green-400 border-green-500/30",churned:"bg-red-500/20 text-red-400 border-red-500/30"};return e.jsx(se,{className:`${a[s||"lead"]||"bg-gray-500/20"} uppercase text-xs`,children:s||"lead"})},K=s=>j.filter(a=>(a.status||"lead")===s);return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Global CRM"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage platform-wide contacts and sales leads"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ms,{value:I,onValueChange:s=>$e(s),children:e.jsxs(hs,{children:[e.jsxs(fe,{value:"table",children:[e.jsx(xs,{className:"h-4 w-4 mr-1"})," Table"]}),e.jsxs(fe,{value:"pipeline",children:[e.jsx(ps,{className:"h-4 w-4 mr-1"})," Pipeline"]})]})}),e.jsxs(d,{variant:"outline",onClick:()=>B(!0),children:[e.jsx(De,{className:"mr-2 h-4 w-4"}),"Import"]}),e.jsxs(d,{variant:"outline",onClick:Ke,disabled:!(i!=null&&i.length),children:[e.jsx(gs,{className:"mr-2 h-4 w-4"}),"Export"]}),e.jsxs(ce,{open:Me,onOpenChange:s=>{$(s),s||(U(null),ie())},children:[e.jsx(rs,{asChild:!0,children:e.jsxs(d,{children:[e.jsx(js,{className:"mr-2 h-4 w-4"}),"Add Contact"]})}),e.jsxs(de,{className:"max-w-md",children:[e.jsxs(me,{children:[e.jsx(he,{children:E?"Edit Contact":"Add New Contact"}),e.jsx(ue,{children:E?"Update the contact information below.":"Fill in the details to create a new contact."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{children:"First Name"}),e.jsx(S,{value:t.firstName,onChange:s=>h({...t,firstName:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Last Name"}),e.jsx(S,{value:t.lastName,onChange:s=>h({...t,lastName:s.target.value})})]})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Email *"}),e.jsx(S,{type:"email",value:t.email,onChange:s=>h({...t,email:s.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Company"}),e.jsx(S,{value:t.company,onChange:s=>h({...t,company:s.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{children:"Role"}),e.jsx(S,{value:t.role,onChange:s=>h({...t,role:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Phone"}),e.jsx(S,{value:t.phone,onChange:s=>h({...t,phone:s.target.value})})]})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Status"}),e.jsxs(Z,{value:t.status,onValueChange:s=>h({...t,status:s}),children:[e.jsx(X,{children:e.jsx(Y,{})}),e.jsxs(ee,{children:[e.jsx(m,{value:"lead",children:"Lead"}),e.jsx(m,{value:"prospect",children:"Prospect"}),e.jsx(m,{value:"customer",children:"Customer"}),e.jsx(m,{value:"churned",children:"Churned"})]})]})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Notes"}),e.jsx(us,{value:t.notes,onChange:s=>h({...t,notes:s.target.value}),rows:3})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>$(!1),children:"Cancel"}),e.jsx(d,{onClick:Ue,disabled:!t.email,children:E?"Save Changes":"Create Contact"})]})]})]})]})]}),e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(fs,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(S,{placeholder:"Search contacts...",value:A,onChange:s=>Ee(s.target.value),className:"pl-10"})]}),I==="table"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Z,{value:V,onValueChange:Ie,children:[e.jsx(X,{className:"w-40",children:e.jsx(Y,{placeholder:"Filter by status"})}),e.jsxs(ee,{children:[e.jsx(m,{value:"all",children:"All Statuses"}),e.jsx(m,{value:"lead",children:"Lead"}),e.jsx(m,{value:"prospect",children:"Prospect"}),e.jsx(m,{value:"customer",children:"Customer"}),e.jsx(m,{value:"churned",children:"Churned"})]})]}),e.jsxs(Z,{value:_.toString(),onValueChange:s=>Be(s==="all"?"all":parseInt(s)),children:[e.jsx(X,{className:"w-44",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Cs,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(Y,{placeholder:"Filter by tag"})]})}),e.jsxs(ee,{children:[e.jsx(m,{value:"all",children:"All Tags"}),Q==null?void 0:Q.map(s=>e.jsx(m,{value:s.id.toString(),children:s.name},s.id))]})]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[j.length," contact",j.length!==1?"s":""]})]}),I==="table"&&e.jsx("div",{className:"border rounded-lg",children:e.jsxs(ns,{children:[e.jsx(is,{children:e.jsxs(O,{children:[e.jsx(v,{className:"w-10",children:e.jsx(xe,{checked:c.length===j.length&&j.length>0,onCheckedChange:s=>Qe(!!s)})}),e.jsx(v,{children:"Name"}),e.jsx(v,{children:"Email"}),e.jsx(v,{children:"Company"}),e.jsx(v,{children:"Tags"}),e.jsx(v,{children:"Status"}),e.jsx(v,{children:"Date Added"}),e.jsx(v,{className:"text-right",children:"Actions"})]})}),e.jsx(os,{children:Te?e.jsx(O,{children:e.jsx(x,{colSpan:7,className:"text-center py-8 text-muted-foreground",children:"Loading contacts..."})}):j.length===0?e.jsx(O,{children:e.jsx(x,{colSpan:7,className:"text-center py-8 text-muted-foreground",children:(i==null?void 0:i.length)===0?"No contacts yet. Add one to get started!":"No matching contacts found."})}):j.map(s=>{var a;return e.jsxs(O,{className:`cursor-pointer hover:bg-muted/50 ${c.includes(s.id)?"bg-muted/40":""}`,onClick:()=>oe(s.id),children:[e.jsx(x,{onClick:l=>l.stopPropagation(),children:e.jsx(xe,{checked:c.includes(s.id),onCheckedChange:()=>qe(s.id)})}),e.jsx(x,{className:"font-medium",children:s.firstName||s.lastName?`${s.firstName||""} ${s.lastName||""}`.trim():"—"}),e.jsx(x,{children:s.email}),e.jsx(x,{children:s.company||"—"}),e.jsx(x,{children:e.jsxs("div",{className:"flex flex-wrap gap-1 max-w-[150px]",children:[(a=s.tags)==null?void 0:a.map(l=>e.jsx(se,{variant:"outline",className:"px-1.5 py-0 text-[10px] bg-primary/5 text-primary border-primary/20",children:l.name},l.id)),(!s.tags||s.tags.length===0)&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"—"})]})}),e.jsx(x,{children:es(s.status)}),e.jsx(x,{children:s.createdAt?new Date(s.createdAt).toLocaleDateString():"—"}),e.jsx(x,{className:"text-right",children:e.jsxs("div",{className:"flex gap-1 justify-end",children:[e.jsx(d,{variant:"ghost",size:"sm",onClick:l=>J(s,"email",l),title:"Send Email",className:"h-8 w-8 p-0",children:e.jsx(Ns,{className:"h-4 w-4"})}),e.jsx(d,{variant:"ghost",size:"sm",onClick:l=>J(s,"call",l),title:"Call",className:"h-8 w-8 p-0",children:e.jsx(vs,{className:"h-4 w-4"})}),e.jsxs(pe,{children:[e.jsx(ge,{asChild:!0,children:e.jsx(d,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",children:e.jsx(bs,{className:"h-4 w-4"})})}),e.jsxs(je,{align:"end",children:[e.jsxs(k,{onClick:l=>He(s,l),children:[e.jsx(ys,{className:"mr-2 h-4 w-4"})," Edit"]}),e.jsxs(k,{onClick:l=>J(s,"task",l),children:[e.jsx(ws,{className:"mr-2 h-4 w-4"})," Log Task"]}),e.jsxs(k,{onSelect:l=>ze(s,l),className:"text-destructive",children:[e.jsx(Ae,{className:"mr-2 h-4 w-4"})," Delete"]})]})]})]})})]},s.id)})})]})}),I==="pipeline"&&e.jsx("div",{className:"grid grid-cols-4 gap-4",children:Ds.map(s=>e.jsxs("div",{className:"space-y-3",onDragOver:Xe,onDrop:()=>Ye(s.key),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`h-3 w-3 rounded-full ${s.color}`}),e.jsx("h3",{className:"font-semibold",children:s.label}),e.jsx(se,{variant:"secondary",className:"ml-auto",children:K(s.key).length})]}),e.jsxs("div",{className:"space-y-2 min-h-[200px] bg-muted/30 rounded-lg p-2",children:[K(s.key).map(a=>e.jsx(cs,{draggable:!0,onDragStart:()=>Ze(a),className:"cursor-grab active:cursor-grabbing hover:shadow-md transition-shadow",onClick:()=>oe(a.id),children:e.jsx(ds,{className:"p-3",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Ss,{className:"h-4 w-4 text-muted-foreground mt-0.5 shrink-0"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"font-medium truncate",children:a.firstName||a.lastName?`${a.firstName||""} ${a.lastName||""}`.trim():a.email}),a.company&&e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:a.company}),e.jsx("p",{className:"text-xs text-muted-foreground truncate mt-1",children:a.email})]})]})})},a.id)),K(s.key).length===0&&e.jsxs("div",{className:"text-center text-muted-foreground text-sm py-8",children:["No ",s.label.toLowerCase()]})]})]},s.key))}),e.jsx(ce,{open:Fe,onOpenChange:B,children:e.jsxs(de,{children:[e.jsxs(me,{children:[e.jsx(he,{children:"Import Contacts from CSV"}),e.jsx(ue,{children:"Upload a CSV file to bulk import contacts into the CRM."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upload a CSV file with columns: First Name, Last Name, Email, Company, Role, Phone, Status"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx("strong",{children:"Required:"})," Email column",e.jsx("br",{}),"Duplicate emails will be skipped."]}),e.jsx("input",{ref:ne,type:"file",accept:".csv",onChange:We,className:"hidden"}),e.jsxs(d,{onClick:()=>{var s;return(s=ne.current)==null?void 0:s.click()},className:"w-full",children:[e.jsx(De,{className:"mr-2 h-4 w-4"}),"Select CSV File"]})]})]})}),c.length>0&&e.jsxs("div",{className:"fixed bottom-8 left-1/2 -translate-x-1/2 bg-popover border shadow-2xl rounded-full px-6 py-3 flex items-center gap-6 animate-in slide-in-from-bottom-4 duration-300 z-50",children:[e.jsxs("div",{className:"flex items-center gap-2 border-r pr-6",children:[e.jsx("span",{className:"bg-primary text-primary-foreground h-6 w-6 rounded-full flex items-center justify-center text-xs font-bold",children:c.length}),e.jsx("span",{className:"text-sm font-medium",children:"Selected"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(pe,{children:[e.jsx(ge,{asChild:!0,children:e.jsxs(d,{variant:"ghost",size:"sm",className:"h-9 px-3 gap-2",children:[e.jsx(ks,{className:"h-4 w-4"}),"Change Status"]})}),e.jsxs(je,{children:[e.jsx(k,{onClick:()=>M("lead"),children:"Lead"}),e.jsx(k,{onClick:()=>M("prospect"),children:"Prospect"}),e.jsx(k,{onClick:()=>M("customer"),children:"Customer"}),e.jsx(k,{onClick:()=>M("churned"),children:"Churned"})]})]}),e.jsxs(d,{variant:"ghost",size:"sm",className:"h-9 px-3 gap-2 text-destructive hover:text-destructive",onClick:_e,children:[e.jsx(Ae,{className:"h-4 w-4"}),"Delete"]}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-9 px-3",onClick:()=>T([]),children:"Cancel"})]})]}),e.jsx(Ce,{open:Oe,onOpenChange:G,children:e.jsxs(Ne,{children:[e.jsxs(ve,{children:[e.jsx(be,{children:"Delete Contact?"}),e.jsxs(ye,{children:["Are you sure you want to delete ",e.jsxs("strong",{children:[g==null?void 0:g.firstName," ",g==null?void 0:g.lastName]}),"? This action cannot be undone."]})]}),e.jsxs(we,{children:[e.jsx(Se,{children:"Cancel"}),e.jsx(ke,{onClick:Ge,className:"bg-red-600 hover:bg-red-700",disabled:R.isPending,children:R.isPending?"Deleting...":"Delete"})]})]})}),e.jsx(Ce,{open:Re,onOpenChange:H,children:e.jsxs(Ne,{children:[e.jsxs(ve,{children:[e.jsx(be,{children:"Delete Multiple Contacts?"}),e.jsxs(ye,{children:["Are you sure you want to delete ",e.jsx("strong",{children:c.length})," contacts? This action cannot be undone."]})]}),e.jsxs(we,{children:[e.jsx(Se,{children:"Cancel"}),e.jsx(ke,{onClick:Je,className:"bg-red-600 hover:bg-red-700",disabled:q.isPending,children:q.isPending?"Deleting...":"Delete All"})]})]})})]})}export{Js as default};
