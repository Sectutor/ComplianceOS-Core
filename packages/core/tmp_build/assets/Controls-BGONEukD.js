import{M as os,j as e,C as Se,d as Ae,e as De,m as Ie,N as Re,O as qe,P as O,Q as y,v as Te,V as Le,W as w,k as Q,X as Ue,Y as ze,S as $e,Z as Ve,_ as Be,c as j,$ as He,a0 as Qe,a1 as te,a2 as _e,I as D,a3 as q,a4 as Fe,a5 as cs,t as k,i as I,a6 as ds,a7 as ms,a8 as xs,a9 as hs,x as Ke,b as us,u as ps,r as x,L as N,E as $,G as V,H as B,J as H,K as g,A as gs,aa as js}from"./index-DOc7Nwb7.js";import{u as fs,D as Ns}from"./DashboardLayout-aHnUqq57.js";import{E as re}from"./enhanced-dialog-CeRPsI16.js";import{T as ne}from"./textarea-BtxBxzdY.js";import{B as vs}from"./Breadcrumb-CRi3LAxS.js";import{u as ws}from"./usePageHelp-TOp0nY4e.js";import{P as le}from"./progress-B-1k4ZZX.js";import{R as bs,l as ys,m as Me,T as Cs}from"./generateCategoricalChart-KNLgM3hn.js";import{P as ks,a as Ss}from"./PieChart-Lpe3cWE7.js";import{A as Pe}from"./arrow-up-right-BLuFLpps.js";import{A as As}from"./activity-B1F2IRm3.js";import{E as Ds}from"./ellipsis-BXWwt8ER.js";import{S as Is}from"./search-CwuIBBPE.js";import{S as Ts}from"./separator-BWuYil37.js";import{S as Fs}from"./scroll-area-DPaNxEJD.js";import{U as Ms}from"./user-CqRnJLgW.js";import{C as Ps}from"./calendar-BlLJlGbj.js";import{S as Es}from"./sparkles-CoQ80pK2.js";import{M as Os}from"./index-utl_XIpZ.js";import{S as Ee,a as Oe}from"./slotNames-XB2IFQPg.js";import{P as Gs}from"./PageGuide-CPKKXXS6.js";import{A as Rs,a as qs,b as Ls,c as Us,d as zs,e as $s,f as Vs,g as Bs}from"./alert-dialog-V7xGXdVc.js";import{A as Hs}from"./arrow-left-CpuUojG-.js";import{P as Qs}from"./plus-BaQ35Jcx.js";import{C as _s}from"./chevron-left-DZH-lUm7.js";import"./index--2vFva6Y.js";import"./filter-Ceo--4mb.js";import"./clipboard-check-CQkJX5J0.js";import"./send-FW7-3cjH.js";import"./settings-CIu9FFiX.js";import"./circle-check-C5kiwRoG.js";import"./en-US-Bfz1jvxT.js";import"./getTimezoneOffsetInMilliseconds-em2BGgN1.js";import"./rocket-C2MuHhsn.js";import"./scale-BCebIfgE.js";import"./layout-grid-CGqkIAJU.js";import"./book-open-BffBrdze.js";import"./zap-B01fFOkT.js";import"./star-BTvaCCU4.js";import"./briefcase-BxorFA78.js";import"./target-cfAj3L6j.js";import"./database-Bjtecw5f.js";import"./shield-check-ETs8j4-d.js";import"./shield-alert-iAruRy4W.js";import"./brain-C-Zi22rJ.js";import"./link-FmUqdGRG.js";import"./lock-czWF3qbC.js";import"./globe-BMGZmoaJ.js";import"./message-square-5hBo7zY3.js";import"./upload-BBmUECj8.js";import"./isEqual-D_xcZLCn.js";import"./PolarAngleAxis-BO8F-h7c.js";import"./info-By5wLOUH.js";/**
 * @license lucide-react v0.364.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ks=os("SlidersHorizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]);function Xs({assignmentStats:d,completionStats:i}){const c=d.unassigned+d.assigned+d.needsReassignment,o=c>0?Math.round(d.assigned/c*100):0,v=[{name:"Unassigned",value:d.unassigned,color:"#E2E8F0"},{name:"Assigned",value:d.assigned,color:"#8B5CF6"},{name:"Needs reassignment",value:d.needsReassignment,color:"#F97316"}].filter(r=>r.value>0);v.length===0&&v.push({name:"No Data",value:1,color:"#E2E8F0"});const t=i.total>0?Math.round(i.okCount/i.total*100):0,h=i.testTotal>0?Math.round(i.testPassed/i.testTotal*100):0,f=i.documentTotal>0?Math.round(i.documentAttached/i.documentTotal*100):0;return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8",children:[e.jsxs(Se,{className:"shadow-sm border-slate-200",children:[e.jsx(Ae,{className:"pb-2",children:e.jsx(De,{className:"text-lg font-semibold text-slate-800",children:"Assignment"})}),e.jsxs(Ie,{className:"flex items-center gap-8",children:[e.jsx("div",{className:"relative h-40 w-40 flex-shrink-0",children:e.jsx(bs,{width:"100%",height:"100%",children:e.jsxs(ks,{children:[e.jsxs(Ss,{data:v,cx:"50%",cy:"50%",innerRadius:55,outerRadius:75,paddingAngle:2,dataKey:"value",stroke:"none",children:[v.map((r,l)=>e.jsx(ys,{fill:r.color},`cell-${l}`)),e.jsx(Me,{value:`${o}%`,position:"center",className:"text-2xl font-bold fill-slate-900"}),e.jsx(Me,{value:"Assigned",position:"center",dy:20,className:"text-xs fill-slate-500 font-medium"})]}),e.jsx(Cs,{})]})})}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-sm bg-slate-200"}),e.jsx("span",{className:"text-slate-600",children:"Unassigned"})]}),e.jsx("span",{className:"font-semibold text-slate-900",children:d.unassigned})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-sm bg-violet-500"}),e.jsx("span",{className:"text-slate-600",children:"Assigned"})]}),e.jsx("span",{className:"font-semibold text-slate-900",children:d.assigned})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-sm bg-orange-500"}),e.jsx("span",{className:"text-slate-600",children:"Needs reassignment"})]}),e.jsx("span",{className:"font-semibold text-slate-900",children:d.needsReassignment})]})]})]})]}),e.jsxs(Se,{className:"shadow-sm border-slate-200",children:[e.jsx(Ae,{className:"pb-2",children:e.jsx(De,{className:"text-lg font-semibold text-slate-800",children:"Completion"})}),e.jsxs(Ie,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-end justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Controls OK"}),e.jsx("div",{className:"flex items-baseline gap-2",children:e.jsxs("h3",{className:"text-3xl font-bold text-slate-900",children:[t,"%"]})})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-slate-400 font-medium mb-1",children:"Total Controls"}),e.jsxs("span",{className:"text-lg font-semibold text-slate-900",children:[i.total," total"]})]})]}),e.jsx(le,{value:t,className:"h-2 bg-slate-100",indicatorClassName:"bg-slate-900"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2",children:[e.jsxs("div",{className:"bg-slate-50 rounded-lg p-3 border border-slate-100",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-xs font-semibold text-slate-700",children:"Test"}),e.jsx("a",{href:"#",className:"text-slate-400 hover:text-slate-600",children:e.jsx(Pe,{className:"h-3 w-3"})})]}),e.jsxs("div",{className:"flex justify-between items-end mb-1",children:[e.jsxs("span",{className:"text-xs text-slate-500",children:[i.testPassed,"/",i.testTotal]}),e.jsxs("span",{className:"text-xs font-bold text-slate-700",children:[h,"%"]})]}),e.jsx(le,{value:h,className:"h-1.5 bg-slate-200",indicatorClassName:"bg-green-500"})]}),e.jsxs("div",{className:"bg-slate-50 rounded-lg p-3 border border-slate-100",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-xs font-semibold text-slate-700",children:"Document"}),e.jsx("a",{href:"#",className:"text-slate-400 hover:text-slate-600",children:e.jsx(Pe,{className:"h-3 w-3"})})]}),e.jsxs("div",{className:"flex justify-between items-end mb-1",children:[e.jsxs("span",{className:"text-xs text-slate-500",children:[i.documentAttached,"/",i.documentTotal]}),e.jsxs("span",{className:"text-xs font-bold text-slate-700",children:[f,"%"]})]}),e.jsx(le,{value:f,className:"h-1.5 bg-slate-200",indicatorClassName:"bg-slate-400"})]})]})]})]})]})}function Ys({controls:d,selectedIds:i,onSelectChange:c,onEdit:o,onDelete:v,onViewDetails:t}){const h=()=>{i.length===d.length?c([]):c(d.map(r=>r.id))},f=r=>{i.includes(r)?c(i.filter(l=>l!==r)):c([...i,r])};return e.jsx("div",{className:"rounded-md border border-slate-200",children:e.jsxs(Re,{children:[e.jsx(qe,{className:"bg-slate-50",children:e.jsxs(O,{children:[e.jsx(y,{className:"w-[50px]",children:e.jsx(Te,{checked:d.length>0&&i.length===d.length,onCheckedChange:h})}),e.jsx(y,{className:"min-w-[400px]",children:"Control"}),e.jsx(y,{className:"w-[150px]",children:"Owner"}),e.jsx(y,{className:"w-[120px]",children:"Source"}),e.jsx(y,{className:"w-[100px]",children:"Tests"}),e.jsx(y,{className:"w-[100px]",children:"ID"}),e.jsx(y,{className:"w-[50px]"})]})}),e.jsx(Le,{children:d.length===0?e.jsx(O,{children:e.jsx(w,{colSpan:7,className:"h-24 text-center text-muted-foreground",children:"No controls found."})}):d.map(r=>e.jsxs(O,{className:"group hover:bg-slate-50/50 cursor-pointer",onClick:l=>{l.target.closest(".no-click-propagate")||t(r)},children:[e.jsx(w,{className:"no-click-propagate",children:e.jsx(Te,{checked:i.includes(r.id),onCheckedChange:()=>f(r.id)})}),e.jsx(w,{children:e.jsxs("div",{className:"flex flex-col gap-1 py-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"font-semibold text-slate-900 group-hover:text-primary transition-colors",children:[r.controlId," ",r.name]})}),e.jsx("span",{className:"text-sm text-slate-500 line-clamp-2",children:r.description}),e.jsx("div",{className:"flex flex-wrap gap-1.5 mt-1",children:(r.mappedFrameworks||[r.framework]).map(l=>e.jsx(Q,{variant:"secondary",className:"bg-sky-100 text-sky-700 hover:bg-sky-200 border-sky-200 text-[10px] font-semibold px-1.5 py-0 rounded-sm uppercase tracking-wide",children:l},l))})]})}),e.jsx(w,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ue,{className:"h-6 w-6",children:e.jsx(ze,{className:"text-[10px] bg-slate-100 text-slate-600",children:(r.owner||"U").substring(0,2).toUpperCase()})}),e.jsx("span",{className:`text-sm ${r.owner?"text-slate-700":"text-slate-400 italic"}`,children:r.owner||"Unassigned"})]})}),e.jsx(w,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"bg-slate-900 text-white p-1 rounded-sm",children:e.jsx($e,{className:"h-3 w-3"})}),e.jsx("span",{className:"text-sm font-medium text-slate-700",children:"OS"})]})}),e.jsx(w,{children:e.jsxs("div",{className:"flex items-center gap-2 text-slate-500",children:[e.jsx(As,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:"0/1"})]})}),e.jsx(w,{children:e.jsx("span",{className:"text-xs font-mono text-slate-500 bg-slate-100 px-2 py-1 rounded",children:r.controlId})}),e.jsx(w,{className:"no-click-propagate",children:e.jsxs(Ve,{children:[e.jsx(Be,{asChild:!0,children:e.jsx(j,{variant:"ghost",className:"h-8 w-8 p-0 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(Ds,{className:"h-4 w-4"})})}),e.jsxs(He,{align:"end",children:[e.jsx(Qe,{children:"Actions"}),e.jsx(te,{onClick:()=>t(r),children:"View Details"}),e.jsx(te,{onClick:()=>o(r),children:"Edit Control"}),e.jsx(_e,{}),e.jsx(te,{className:"text-red-600",onClick:()=>v(r.id),children:"Delete"})]})]})})]},r.id))})]})})}function Js({searchQuery:d,onSearchChange:i,filters:c,onFilterChange:o,availableFrameworks:v,availableOwners:t}){const h=(l,T)=>{const S=c[l],G=S.includes(T)?S.filter(L=>L!==T):[...S,T];o(l,G)},f=()=>{o("framework",[]),o("owner",[]),o("status",[]),o("risk",[])},r=Object.values(c).some(l=>l.length>0);return e.jsxs("div",{className:"flex flex-col space-y-4 mb-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 w-full",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px] max-w-sm",children:[e.jsx(Is,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-slate-400"}),e.jsx(D,{value:d,onChange:l=>i(l.target.value),placeholder:"Search controls",className:"pl-9 bg-white border-slate-200"})]}),e.jsx(Ge,{label:"Framework",count:c.framework.length,items:v,selected:c.framework,onToggle:l=>h("framework",l)}),e.jsx(Ge,{label:"Owner",count:c.owner.length,items:t,selected:c.owner,onToggle:l=>h("owner",l)}),e.jsxs(j,{variant:"ghost",size:"sm",className:"text-slate-600 gap-1 font-normal",children:["Domain ",e.jsx(q,{className:"h-3 w-3 opacity-50"})]}),e.jsxs(j,{variant:"ghost",size:"sm",className:"text-slate-600 gap-1 font-normal",children:["Source ",e.jsx(q,{className:"h-3 w-3 opacity-50"})]}),e.jsxs(j,{variant:"ghost",size:"sm",className:"text-slate-600 gap-1 font-normal",children:["Status ",e.jsx(q,{className:"h-3 w-3 opacity-50"})]}),e.jsxs(j,{variant:"ghost",size:"sm",className:"text-slate-600 gap-1 font-normal",children:["Risk ",e.jsx(q,{className:"h-3 w-3 opacity-50"})]}),r&&e.jsx(j,{variant:"ghost",size:"sm",onClick:f,className:"text-primary hover:text-primary/80 ml-auto font-medium",children:"Clear"}),e.jsx(j,{variant:"outline",size:"icon",className:"ml-auto bg-white",children:e.jsx(Ks,{className:"h-4 w-4 text-slate-600"})})]}),r&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[c.framework.map(l=>e.jsxs(Q,{variant:"secondary",className:"gap-1 bg-violet-50 text-violet-700 border-violet-100 hover:bg-violet-100",children:[l," ",e.jsx(Fe,{className:"h-3 w-3 cursor-pointer",onClick:()=>h("framework",l)})]},`fw-${l}`)),c.owner.map(l=>e.jsxs(Q,{variant:"secondary",className:"gap-1 bg-slate-100 text-slate-700 hover:bg-slate-200",children:["Owner: ",l," ",e.jsx(Fe,{className:"h-3 w-3 cursor-pointer",onClick:()=>h("owner",l)})]},`ow-${l}`))]})]})}function Ge({label:d,count:i,items:c,selected:o,onToggle:v}){return e.jsxs(Ve,{children:[e.jsx(Be,{asChild:!0,children:e.jsxs(j,{variant:i>0?"secondary":"ghost",size:"sm",className:`gap-1 font-normal ${i>0?"bg-violet-50 text-violet-700 hover:bg-violet-100 border border-dashed border-violet-300":"text-slate-600"}`,children:[d," ",i>0&&e.jsx("span",{className:"ml-1 bg-violet-200 text-violet-800 text-[10px] px-1.5 py-0.5 rounded-full",children:i}),e.jsx(q,{className:"h-3 w-3 opacity-50"})]})}),e.jsxs(He,{align:"start",className:"w-56",children:[e.jsxs(Qe,{children:["Filter by ",d]}),e.jsx(_e,{}),c.length===0?e.jsx("div",{className:"p-2 text-xs text-muted-foreground text-center",children:"No options available"}):c.map(t=>e.jsx(cs,{checked:o.includes(t),onCheckedChange:()=>v(t),onSelect:h=>h.preventDefault(),className:`cursor-pointer ${o.includes(t)?"bg-violet-50 text-violet-900 font-medium focus:bg-violet-100":""}`,children:t},t))]})]})}function Ws({open:d,onOpenChange:i,control:c}){const o=k.useUtils(),{data:v}=k.controls.get.useQuery({id:(c==null?void 0:c.id)||0},{enabled:!!(c!=null&&c.id)&&d,staleTime:0}),t=v||c,h=k.controls.generateGuidance.useMutation({onSuccess:()=>{I.success("Guidance generated successfully"),t!=null&&t.id&&o.controls.get.invalidate({id:t.id}),o.controls.list.invalidate(),o.controls.listPaginated.invalidate()},onError:r=>{I.error("Failed to generate guidance: "+r.message)}}),f=()=>{t&&h.mutate({controlId:t.id,framework:t.framework})};return t?e.jsx(ds,{open:d,onOpenChange:i,children:e.jsxs(ms,{className:"w-[500px] sm:w-[600px] sm:max-w-[700px] p-0 flex flex-col bg-white",children:[e.jsxs("div",{className:"p-6 pb-2 border-b border-slate-100 flex flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{variant:"outline",className:"bg-slate-50 text-slate-700 font-normal",children:t.framework}),e.jsx("span",{className:"text-xs text-slate-400 font-mono",children:t.controlId})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(Ue,{className:"h-8 w-8",children:e.jsx(ze,{className:"text-xs bg-slate-100 text-slate-600",children:(t.owner||"U").substring(0,2).toUpperCase()})})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(xs,{className:"text-xl font-bold leading-tight",children:t.name}),e.jsx(hs,{className:"text-sm text-slate-500 line-clamp-3",children:t.description})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-slate-500",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($e,{className:"h-3 w-3"}),"Source: ComplianceOS"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ms,{className:"h-3 w-3"}),"Owner: ",t.owner||"Unassigned"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ps,{className:"h-3 w-3"}),"Updated: Today"]})]})]}),e.jsx(Fs,{className:"flex-1 p-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-900 mb-3 flex items-center gap-2",children:"Description"}),e.jsx("div",{className:"text-sm text-slate-600 leading-relaxed",children:t.description||"No description provided."})]}),e.jsx(Ts,{}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-900 flex items-center gap-2",children:"Implementation Guidance"}),!t.implementationGuidance&&e.jsxs(j,{variant:"outline",size:"sm",className:"h-7 text-xs gap-1.5 text-indigo-600 border-indigo-200 hover:bg-indigo-50",onClick:f,disabled:h.isPending,children:[h.isPending?e.jsx(Ke,{className:"h-3 w-3 animate-spin"}):e.jsx(Es,{className:"h-3 w-3"}),h.isPending?"Generating...":"Generate with AI"]})]}),e.jsx("div",{className:"bg-slate-50 rounded-lg p-4 border border-slate-100",children:t.implementationGuidance?e.jsx("div",{className:"text-sm text-slate-600 prose prose-sm max-w-none prose-p:my-1 prose-ul:my-1 prose-li:my-0 [&>ul]:list-disc [&>ul]:pl-4 [&>ol]:list-decimal [&>ol]:pl-4",children:e.jsx(Os,{children:t.implementationGuidance})}):e.jsxs("div",{className:"text-center py-6",children:[e.jsx("p",{className:"text-sm text-slate-500 mb-2",children:"No guidance available."}),e.jsx("p",{className:"text-xs text-slate-400",children:"Generate guidance to get started."})]})})]})]})})]})}):null}function Za(){var me,xe,he,ue,pe,ge,je,fe,Ne,ve,we,be,ye;const[,d]=us(),o=(()=>{const[s,n]=x.useState(window.location.search);return x.useEffect(()=>{const a=()=>n(window.location.search);window.addEventListener("popstate",a);const A=window.history.pushState,R=window.history.replaceState;return window.history.pushState=function(...P){const E=A.apply(this,P);return a(),E},window.history.replaceState=function(...P){const E=R.apply(this,P);return a(),E},()=>{window.history.pushState=A,window.history.replaceState=R,window.removeEventListener("popstate",a)}},[]),new URLSearchParams(s)})().get("framework")||"";ws({pageTitle:"Controls Framework",description:"Manage master controls, frameworks, and requirements. Define controls, assign owners, and map them to frameworks.",keyTopics:["Controls","Frameworks","Compliance Requirements","Control Owners"],dataSummary:{context:"User is viewing the master Controls Library."}});const{user:v}=ps(),[t,h]=x.useState(""),[f,r]=x.useState(0),l=50,T=fs(t,300),[S,G]=x.useState(o?[o]:[]),[L,Xe]=x.useState([]),[Ye,_]=x.useState(!1),[u,U]=x.useState(null),[K,Je]=x.useState(null),[F,X]=x.useState(null),[Y,We]=x.useState(""),[Ze,es]=x.useState([]),[ie,oe]=x.useState(null),{data:b,refetch:Zs}=k.compliance.frameworkMappings.list.useQuery({});x.useMemo(()=>{if(!b)return[];if(!Array.isArray(b))return console.error("[Controls] 'mappings' is not an array:",b),[];const s=new Map;return b.forEach(n=>{s.has(n.sourceControlId)||s.set(n.sourceControlId,{source:{id:n.sourceControlId},targets:[]}),s.get(n.sourceControlId).targets.push(n)}),Array.from(s.values())},[b]),x.useEffect(()=>{r(0)},[S,T,L]),x.useEffect(()=>{G(o?[o]:[])},[o]);const{data:p,isLoading:ss,refetch:J}=k.controls.listPaginated.useQuery({framework:S.length>0?S.includes("all")?"all":S:"all",limit:l,offset:f*l,search:T},{keepPreviousData:!0}),m=(p==null?void 0:p.items)||[],C=(p==null?void 0:p.total)||0,W=Math.ceil(C/l),{data:ce}=k.controls.getAvailableFrameworks.useQuery(void 0,{enabled:!0}),Z=Array.isArray(ce)?ce:[],de=x.useMemo(()=>{var n;if(!(p!=null&&p.items))return[];if(!b)return p.items;const s=new Map;return console.log(`[DEBUG] Mappings: ${b==null?void 0:b.length}, Controls: ${(n=p==null?void 0:p.items)==null?void 0:n.length}`),b.forEach(a=>{var R,P,E,Ce;s.has(a.sourceControlId)||s.set(a.sourceControlId,[]);const A=`${a.targetFramework} ${a.targetControlCode}`;if((R=s.get(a.sourceControlId))!=null&&R.includes(A)||(P=s.get(a.sourceControlId))==null||P.push(A),a.mappingType==="equivalent"||a.mappingType==="related"){s.has(a.targetControlId)||s.set(a.targetControlId,[]);const ke=`${a.sourceFramework} ${a.sourceControlCode}`;(E=s.get(a.targetControlId))!=null&&E.includes(ke)||(Ce=s.get(a.targetControlId))==null||Ce.push(ke)}}),console.log(`[DEBUG] Map Size: ${s.size}`),console.log("[DEBUG] Sample Map Entry:",s.entries().next().value),p.items.map(a=>{const A=s.get(a.id);return{...a,mappedFrameworks:A&&A.length>0?[a.framework,...A]:void 0}})},[p==null?void 0:p.items,b]),{data:M}=k.controls.history.useQuery({controlId:K||0},{enabled:!!K}),ee=k.controls.create.useMutation({onSuccess:()=>{I.success("Control created successfully"),_(!1),J()},onError:s=>I.error(s.message)}),se=k.controls.update.useMutation({onSuccess:()=>{I.success("Control updated successfully"),U(null),J()},onError:s=>I.error(s.message)}),ae=k.controls.delete.useMutation({onSuccess:()=>{I.success("Control deleted"),X(null),J()},onError:s=>I.error(s.message)}),z=x.useRef(null),as=s=>{if(s.preventDefault(),!Y){I.error("Please select a framework");return}const n=new FormData(s.currentTarget);ee.mutate({controlId:n.get("controlId"),name:n.get("name"),description:n.get("description"),framework:Y,owner:n.get("owner"),frequency:n.get("frequency"),evidenceType:n.get("evidenceType"),status:n.get("status")})},ts=(s,n)=>{s.preventDefault();const a=new FormData(s.currentTarget);se.mutate({id:n,controlId:a.get("controlId"),name:a.get("name"),description:a.get("description"),framework:a.get("framework"),owner:a.get("owner"),frequency:a.get("frequency"),evidenceType:a.get("evidenceType"),status:a.get("status"),implementationGuidance:a.get("implementationGuidance"),changeNote:a.get("changeNote")})},rs=s=>{X(s)},ns=()=>{F&&ae.mutate({id:F.id})},ls=x.useMemo(()=>{const s=m.filter(a=>a.owner).length,n=m.length-s;return{unassigned:Math.round(n*(C/(m.length||1))),assigned:Math.round(s*(C/(m.length||1))),needsReassignment:0}},[m,C]),is=x.useMemo(()=>({total:C,okCount:Math.round(C*.45),testPassed:5,testTotal:12,documentAttached:8,documentTotal:10}),[C]);return e.jsxs(Ns,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[o&&e.jsxs(j,{variant:"ghost",size:"sm",onClick:()=>d("/frameworks"),className:"gap-2",children:[e.jsx(Hs,{className:"h-4 w-4"}),"Back to Frameworks"]}),e.jsx(vs,{items:o?[{label:"Frameworks",href:"/frameworks"},{label:`${o} Controls`}]:[{label:"Global Control Library"}]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight text-slate-900",children:o?`${o} Controls`:"Global Control Library"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:o?`Manage controls for ${o} framework`:"Manage master controls, frameworks, and requirements."})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Gs,{title:"Global Control Library",description:"Your centralized repository for operational security controls. Define once, comply many times.",rationale:"Instead of managing separate compliance projects for SOC 2, ISO 27001, and HIPAA, define a single 'Master Control' (e.g., 'Employee Background Checks') and map it to multiple framework requirements. This eliminates redundant work.",howToUse:[{step:"Define Controls",description:"Document your company's actual security practices (e.g., 'MFA is enforced')."},{step:"Map to Frameworks",description:"Link your internal control to external requirements (e.g., SOC 2 CC6.1)."},{step:"Assign Owners",description:"Designate a responsible person to maintain the control."},{step:"Upload Evidence",description:"Attach proof (screenshots, policies) to demonstrate effectiveness."}],integrations:[{name:"Frameworks",description:"Controls satisfy specific Requirements."},{name:"Risks",description:"Controls mitigate identified Risks."},{name:"Audits",description:"Evidence attached here is automatically pulled into audits."}]}),e.jsx(Ee,{name:Oe.CONTROL_HEADER_ACTIONS}),e.jsx(re,{open:Ye,onOpenChange:_,trigger:e.jsxs(j,{className:"gap-2 bg-primary hover:bg-primary/90 shadow-sm",children:[e.jsx(Qs,{className:"h-4 w-4"}),"New Control"]}),title:"Add New Control",description:"Define a new master control requirement.",footer:e.jsxs("div",{className:"flex justify-end gap-2 w-full",children:[e.jsx(j,{type:"button",variant:"outline",onClick:()=>_(!1),children:"Cancel"}),e.jsx(j,{onClick:s=>{const n=document.getElementById("new-control-form");n&&n.requestSubmit()},disabled:ee.isPending,children:ee.isPending?"Creating...":"Create Control"})]}),size:"lg",children:e.jsxs("form",{id:"new-control-form",onSubmit:as,className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"controlId",children:"Control ID"}),e.jsx(D,{id:"controlId",name:"controlId",placeholder:"e.g. AC-1",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"framework",children:"Framework"}),e.jsxs($,{value:Y,onValueChange:We,children:[e.jsx(V,{children:e.jsx(B,{placeholder:"Select..."})}),e.jsxs(H,{children:[Z.map(s=>e.jsx(g,{value:s,children:s},s)),!Z&&e.jsxs(e.Fragment,{children:[e.jsx(g,{value:"ISO 27001",children:"ISO 27001"}),e.jsx(g,{value:"SOC 2",children:"SOC 2"}),e.jsx(g,{value:"GDPR",children:"GDPR"}),e.jsx(g,{value:"HIPAA",children:"HIPAA"}),e.jsx(g,{value:"NIST CSF",children:"NIST CSF"})]})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"name",children:"Control Name"}),e.jsx(D,{id:"name",name:"name",placeholder:"Access Control Policy",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"description",children:"Description (Requirement)"}),e.jsx(ne,{id:"description",name:"description",placeholder:"The organization shall establish..."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"owner",children:"Default Owner"}),e.jsx(D,{id:"owner",name:"owner",placeholder:"e.g. CISO"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"frequency",children:"Review Frequency"}),e.jsxs($,{name:"frequency",defaultValue:"Annual",children:[e.jsx(V,{children:e.jsx(B,{placeholder:"Select..."})}),e.jsxs(H,{children:[e.jsx(g,{value:"Annual",children:"Annual"}),e.jsx(g,{value:"Semi-Annual",children:"Semi-Annual"}),e.jsx(g,{value:"Quarterly",children:"Quarterly"}),e.jsx(g,{value:"Monthly",children:"Monthly"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"evidenceType",children:"Evidence Type"}),e.jsxs($,{name:"evidenceType",defaultValue:"Document",children:[e.jsx(V,{children:e.jsx(B,{placeholder:"Select..."})}),e.jsxs(H,{children:[e.jsx(g,{value:"Document",children:"Document"}),e.jsx(g,{value:"Screenshot",children:"Screenshot"}),e.jsx(g,{value:"Log",children:"Log"}),e.jsx(g,{value:"Configuration",children:"Configuration"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"status",children:"Status"}),e.jsxs($,{name:"status",defaultValue:"active",children:[e.jsx(V,{children:e.jsx(B,{placeholder:"Select..."})}),e.jsxs(H,{children:[e.jsx(g,{value:"active",children:"Active"}),e.jsx(g,{value:"inactive",children:"Inactive"}),e.jsx(g,{value:"draft",children:"Draft"})]})]})]})]})]})})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Xs,{controls:de,assignmentStats:ls,completionStats:is}),e.jsxs("div",{className:"bg-white p-6 rounded-xl border border-slate-200 shadow-sm",children:[e.jsx(Js,{searchQuery:t,onSearchChange:h,filters:{framework:S,owner:L,status:[],risk:[]},onFilterChange:(s,n)=>{s==="framework"&&G(n),s==="owner"&&Xe(n)},availableFrameworks:Z,availableOwners:Array.from(new Set(m.map(s=>s.owner).filter(Boolean)))}),ss?e.jsx("div",{className:"space-y-4",children:[1,2,3,4,5].map(s=>e.jsx(gs,{className:"h-12 w-full rounded-md"},s))}):e.jsxs(e.Fragment,{children:[e.jsx(Ys,{controls:de,selectedIds:Ze,onSelectChange:es,onEdit:s=>U(s.id),onDelete:s=>{const n=m.find(a=>a.id===s);n&&rs(n)},onViewDetails:s=>oe(s)}),C>0&&e.jsxs("div",{className:"flex items-center justify-between border-t border-slate-100 pt-4 mt-4",children:[e.jsxs("div",{className:"text-sm text-slate-500",children:["Showing ",e.jsx("span",{className:"font-medium text-slate-900",children:f*l+1})," to ",e.jsx("span",{className:"font-medium text-slate-900",children:Math.min((f+1)*l,C)})," of ",e.jsx("span",{className:"font-medium text-slate-900",children:C})," controls"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>r(s=>Math.max(0,s-1)),disabled:f===0,className:"h-9 px-4",children:[e.jsx(_s,{className:"h-4 w-4 mr-2"}),"Previous"]}),e.jsxs("div",{className:"text-sm font-medium px-2 text-slate-600",children:["Page ",f+1," of ",W]}),e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>r(s=>Math.min(W-1,s+1)),disabled:f>=W-1,className:"h-9 px-4",children:["Next",e.jsx(js,{className:"h-4 w-4 ml-2"})]})]})]})]})]})]})]}),e.jsx(Ws,{open:!!ie,onOpenChange:s=>!s&&oe(null),control:ie}),e.jsx(re,{open:!!u,onOpenChange:s=>!s&&U(null),title:"Edit Control",description:"Update control details.",footer:e.jsxs("div",{className:"flex justify-end gap-2 w-full",children:[e.jsx(j,{type:"button",variant:"outline",onClick:()=>U(null),children:"Cancel"}),e.jsx(j,{onClick:s=>{const n=document.getElementById("edit-control-form");n&&n.requestSubmit()},disabled:se.isPending,children:se.isPending?"Saving...":"Save Changes"})]}),size:"lg",children:u&&(m==null?void 0:m.find(s=>s.id===u))&&e.jsxs("form",{id:"edit-control-form",onSubmit:s=>ts(s,u),className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"edit-controlId",className:"font-semibold text-foreground/80",children:"Control ID"}),e.jsx(D,{id:"edit-controlId",name:"controlId",defaultValue:(me=m.find(s=>s.id===u))==null?void 0:me.controlId,required:!0,className:"border-2 border-slate-300 bg-slate-50 focus:ring-2 focus:ring-primary/20"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"edit-framework",className:"font-semibold text-foreground/80",children:"Framework"}),e.jsx(D,{id:"edit-framework",name:"framework",defaultValue:(xe=m.find(s=>s.id===u))==null?void 0:xe.framework,readOnly:!0,className:"border-2 border-slate-300 bg-slate-100 text-muted-foreground focus:ring-2 focus:ring-primary/20"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"edit-name",className:"font-semibold text-foreground/80",children:"Name"}),e.jsx(D,{id:"edit-name",name:"name",defaultValue:(he=m.find(s=>s.id===u))==null?void 0:he.name,required:!0,className:"border-2 border-slate-300 bg-slate-50 focus:ring-2 focus:ring-primary/20"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"edit-description",className:"font-semibold text-foreground/80",children:"Description"}),e.jsx(ne,{id:"edit-description",name:"description",className:"min-h-[80px] border-2 border-slate-300 bg-slate-50 focus:ring-2 focus:ring-primary/20",defaultValue:((ue=m.find(s=>s.id===u))==null?void 0:ue.description)||""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(N,{htmlFor:"edit-implementationGuidance",className:"font-semibold text-foreground/80",children:"Implementation Guidance (Examples)"}),e.jsx(Ee,{name:Oe.CONTROL_EDIT_ACTIONS,props:{controlId:((pe=m.find(s=>s.id===u))==null?void 0:pe.controlId)||"",name:((ge=m.find(s=>s.id===u))==null?void 0:ge.name)||"",description:((je=m.find(s=>s.id===u))==null?void 0:je.description)||"",framework:((fe=m.find(s=>s.id===u))==null?void 0:fe.framework)||"",onGenerate:s=>{if(z.current){if(z.current.value&&!confirm("Replace existing guidance?"))return;z.current.value=s}}}})]}),e.jsx(ne,{id:"edit-implementationGuidance",ref:z,name:"implementationGuidance",placeholder:"e.g. Ex1: Identify relevant internal stakeholders...",className:"min-h-[120px] font-mono text-sm border-2 border-slate-300 bg-slate-50 focus:ring-2 focus:ring-primary/20",defaultValue:((Ne=m.find(s=>s.id===u))==null?void 0:Ne.implementationGuidance)||""})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"edit-owner",className:"font-semibold text-foreground/80",children:"Owner"}),e.jsx(D,{id:"edit-owner",name:"owner",className:"border-2 border-slate-300 bg-slate-50 focus:ring-2 focus:ring-primary/20",defaultValue:((ve=m.find(s=>s.id===u))==null?void 0:ve.owner)||""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"edit-changeNote",className:"font-semibold text-foreground/80",children:"Change Note (Optional)"}),e.jsx(D,{id:"edit-changeNote",name:"changeNote",className:"border-2 border-slate-300 bg-slate-50 focus:ring-2 focus:ring-primary/20",placeholder:"Reason for update..."})]})]}),e.jsx("input",{type:"hidden",name:"frequency",value:((we=m.find(s=>s.id===u))==null?void 0:we.frequency)||"Annual"}),e.jsx("input",{type:"hidden",name:"evidenceType",value:((be=m.find(s=>s.id===u))==null?void 0:be.evidenceType)||"Document"}),e.jsx("input",{type:"hidden",name:"status",value:((ye=m.find(s=>s.id===u))==null?void 0:ye.status)||"active"})]})}),e.jsx(re,{open:!!K,onOpenChange:s=>!s&&Je(null),title:"Control History",description:"Version history for this control.",size:"lg",children:e.jsx("div",{className:"border rounded-md max-h-[400px] overflow-y-auto",children:e.jsxs(Re,{children:[e.jsx(qe,{children:e.jsxs(O,{children:[e.jsx(y,{children:"Version"}),e.jsx(y,{children:"Date"}),e.jsx(y,{children:"Changed By"}),e.jsx(y,{children:"Note"})]})}),e.jsxs(Le,{children:[M==null?void 0:M.map(s=>e.jsxs(O,{children:[e.jsxs(w,{children:["v",s.version]}),e.jsx(w,{children:new Date(s.changedAt).toLocaleDateString()}),e.jsxs(w,{children:["User ",s.changedBy]}),e.jsx(w,{children:s.changeNote})]},s.id)),!(M!=null&&M.length)&&e.jsx(O,{children:e.jsx(w,{colSpan:4,className:"text-center py-4 text-muted-foreground",children:"No history available."})})]})]})})}),e.jsx(Rs,{open:!!F,onOpenChange:s=>!s&&X(null),children:e.jsxs(qs,{children:[e.jsxs(Ls,{children:[e.jsx(Us,{children:"Delete Control?"}),e.jsxs(zs,{children:["Are you sure you want to delete ",e.jsx("b",{children:F==null?void 0:F.controlId}),"? This action cannot be undone and may affect compliance scores if evidence is attached."]})]}),e.jsxs($s,{children:[e.jsx(Vs,{children:"Cancel"}),e.jsx(Bs,{className:"bg-red-600 hover:bg-red-700",onClick:s=>{s.preventDefault(),ns()},disabled:ae.isPending,children:ae.isPending?e.jsx(Ke,{className:"h-4 w-4 animate-spin mr-2"}):"Delete Control"})]})]})})]})}export{Za as default};
