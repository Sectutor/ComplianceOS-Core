import{ab as J,b as X,r as R,t as g,j as e,c as k,aq as Z,F as O,C as U,d as _,e as M,f as H,m as K,L as m,i as f}from"./index-DOc7Nwb7.js";import{D as ee}from"./DashboardLayout-aHnUqq57.js";import{T as p}from"./textarea-BtxBxzdY.js";import{B as se}from"./Breadcrumb-CRi3LAxS.js";import{P as te}from"./PageGuide-CPKKXXS6.js";import{S as b,a as N}from"./slotNames-XB2IFQPg.js";import{A as ie}from"./arrow-left-CpuUojG-.js";import{S as oe}from"./save-CvVmWchr.js";import{D as re}from"./download-ByfWg1Mi.js";import"./index--2vFva6Y.js";import"./search-CwuIBBPE.js";import"./filter-Ceo--4mb.js";import"./clipboard-check-CQkJX5J0.js";import"./sparkles-CoQ80pK2.js";import"./send-FW7-3cjH.js";import"./scroll-area-DPaNxEJD.js";import"./settings-CIu9FFiX.js";import"./circle-check-C5kiwRoG.js";import"./en-US-Bfz1jvxT.js";import"./getTimezoneOffsetInMilliseconds-em2BGgN1.js";import"./rocket-C2MuHhsn.js";import"./scale-BCebIfgE.js";import"./layout-grid-CGqkIAJU.js";import"./book-open-BffBrdze.js";import"./zap-B01fFOkT.js";import"./star-BTvaCCU4.js";import"./briefcase-BxorFA78.js";import"./target-cfAj3L6j.js";import"./database-Bjtecw5f.js";import"./activity-B1F2IRm3.js";import"./shield-check-ETs8j4-d.js";import"./shield-alert-iAruRy4W.js";import"./brain-C-Zi22rJ.js";import"./link-FmUqdGRG.js";import"./lock-czWF3qbC.js";import"./globe-BMGZmoaJ.js";import"./calendar-BlLJlGbj.js";import"./message-square-5hBo7zY3.js";import"./upload-BBmUECj8.js";import"./user-CqRnJLgW.js";import"./separator-BWuYil37.js";import"./info-By5wLOUH.js";function We(){const x=J(),[ne,w]=X(),t=x.id?Number(x.id):0,S=x.reportId&&x.reportId!=="new"?Number(x.reportId):void 0,[C,T]=R.useState(!1),[F,$]=R.useState(!1),[r,L]=R.useState({title:"Risk Management Report",executiveSummary:"",introduction:"",scope:"",methodology:"",keyFindings:"",recommendations:"",conclusion:"",assumptions:"",references:""}),{data:c}=g.clients.get.useQuery({id:t},{enabled:!!t}),{data:l,isLoading:ae}=g.risks.getRiskAssessments.useQuery({clientId:t},{enabled:!!t}),G=g.risks.exportReport.useMutation(),z=g.risks.saveReport.useMutation(),{data:n}=g.risks.getReport.useQuery({clientId:t,reportId:S},{enabled:!!t});R.useEffect(()=>{n&&L(s=>({...s,title:n.title||s.title,executiveSummary:n.executiveSummary||s.executiveSummary,introduction:n.introduction||s.introduction,scope:n.scope||s.scope,methodology:n.methodology||s.methodology,keyFindings:n.keyFindings||s.keyFindings,recommendations:n.recommendations||s.recommendations,conclusion:n.conclusion||s.conclusion,assumptions:n.assumptions||s.assumptions,references:n.references||s.references}))},[n]);const o=(s,a)=>{L(h=>({...h,[s]:a}))},B=async()=>{var s,a,h,D;try{T(!0);const i=await G.mutateAsync({clientId:t,...r}),v=atob(i.base64),P=new Array(v.length);for(let j=0;j<v.length;j++)P[j]=v.charCodeAt(j);const q=new Uint8Array(P),W=new Blob([q],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}),E=document.createElement("a");E.href=window.URL.createObjectURL(W),E.download=i.filename,E.click(),f.success("Report downloaded successfully")}catch(i){if(console.error("[Export Error]",i),((s=i==null?void 0:i.data)==null?void 0:s.code)==="PRECONDITION_FAILED"||((a=i==null?void 0:i.message)==null?void 0:a.includes("Premium feature"))||((D=(h=i==null?void 0:i.shape)==null?void 0:h.data)==null?void 0:D.httpStatus)===412){f.error("Premium Feature",{description:"This is a professional feature. Redirecting to upgrade page..."}),setTimeout(()=>{w(`/upgrade-required?feature=risk-reports&clientId=${t}`)},1500);return}f.error("Failed to generate report",{description:i.message})}finally{T(!1)}},V=async()=>{try{$(!0);const s=await z.mutateAsync({clientId:t,reportId:S,...r});f.success("Report data saved successfully"),!S&&(s!=null&&s.id)&&w(`/clients/${t}/risks/report/${s.id}`)}catch(s){console.error(s),f.error("Failed to save report")}finally{$(!1)}},Q=(l==null?void 0:l.filter(s=>{const a=typeof s.inherentScore=="number"?s.inherentScore:0;return a===8||a===9}))||[],A=(l==null?void 0:l.filter(s=>(typeof s.inherentScore=="number"?s.inherentScore:0)>=15))||[],u=Q.length,d=A.length,I=(l==null?void 0:l.length)||0,Y=A.map(s=>{const a=typeof s.inherentScore=="number"?s.inherentScore:0,h=typeof s.residualScore=="number"?s.residualScore:a;return`- RAW TITLE: "${s.title||"Untitled Risk"}" (Inherent: ${a}, Residual: ${h}, ID: ${s.assessmentId})`}).join(`
`),y=[{field:"executiveSummary",name:"Executive Summary",prompt:`Generate an executive summary for ${c==null?void 0:c.name}. 
            Current metrics:
            - Total identified risks: ${I}
            - High priority risks: ${u}
            - Critical/Very High priority risks: ${d}
            
            IMPORTANT: You MUST mention that there are exactly ${d} Critical/Very High risks and ${u} High risks.
            Some raw titles in the database may be informal or Dutch. Rewrite all titles into professional English.
            Focus heavily on the ${d} critical risks that need immediate attention.`},{field:"introduction",name:"Introduction",prompt:"Introduction section."},{field:"scope",name:"Scope",prompt:"Define scope."},{field:"methodology",name:"Methodology",prompt:"Describe methodology."},{field:"keyFindings",name:"Key Findings",prompt:`YOU MUST LIST ALL ${d} CRITICAL RISKS INDIVIDUALLY. Do not summarize or combine them.
            
            For EACH of the ${d} risks below, create a separate heading with a professional English business title and a detailed analysis:
            ${Y}
            
            Finalize with a brief summary of the ${u} High risks.`},{field:"recommendations",name:"Recommendations",prompt:`Recommendations for the ${d} critical and ${u} high risks.`},{field:"conclusion",name:"Conclusion",prompt:`Emphasize addressing the ${d} critical risks.`},{field:"assumptions",name:"Assumptions",prompt:"Common assumptions."},{field:"references",name:"References",prompt:"References."}];return e.jsx(ee,{children:e.jsxs("div",{className:"space-y-6 max-w-5xl mx-auto",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx(se,{items:[{label:"Clients",href:"/clients"},{label:(c==null?void 0:c.name)||"Client",href:`/clients/${t}`},{label:"Risk Management",href:`/clients/${t}/risks`},{label:"Risk Report",href:`/clients/${t}/risks/report`}]}),e.jsxs(k,{variant:"ghost",size:"sm",className:"mt-2 -ml-3 text-muted-foreground hover:text-foreground",onClick:()=>w(`/clients/${t}/risks/report`),children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"Back to Reports List"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:r.title||"Risk Management Report"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Customize and export your risk management report"})]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Z,{href:`/clients/${t}/risks/report`,children:e.jsxs(k,{variant:"ghost",className:"gap-2 text-slate-600 hover:text-slate-900 border-transparent hover:bg-slate-100 transition-all font-medium",children:[e.jsx(O,{className:"w-4 h-4 text-slate-500"}),"History"]})}),e.jsx(b,{name:N.RISK_REPORT_GENERATE_ALL,props:{clientId:t,sections:y,onGenerateSection:o}}),e.jsxs(k,{variant:"outline",onClick:V,disabled:F,className:"gap-2 border-indigo-200 bg-indigo-50/50 text-indigo-700 hover:bg-indigo-100/80 hover:border-indigo-300 transition-all shadow-sm active:scale-[0.98] font-semibold h-10 px-5",children:[e.jsx(oe,{className:`w-4 h-4 ${F?"animate-pulse":""}`}),F?"Saving...":"Save Report"]}),e.jsxs(k,{variant:"primary",onClick:B,disabled:C,className:"gap-2 shadow-lg shadow-blue-500/20 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white border-0 transition-all active:scale-[0.98] font-bold h-10 px-6",children:[e.jsx(re,{className:`w-4 h-4 text-white ${C?"animate-bounce":""}`}),C?"Exporting...":"Export Report"]}),e.jsx(te,{title:"Report Editor",description:"Use AI to generate comprehensive risk management reports.",rationale:"Automated reporting saves weeks of manual effort and standardized communication to stakeholders.",howToUse:[{step:"Generate Sections",description:"Use the 'Generate with AI' buttons to draft content for each section."},{step:"Review & Edit",description:"Manually refine the generated text to ensure accuracy."},{step:"Export",description:"Download the final report as a Word document for offline distribution."}],integrations:[{name:"Risk Data",description:"Critcal risks and statistics are automatically pulled into the report."}]})]})]}),e.jsxs(U,{children:[e.jsxs(_,{children:[e.jsxs(M,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"w-5 h-5"}),"Report Overview"]}),e.jsxs(H,{children:["This report covers ",I," risk assessments, including ",u," high risks and ",d," very high/critical risks"]})]}),e.jsx(K,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Client"}),e.jsx("div",{className:"font-medium",children:(c==null?void 0:c.name)||"N/A"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Total Risks"}),e.jsx("div",{className:"font-medium",children:I})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"High Risks"}),e.jsx("div",{className:"font-medium text-orange-600",children:u})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Very High/Critical"}),e.jsx("div",{className:"font-medium text-red-600",children:d})]})]})})]}),e.jsxs(U,{children:[e.jsxs(_,{children:[e.jsx(M,{children:"Report Content"}),e.jsx(H,{children:"Customize the content sections of your risk management report"})]}),e.jsxs(K,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(m,{htmlFor:"executiveSummary",children:"Executive Summary"}),e.jsx(b,{name:N.RISK_REPORT_AI_BUTTON,props:{clientId:t,sectionField:"executiveSummary",sectionName:"Executive Summary",prompt:y[0].prompt,onGenerate:s=>o("executiveSummary",s)}})]}),e.jsx(p,{id:"executiveSummary",placeholder:"Provide a high-level overview of the risk landscape...",value:r.executiveSummary,onChange:s=>o("executiveSummary",s.target.value),rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"introduction",children:"Introduction"}),e.jsx(p,{id:"introduction",placeholder:"Introduce the purpose and context of this risk assessment...",value:r.introduction,onChange:s=>o("introduction",s.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"scope",children:"Scope"}),e.jsx(p,{id:"scope",placeholder:"Define the boundaries and coverage of this assessment...",value:r.scope,onChange:s=>o("scope",s.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"methodology",children:"Methodology"}),e.jsx(p,{id:"methodology",placeholder:"Describe the approach and methods used for risk assessment...",value:r.methodology,onChange:s=>o("methodology",s.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(m,{htmlFor:"keyFindings",children:"Key Findings"}),e.jsx(b,{name:N.RISK_REPORT_AI_BUTTON,props:{clientId:t,sectionField:"keyFindings",sectionName:"Key Findings",prompt:y[4].prompt,onGenerate:s=>o("keyFindings",s)}})]}),e.jsx(p,{id:"keyFindings",placeholder:"Summarize the most important discoveries and risk insights...",value:r.keyFindings,onChange:s=>o("keyFindings",s.target.value),rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(m,{htmlFor:"recommendations",children:"Key Recommendations"}),e.jsx(b,{name:N.RISK_REPORT_AI_BUTTON,props:{clientId:t,sectionField:"recommendations",sectionName:"Key Recommendations",prompt:y[5].prompt,onGenerate:s=>o("recommendations",s)}})]}),e.jsx(p,{id:"recommendations",placeholder:"Provide actionable recommendations for risk treatment...",value:r.recommendations,onChange:s=>o("recommendations",s.target.value),rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"conclusion",children:"Conclusion"}),e.jsx(p,{id:"conclusion",placeholder:"Conclude with final thoughts and next steps...",value:r.conclusion,onChange:s=>o("conclusion",s.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"assumptions",children:"Assumptions & Limitations"}),e.jsx(p,{id:"assumptions",placeholder:"Document any assumptions made during the assessment...",value:r.assumptions,onChange:s=>o("assumptions",s.target.value),rows:2})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"references",children:"References"}),e.jsx(p,{id:"references",placeholder:"List any standards, frameworks, or documents referenced...",value:r.references,onChange:s=>o("references",s.target.value),rows:2})]})]})]})]})})}export{We as default};
