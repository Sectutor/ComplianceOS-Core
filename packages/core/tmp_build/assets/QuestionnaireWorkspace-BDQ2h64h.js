import{ab as pe,b as he,r as u,t as g,i as h,j as e,x as q,aa as fe,c as l,C as k,m as Q,I,d as Z,e as J,f as X,N as ge,O as je,P as Y,Q as d,V as we,W as m,k as M,D as Ne,o as ve,p as ye,q as be,s as Ce,L as ee,w as qe}from"./index-DOc7Nwb7.js";import{D as se}from"./DashboardLayout-aHnUqq57.js";import{P as Ie}from"./PageGuide-CPKKXXS6.js";import{T as Se}from"./textarea-BtxBxzdY.js";import{P as te}from"./progress-B-1k4ZZX.js";import{A as Pe}from"./arrow-left-CpuUojG-.js";import{C as ne}from"./circle-check-big-BSqJVrgh.js";import{U as Ae}from"./upload-BBmUECj8.js";import{R as ke}from"./refresh-cw-Cjym1DSW.js";import{S as Qe}from"./sparkles-CoQ80pK2.js";import{S as Me}from"./save-CvVmWchr.js";import"./index--2vFva6Y.js";import"./search-CwuIBBPE.js";import"./filter-Ceo--4mb.js";import"./clipboard-check-CQkJX5J0.js";import"./send-FW7-3cjH.js";import"./scroll-area-DPaNxEJD.js";import"./settings-CIu9FFiX.js";import"./circle-check-C5kiwRoG.js";import"./en-US-Bfz1jvxT.js";import"./getTimezoneOffsetInMilliseconds-em2BGgN1.js";import"./rocket-C2MuHhsn.js";import"./scale-BCebIfgE.js";import"./layout-grid-CGqkIAJU.js";import"./book-open-BffBrdze.js";import"./zap-B01fFOkT.js";import"./star-BTvaCCU4.js";import"./briefcase-BxorFA78.js";import"./target-cfAj3L6j.js";import"./database-Bjtecw5f.js";import"./activity-B1F2IRm3.js";import"./shield-check-ETs8j4-d.js";import"./shield-alert-iAruRy4W.js";import"./brain-C-Zi22rJ.js";import"./link-FmUqdGRG.js";import"./lock-czWF3qbC.js";import"./globe-BMGZmoaJ.js";import"./calendar-BlLJlGbj.js";import"./message-square-5hBo7zY3.js";import"./user-CqRnJLgW.js";import"./separator-BWuYil37.js";import"./info-By5wLOUH.js";function ys(){const B=pe(),[Be,D]=he(),N=parseInt(B.id||"0"),x=B.qId?parseInt(B.qId):null,[f,v]=u.useState("upload"),[p,ae]=u.useState(null),[o,S]=u.useState([]),[y,j]=u.useState([]),[re,P]=u.useState(!1),[U,F]=u.useState(""),[G,ie]=u.useState(""),[W,A]=u.useState(0),[z,H]=u.useState(0),[oe,K]=u.useState(!1),{data:r,isLoading:ce,refetch:O}=g.questionnaire.get.useQuery({id:x},{enabled:!!x});u.useEffect(()=>{if(r!=null&&r.questions&&r.questions.length>0){const s=r.questions.map(t=>({questionId:t.questionId,question:t.question,answer:t.answer||"",confidence:t.confidence||0,sources:t.sources||[],status:t.status}));j(s),S(s.map(t=>({questionId:t.questionId,question:t.question}))),v("review")}},[r]);const E=g.questionnaire.parse.useMutation({onSuccess:s=>{var t;S(s.questions),F(((t=p==null?void 0:p.name)==null?void 0:t.replace(/\.[^/.]+$/,""))||"New Questionnaire"),P(!0)},onError:s=>{h.error(`Failed to parse file: ${s.message}`)}}),T=g.questionnaire.create.useMutation({onSuccess:async s=>{h.success("Project created successfully"),P(!1),await $.mutateAsync({questionnaireId:s.id,questions:o.map(a=>({questionId:a.questionId,question:a.question,status:"pending"}))});const t=o.map(a=>({questionId:a.questionId,question:a.question,answer:"",comment:"",tags:[],access:"internal",assignee:null,confidence:0,sources:[],status:"pending"}));j(t),v("review"),D(`/clients/${N}/questionnaires/${s.id}`)}}),$=g.questionnaire.saveQuestions.useMutation({onSuccess:()=>{}});g.questionnaire.update.useMutation({onSuccess:()=>{h.success("Project updated"),O()}});const R=g.questionnaire.complete.useMutation({onSuccess:s=>{h.success(`Project completed! Indexed ${s.indexedCount} answer pairs.`),O()},onError:s=>{h.error(`Failed to complete project: ${s.message}`)}}),b=g.questionnaire.generateAnswers.useMutation({onError:s=>{console.error(s)}}),le=s=>{s.target.files&&s.target.files[0]&&ae(s.target.files[0])},de=async()=>{if(!p)return;A(0),K(!1);const s=setInterval(()=>{A(a=>a>=90?a:a+10)},500),t=new FileReader;t.onload=async a=>{var i,w;const n=(w=(i=a.target)==null?void 0:i.result)==null?void 0:w.toString().split(",")[1];if(!n){clearInterval(s);return}const c=p.name.endsWith(".pdf")?"pdf":p.name.endsWith(".xlsx")?"xlsx":p.name.endsWith(".csv")?"csv":"pdf";try{await E.mutateAsync({fileBase64:n,filename:p.name,fileType:c}),clearInterval(s),A(100),K(!0)}catch{clearInterval(s),A(0)}},t.readAsDataURL(p)},me=()=>{T.mutate({clientId:N,name:U,senderName:G,productName:"Default"})},_=async()=>{v("generating"),H(0);const s=o.map(n=>({questionId:n.questionId,question:n.question,answer:"",confidence:0,sources:[],status:"pending"}));j(s);const t=3,a=o.length;for(let n=0;n<a;n+=t){const c=o.slice(n,n+t);try{const i=await b.mutateAsync({clientId:N,questions:c});j(w=>{const C=[...w];return i.forEach((L,xe)=>{const V=n+xe;C[V]&&(C[V]={...C[V],answer:L.answer,confidence:L.confidence,sources:L.sources})}),C}),H(w=>Math.min(w+c.length,a))}catch(i){console.error("Batch failed",i),h.error(`Batch ${n/t+1} failed, continuing...`)}}v("review"),h.success("Generation complete!"),x&&await $.mutateAsync({questionnaireId:x,questions:y.map(n=>({question:n.question,answer:n.answer,confidence:n.confidence,sources:n.sources,status:"pending"}))})},ue=async()=>{x&&(await $.mutateAsync({questionnaireId:x,questions:y.map(s=>({question:s.question,answer:s.answer,confidence:s.confidence,sources:s.sources,status:s.status}))}),h.success("Progress saved"))};return x&&ce?e.jsx(se,{children:e.jsx("div",{className:"flex items-center justify-center h-screen",children:e.jsx(q,{className:"h-8 w-8 animate-spin"})})}):e.jsx(se,{children:e.jsxs("div",{className:"p-8 max-w-[1600px] mx-auto space-y-8",children:[e.jsxs("nav",{className:"flex items-center space-x-1 text-sm text-muted-foreground",children:[e.jsx("button",{onClick:()=>D(`/clients/${N}/questionnaires`),className:"hover:text-foreground transition-colors",children:"AI Questionnaires"}),e.jsx(fe,{className:"h-4 w-4"}),e.jsx("span",{className:"text-foreground font-medium",children:(r==null?void 0:r.name)||"New Questionnaire"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>D(`/clients/${N}/questionnaires`),className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-4 w-4"}),"Back"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:r?r.name:"AI Questionnaire Workspace"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:r?`Status: ${r.status}`:"Upload a security questionnaire to automatically generate answers."})]})]}),e.jsx(Ie,{title:"Questionnaire Workspace",description:"AI-powered workspace for completing security assessments.",rationale:"Significantly reduces time spent on manual questionnaire filling by leveraging your Knowledge Base.",howToUse:[{step:"Upload",description:"Import Excel, CSV, or PDF security questionnaires."},{step:"Generate",description:"AI automatically suggests answers based on your policies and past responses."},{step:"Review",description:"Verify confidence scores, edit answers, and approve for export."}],integrations:[{name:"Knowledge Base",description:"Source of truth for automated answers."},{name:"Exports",description:"Download completed files."}]})]}),!x&&e.jsxs("div",{className:"flex items-center space-x-4 text-sm font-medium text-muted-foreground",children:[e.jsxs("div",{className:`flex items-center ${f==="upload"?"text-primary":""}`,children:[e.jsx("div",{className:"w-6 h-6 rounded-full border flex items-center justify-center mr-2 text-xs",children:"1"}),"Upload"]}),e.jsx("div",{className:"h-px bg-border w-8"}),e.jsxs("div",{className:`flex items-center ${f==="preview"?"text-primary":""}`,children:[e.jsx("div",{className:"w-6 h-6 rounded-full border flex items-center justify-center mr-2 text-xs",children:"2"}),"Verify Questions"]}),e.jsx("div",{className:"h-px bg-border w-8"}),e.jsxs("div",{className:`flex items-center ${f==="generating"||f==="review"?"text-primary":""}`,children:[e.jsx("div",{className:"w-6 h-6 rounded-full border flex items-center justify-center mr-2 text-xs",children:"3"}),"Review"]})]}),f==="upload"&&e.jsx(k,{className:"max-w-xl mx-auto border-dashed border-2 hover:border-primary/50 hover:bg-slate-50/50 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1",children:e.jsx(Q,{className:"pt-6 flex flex-col items-center justify-center min-h-[300px] space-y-4",children:oe?e.jsxs("div",{className:"flex flex-col items-center animate-in fade-in zoom-in duration-500",children:[e.jsx("div",{className:"h-16 w-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4",children:e.jsx(ne,{className:"h-8 w-8"})}),e.jsx("h3",{className:"text-xl font-bold text-green-700",children:"Import Completed!"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Preparing workspace..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 bg-muted rounded-full transition-transform duration-300 hover:scale-110",children:e.jsx(Ae,{className:"h-8 w-8 text-muted-foreground"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Upload Questionnaire"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Support for PDF, Excel (.xlsx), and CSV files."})]}),!E.isPending&&e.jsx(I,{type:"file",accept:".pdf,.xlsx,.csv",onChange:le,className:"max-w-xs cursor-pointer"}),E.isPending?e.jsxs("div",{className:"w-full max-w-xs space-y-3",children:[e.jsx(te,{value:W,className:"h-2 w-full"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[e.jsx("span",{children:"Extracting questions..."}),e.jsxs("span",{children:[W,"%"]})]})]}):e.jsx(l,{onClick:de,disabled:!p,className:"min-w-[150px]",children:"Process Document"})]})})}),f==="preview"&&e.jsxs(k,{children:[e.jsxs(Z,{children:[e.jsx(J,{children:"Verify Extracted Questions"}),e.jsxs(X,{children:["We found ",o.length," questions. Remove any headers or irrelevant text before generating answers."]})]}),e.jsxs(Q,{className:"space-y-4",children:[e.jsx("div",{className:"border rounded-md divide-y max-h-[500px] overflow-y-auto",children:o.map((s,t)=>e.jsxs("div",{className:"p-3 flex gap-3 group",children:[s.questionId&&e.jsx("span",{className:"text-primary text-sm font-mono font-semibold min-w-[80px]",children:s.questionId}),!s.questionId&&e.jsx("span",{className:"text-muted-foreground text-sm font-mono w-6",children:t+1}),e.jsx(I,{value:s.question,onChange:a=>{const n=[...o];n[t]={...n[t],question:a.target.value},S(n)},className:"flex-1 h-8 text-sm"}),e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>{const a=o.filter((n,c)=>c!==t);S(a)},className:"opacity-0 group-hover:opacity-100 text-destructive hover:bg-destructive/10",children:"Remove"})]},t))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[!x&&e.jsx(l,{variant:"outline",onClick:()=>v("upload"),children:"Back"}),e.jsxs(l,{onClick:_,disabled:o.length===0||b.isPending,children:[b.isPending?e.jsx(q,{className:"animate-spin mr-2 h-4 w-4"}):null,"Generate Answers with AI"]})]})]})]}),f==="generating"&&e.jsx(k,{className:"max-w-xl mx-auto text-center py-12",children:e.jsxs(Q,{className:"space-y-6",children:[e.jsxs("div",{className:"relative w-20 h-20 mx-auto",children:[e.jsx(ke,{className:"w-full h-full animate-spin text-primary opacity-20"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-3 h-3 bg-primary rounded-full animate-pulse"})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold",children:"Generating Answers..."}),e.jsxs("p",{className:"text-muted-foreground",children:["Analyzing ",o.length," questions against your Knowledge Base."]})]}),e.jsx(te,{value:z/Math.max(o.length,1)*100,className:"w-[60%] mx-auto"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Processed ",z," of ",o.length," questions"]})]})}),f==="review"&&e.jsxs(k,{children:[e.jsxs(Z,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(J,{children:"Review Generated Answers"}),e.jsx(X,{children:"Review usage of AI sources and edit as needed."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(l,{onClick:_,disabled:b.isPending,className:"bg-purple-600 hover:bg-purple-700 text-white",children:[b.isPending?e.jsx(q,{className:"animate-spin mr-2 h-4 w-4"}):e.jsx(Qe,{className:"mr-2 h-4 w-4"}),"Generate with AI"]}),(r==null?void 0:r.status)!=="completed"&&e.jsxs(l,{variant:"outline",onClick:()=>{window.confirm("This will mark the project as completed and index all approved answers into the Knowledge Base. Continue?")&&R.mutate({id:x})},disabled:R.isPending,children:[R.isPending?e.jsx(q,{className:"animate-spin mr-2 h-4 w-4"}):e.jsx(ne,{className:"mr-2 h-4 w-4"}),"Mark as Completed"]}),e.jsx(l,{variant:"outline",onClick:()=>h.info("Export CSV coming soon"),children:"Export CSV"}),e.jsxs(l,{onClick:ue,children:[e.jsx(Me,{className:"mr-2 h-4 w-4"})," Save Project"]})]})]}),e.jsx(Q,{children:e.jsxs(ge,{children:[e.jsx(je,{children:e.jsxs(Y,{children:[e.jsx(d,{className:"w-[3%]",children:"#"}),e.jsx(d,{className:"w-[10%]",children:"Question ID"}),e.jsx(d,{className:"w-[20%]",children:"Question"}),e.jsx(d,{className:"w-[20%]",children:"Answer"}),e.jsx(d,{className:"w-[8%]",children:"Confidence"}),e.jsx(d,{className:"w-[10%]",children:"Sources"}),e.jsx(d,{className:"w-[15%]",children:"Comment"}),e.jsx(d,{className:"w-[8%]",children:"Tags"}),e.jsx(d,{className:"w-[8%]",children:"Access"}),e.jsx(d,{className:"w-[8%]",children:"Assignee"}),e.jsx(d,{className:"w-[8%]",children:"Last Modified"}),e.jsx(d,{className:"w-[3%]"})]})}),e.jsx(we,{children:y.map((s,t)=>{var a,n;return e.jsxs(Y,{children:[e.jsx(m,{className:"align-top text-xs text-muted-foreground",children:t+1}),e.jsx(m,{className:"align-top font-mono text-xs font-medium",children:s.questionId||"-"}),e.jsx(m,{className:"align-top font-medium text-sm",children:s.question}),e.jsx(m,{className:"align-top",children:e.jsx(Se,{className:"text-sm min-h-[80px]",defaultValue:s.answer,onChange:c=>{const i=[...y];i[t].answer=c.target.value,j(i)}})}),e.jsx(m,{className:"align-top",children:s.confidence>0&&e.jsxs(M,{className:`${s.confidence>.7?"bg-green-100 text-green-700 hover:bg-green-100":s.confidence>.4?"bg-amber-100 text-amber-700 hover:bg-amber-100":"bg-red-100 text-red-700 hover:bg-red-100"}`,children:[Math.round(s.confidence*100),"%"]})}),e.jsx(m,{className:"align-top space-y-1",children:(a=s.sources)==null?void 0:a.map((c,i)=>e.jsxs("div",{className:"text-xs flex items-center gap-1 group relative cursor-help",children:[e.jsx(M,{variant:"outline",className:"max-w-[120px] truncate",children:c.title||`Source ${i+1}`}),e.jsx("div",{className:"hidden group-hover:block absolute left-0 bottom-full mb-2 w-64 p-2 bg-slate-800 text-white rounded shadow-lg z-50 text-xs pointer-events-none",children:e.jsx("p",{className:"font-semibold mb-1",children:c.title})})]},i))}),e.jsx(m,{className:"align-top",children:e.jsx(I,{className:"text-sm",placeholder:"-",defaultValue:s.comment||"",onChange:c=>{const i=[...y];i[t].comment=c.target.value,j(i)}})}),e.jsx(m,{className:"align-top",children:e.jsx(M,{variant:"outline",className:"text-xs",children:((n=s.tags)==null?void 0:n.join(", "))||"-"})}),e.jsx(m,{className:"align-top",children:e.jsx(M,{variant:"secondary",className:"text-xs",children:s.access||"Internal"})}),e.jsx(m,{className:"align-top text-sm text-muted-foreground",children:s.assignee||"-"}),e.jsx(m,{className:"align-top text-xs text-muted-foreground",children:s.updatedAt?new Date(s.updatedAt).toLocaleDateString():"-"}),e.jsx(m,{className:"align-top",children:e.jsx(l,{variant:"ghost",size:"sm",children:"â‹®"})})]},t)})})]})})]}),e.jsx(Ne,{open:re,onOpenChange:P,children:e.jsxs(ve,{children:[e.jsxs(ye,{children:[e.jsx(be,{children:"Save New Questionnaire"}),e.jsx(Ce,{children:"Create a new project to save your progress."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{children:"Questionnaire Name"}),e.jsx(I,{value:U,onChange:s=>F(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{children:"Sent By (Vendor/Account)"}),e.jsx(I,{value:G,onChange:s=>ie(s.target.value),placeholder:"e.g. Acme Corp"})]})]}),e.jsxs(qe,{children:[e.jsx(l,{variant:"outline",onClick:()=>P(!1),children:"Cancel"}),e.jsxs(l,{onClick:me,disabled:T.isPending,children:[T.isPending&&e.jsx(q,{className:"mr-2 h-4 w-4 animate-spin"}),"Create Project"]})]})]})})]})})}export{ys as default};
