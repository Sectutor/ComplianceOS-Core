import{r as t,ab as ce,t as m,i as r,j as e,c,C as z,m as G,k as x,d as de,e as me,f as xe,N as pe,O as he,P as T,Q as j,V as ue,W as p,F as ge,Z as je,_ as fe,$ as ve,a0 as Ne,a1 as F,a2 as be,D as we,o as Ce,p as ke,q as Ie,s as ye,L,I as De,E as Se,G as Ee,H as Me,J as Te,K as J,l as Fe,w as Le}from"./index-DOc7Nwb7.js";import{D as Be,I as Q,P as Ue,g as Pe,h as Oe,a as Ae,b as Re,c as $e,d as qe,e as He,f as Ve}from"./DashboardLayout-aHnUqq57.js";import{c as ze}from"./utils-BC5CVi_C.js";import{F as Ge}from"./filter-Ceo--4mb.js";import{U as _}from"./upload-BBmUECj8.js";import{S as K}from"./sparkles-CoQ80pK2.js";import{E as Je}from"./ellipsis-BXWwt8ER.js";import{D as Qe}from"./download-ByfWg1Mi.js";import{L as _e}from"./link-FmUqdGRG.js";import{T as Ke}from"./trash-2-CFEfisbM.js";import{C as We}from"./chevrons-up-down-COXP-OtJ.js";import"./index--2vFva6Y.js";import"./search-CwuIBBPE.js";import"./clipboard-check-CQkJX5J0.js";import"./send-FW7-3cjH.js";import"./scroll-area-DPaNxEJD.js";import"./settings-CIu9FFiX.js";import"./circle-check-C5kiwRoG.js";import"./en-US-Bfz1jvxT.js";import"./getTimezoneOffsetInMilliseconds-em2BGgN1.js";import"./rocket-C2MuHhsn.js";import"./scale-BCebIfgE.js";import"./layout-grid-CGqkIAJU.js";import"./book-open-BffBrdze.js";import"./zap-B01fFOkT.js";import"./star-BTvaCCU4.js";import"./briefcase-BxorFA78.js";import"./target-cfAj3L6j.js";import"./database-Bjtecw5f.js";import"./activity-B1F2IRm3.js";import"./shield-check-ETs8j4-d.js";import"./shield-alert-iAruRy4W.js";import"./brain-C-Zi22rJ.js";import"./lock-czWF3qbC.js";import"./globe-BMGZmoaJ.js";import"./calendar-BlLJlGbj.js";import"./message-square-5hBo7zY3.js";import"./user-CqRnJLgW.js";function Us(){var H;const[W,D]=t.useState(!1),f=ce(),o=t.useMemo(()=>{if(!f.id)return console.warn("[EvidenceIntakeBox] No client ID in params"),null;const s=parseInt(f.id);return isNaN(s)?(console.error("[EvidenceIntakeBox] Invalid client ID:",f.id),null):s},[f.id]),{data:n,isLoading:X}=m.evidence.listOpenRequests.useQuery({clientId:o},{enabled:!!o}),Y=m.intake.delete.useMutation({onSuccess:()=>{r.success("Item deleted"),w()}}),S=m.intake.mapToEvidence.useMutation({onSuccess:()=>{r.success("Evidence mapped successfully"),v(!1),w()},onError:s=>{console.error("[EvidenceIntakeBox] mapToEvidence mutation failed:",s),r.error(`Failed to map evidence: ${s.message}`)}}),[Z,v]=t.useState(!1),[N,ee]=t.useState(null),[h,B]=t.useState(null),[U,P]=t.useState(""),[O,A]=t.useState(!1),[b,se]=t.useState("all"),ae=t.useMemo(()=>n?Array.from(new Set(n.map(s=>{var a;return s.framework||((a=s.control)==null?void 0:a.framework)}).filter(Boolean))):[],[n]),E=t.useMemo(()=>n?b==="all"?n:n.filter(s=>{var a;return(s.framework||((a=s.control)==null?void 0:a.framework))===b}):[],[n,b]),[u,te]=t.useState(null),ne=s=>{ee(s),P(s.filename),v(!0)},ie=()=>{if(!N||!o){console.error("[EvidenceIntakeBox] Missing required parameters for mapping:",{selectedIntakeItem:!!N,selectedControlId:!!h,clientId:!!o}),r.error("Missing required parameters for mapping");return}const s={intakeItemId:N.id,clientControlId:h||0,evidenceId:u,title:U||N.filename};console.log("[EvidenceIntakeBox] Calling mapToEvidence with:",s),S.mutate(s)},{data:l,refetch:w}=m.intake.list.useQuery({clientId:o},{enabled:!!o}),M=m.intake.create.useMutation({onSuccess:()=>{r.success("File added to intake box!"),w()},onError:s=>{console.error("[EvidenceIntakeBox] intake.create mutation failed:",s),r.error(`Failed to record upload: ${s.message}`)}}),R=m.intake.triage.useMutation({onSuccess:()=>{r.success("AI Triage complete!"),w()}}),re=s=>{R.mutate({id:s,classification:"Analyzing content...",details:{confidence:50,date:new Date().toISOString()}})},$=s=>{if(!o)return;const a=new FileReader;a.onload=async i=>{var C;try{const d=((C=i.target)==null?void 0:C.result).split(",")[1],g=await fetch("/api/upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:s.name,data:d,contentType:s.type,folder:"uploads/intake"})});if(!g.ok)throw new Error("Upload failed");const k=await g.json(),{url:I,key:y}=k;M.mutate({clientId:o,filename:s.name,fileUrl:I,fileKey:y})}catch(d){console.error("[EvidenceIntakeBox] Upload error:",d),r.error("Upload failed: "+d.message)}},a.onerror=()=>{console.error("[EvidenceIntakeBox] File reading failed"),r.error("Failed to read file")},a.readAsDataURL(s)},oe=async s=>{var i;const a=(i=s.target.files)==null?void 0:i[0];a&&$(a)},le=s=>{var i;s.preventDefault(),D(!1);const a=(i=s.dataTransfer.files)==null?void 0:i[0];a&&$(a)},q=()=>{var s;(s=document.getElementById("file-upload"))==null||s.click()};return e.jsx(Be,{children:e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(Q,{className:"h-8 w-8 text-indigo-600"}),"Evidence Intake Box"]}),e.jsx("p",{className:"text-muted-foreground mt-1 text-lg",children:`"The Accountant Model": Just drop your evidence here. We'll handle the mapping and compliance logic for you.`})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{id:"file-upload",type:"file",className:"hidden",onChange:oe}),e.jsxs(c,{variant:"outline",children:[e.jsx(Ge,{className:"mr-2 h-4 w-4"})," Filter"]}),e.jsxs(c,{className:"bg-indigo-600 hover:bg-indigo-700",onClick:q,disabled:M.isPending,children:[e.jsx(_,{className:"mr-2 h-4 w-4"})," ",M.isPending?"Uploading...":"Upload Files"]})]})]}),e.jsx(z,{className:`border-2 border-dashed transition-all cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/50 ${W?"border-indigo-500 bg-indigo-50":"border-slate-200"}`,onDragOver:s=>{s.preventDefault(),D(!0)},onDragLeave:()=>D(!1),onDrop:le,onClick:q,children:e.jsxs(G,{className:"flex flex-col items-center justify-center py-16 text-center",children:[e.jsx("div",{className:"h-20 w-20 bg-indigo-100 rounded-full flex items-center justify-center mb-6 shadow-sm",children:e.jsx(_,{className:"h-10 w-10 text-indigo-600"})}),e.jsx("h3",{className:"text-2xl font-bold text-slate-900",children:"Drop Evidence Receipts Here"}),e.jsx("p",{className:"text-muted-foreground text-sm max-w-sm mt-3 leading-relaxed",children:"Upload log exports, screenshots, invoices, or policies. Our AI and Advisors will triage them into your compliance framework."}),e.jsxs("div",{className:"mt-6 flex gap-2",children:[e.jsx(x,{variant:"outline",className:"bg-white",children:"PDF"}),e.jsx(x,{variant:"outline",className:"bg-white",children:"PNG/JPG"}),e.jsx(x,{variant:"outline",className:"bg-white",children:"DOCX"}),e.jsx(x,{variant:"outline",className:"bg-white",children:"CSV"})]})]})}),e.jsxs(z,{className:"shadow-lg border-slate-200",children:[e.jsx(de,{className:"border-b bg-slate-50/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(me,{children:"Processing Queue"}),e.jsx(xe,{children:"Items currently being triaged by your compliance advisor team."})]}),e.jsxs(x,{className:"bg-indigo-100 text-indigo-700 hover:bg-indigo-100 border-indigo-200",children:[(l==null?void 0:l.length)||0," Items"]})]})}),e.jsx(G,{className:"p-0",children:e.jsxs(pe,{children:[e.jsx(he,{children:e.jsxs(T,{className:"bg-slate-50/30",children:[e.jsx(j,{className:"w-[300px]",children:"File Name"}),e.jsx(j,{children:"Status"}),e.jsx(j,{children:"AI Classification"}),e.jsx(j,{children:"Date Uploaded"}),e.jsx(j,{className:"text-right",children:"Actions"})]})}),e.jsxs(ue,{children:[l==null?void 0:l.map(s=>e.jsxs(T,{className:"hover:bg-slate-50/50 transition-colors",children:[e.jsx(p,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded bg-slate-100 flex items-center justify-center text-slate-500",children:e.jsx(ge,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("button",{onClick:()=>window.open(s.fileUrl,"_blank"),className:"text-left text-sm font-semibold text-slate-900 hover:text-indigo-600 hover:underline cursor-pointer",children:s.filename}),e.jsxs("span",{className:"text-xs text-slate-500",children:[(Math.random()*5+1).toFixed(1)," MB"]})]})]})}),e.jsx(p,{children:e.jsxs(x,{variant:s.status==="mapped"?"success":s.status==="classified"?"secondary":"outline",className:"capitalize",children:[s.status,(s.mappedCount||0)>0&&` (${s.mappedCount})`]})}),e.jsx(p,{children:e.jsx("div",{className:"flex items-center gap-2 text-sm",children:s.status==="pending"?e.jsxs(c,{variant:"ghost",size:"sm",className:"h-8 text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 p-0 px-2",onClick:()=>re(s.id),disabled:R.isLoading,children:[e.jsx(K,{className:"h-3 w-3 mr-1"}),"Run AI Triage"]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-3 w-3 text-amber-500"}),e.jsx("span",{className:"font-medium text-slate-700",children:s.classification})]})})}),e.jsx(p,{className:"text-slate-500 text-sm",children:new Date(s.createdAt).toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"})}),e.jsx(p,{className:"text-right",children:e.jsxs(je,{children:[e.jsx(fe,{asChild:!0,children:e.jsx(c,{variant:"ghost",size:"icon",className:"hover:bg-slate-100",children:e.jsx(Je,{className:"h-4 w-4 text-slate-400"})})}),e.jsxs(ve,{align:"end",children:[e.jsx(Ne,{children:"Actions"}),e.jsxs(F,{onClick:()=>window.open(s.fileUrl,"_blank"),children:[e.jsx(Qe,{className:"mr-2 h-4 w-4"})," View / Download"]}),e.jsxs(F,{onClick:()=>ne(s),children:[e.jsx(_e,{className:"mr-2 h-4 w-4"})," Map to Evidence"]}),e.jsx(be,{}),e.jsxs(F,{className:"text-red-600 focus:text-red-600",onClick:()=>Y.mutate({id:s.id}),children:[e.jsx(Ke,{className:"mr-2 h-4 w-4"})," Delete"]})]})]})})]},s.id)),(!l||l.length===0)&&e.jsx(T,{children:e.jsx(p,{colSpan:5,className:"text-center py-20",children:e.jsxs("div",{className:"flex flex-col items-center justify-center text-slate-400",children:[e.jsx(Q,{className:"h-12 w-12 mb-3 opacity-20"}),e.jsx("p",{className:"text-lg font-medium",children:"Your Intake Box is empty"}),e.jsx("p",{className:"text-sm max-w-xs mt-1",children:"Start by dragging and dropping evidence files here for our team to process."})]})})})]})]})})]}),e.jsx(we,{open:Z,onOpenChange:v,children:e.jsxs(Ce,{className:"sm:max-w-[425px]",children:[e.jsxs(ke,{children:[e.jsx(Ie,{children:"Map to Control Evidence"}),e.jsx(ye,{children:"Link this file to a specific compliance control. This will officially collect it as evidence."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{htmlFor:"title",children:"Evidence Title"}),e.jsx(De,{id:"title",value:U,onChange:s=>P(s.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Framework"}),e.jsxs(Se,{value:b,onValueChange:se,children:[e.jsx(Ee,{children:e.jsx(Me,{placeholder:"Select framework..."})}),e.jsxs(Te,{children:[e.jsx(J,{value:"all",children:"All Frameworks"}),ae.map(s=>e.jsx(J,{value:s,children:s},s))]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Link to Control"}),e.jsxs(Ue,{open:O,onOpenChange:A,children:[e.jsx(Pe,{asChild:!0,children:e.jsxs(c,{variant:"outline",role:"combobox","aria-expanded":O,className:"w-full justify-between",children:[h||u?((H=n==null?void 0:n.find(s=>{var a;return((a=s.clientControl)==null?void 0:a.id)===h||s.evidenceId===u}))==null?void 0:H.evidenceLabel)||"Selected Control":"Select control...",e.jsx(We,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(Oe,{className:"w-[400px] p-0",children:e.jsxs(Ae,{children:[e.jsx(Re,{placeholder:"Search controls..."}),e.jsxs($e,{className:"max-h-[300px] overflow-y-auto",children:[e.jsx(qe,{children:X?e.jsxs("div",{className:"flex items-center justify-center py-4 text-slate-500",children:[e.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-indigo-500 border-t-transparent rounded-full mr-2"}),"Loading controls..."]}):e.jsx("span",{className:"text-slate-500",children:"No control found."})}),e.jsx(He,{children:E==null?void 0:E.map(s=>{var g,k,I,y;const a=s.evidenceLabel||((g=s.control)==null?void 0:g.name)||((k=s.clientControl)==null?void 0:k.customDescription)||"Unknown Control",i=((I=s.control)==null?void 0:I.id)||"Req",C=`${a} ${i} ${s.framework||""}`,d=s.evidenceId;return e.jsxs(Ve,{value:C,onSelect:()=>{var V;te(s.id),(V=s.clientControl)!=null&&V.id?B(s.clientControl.id):B(0),A(!1)},children:[e.jsx(Fe,{className:ze("mr-2 h-4 w-4",u===s.id?"opacity-100":"opacity-0")}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:a}),((y=s.control)==null?void 0:y.name)&&s.control.name!==a&&e.jsx("span",{className:"text-muted-foreground text-xs",children:s.control.name})]})]},d)})})]})]})})]})]})]}),e.jsxs(Le,{children:[e.jsx(c,{variant:"outline",onClick:()=>v(!1),children:"Cancel"}),e.jsx(c,{onClick:ie,disabled:S.isPending||!h&&!u,children:S.isPending?"Mapping...":"Confirm & Map"})]})]})})]})})}export{Us as default};
