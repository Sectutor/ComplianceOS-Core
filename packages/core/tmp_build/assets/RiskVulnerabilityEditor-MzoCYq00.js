import{b as G,au as Z,r as v,t as h,i as c,j as e,x as D,c as j,T as _,F as J,z as K,S as W,C,d as w,e as S,f as I,m as k,L as l,I as n,E as V,G as A,H as L,J as R,K as d}from"./index-DOc7Nwb7.js";import{T}from"./textarea-BtxBxzdY.js";import{D as Y}from"./DashboardLayout-aHnUqq57.js";import{B as X}from"./Breadcrumb-CRi3LAxS.js";import{P as ee}from"./PageGuide-CPKKXXS6.js";import{A as se}from"./arrow-left-CpuUojG-.js";import{S as ie}from"./save-CvVmWchr.js";import{Z as ae}from"./zap-B01fFOkT.js";import{E as te}from"./external-link-C3PXjBR9.js";import{C as le}from"./calendar-BlLJlGbj.js";import"./index--2vFva6Y.js";import"./search-CwuIBBPE.js";import"./filter-Ceo--4mb.js";import"./clipboard-check-CQkJX5J0.js";import"./sparkles-CoQ80pK2.js";import"./send-FW7-3cjH.js";import"./scroll-area-DPaNxEJD.js";import"./settings-CIu9FFiX.js";import"./circle-check-C5kiwRoG.js";import"./en-US-Bfz1jvxT.js";import"./getTimezoneOffsetInMilliseconds-em2BGgN1.js";import"./rocket-C2MuHhsn.js";import"./scale-BCebIfgE.js";import"./layout-grid-CGqkIAJU.js";import"./book-open-BffBrdze.js";import"./star-BTvaCCU4.js";import"./briefcase-BxorFA78.js";import"./target-cfAj3L6j.js";import"./database-Bjtecw5f.js";import"./activity-B1F2IRm3.js";import"./shield-check-ETs8j4-d.js";import"./shield-alert-iAruRy4W.js";import"./brain-C-Zi22rJ.js";import"./link-FmUqdGRG.js";import"./lock-czWF3qbC.js";import"./globe-BMGZmoaJ.js";import"./message-square-5hBo7zY3.js";import"./upload-BBmUECj8.js";import"./user-CqRnJLgW.js";import"./separator-BWuYil37.js";import"./info-By5wLOUH.js";function Je(){const[re,x]=G(),[ne,u]=Z("/clients/:clientId/risks/vulnerabilities/:vulnerabilityId"),r=u!=null&&u.clientId?parseInt(u.clientId):0,y=u==null?void 0:u.vulnerabilityId,p=y==="new",g=!p&&y?parseInt(y):null,[E,M]=v.useState(!1),[o,F]=v.useState("identification"),[i,t]=v.useState({vulnerabilityId:`VULN-${new Date().getFullYear()}-${Math.floor(Math.random()*1e3)}`,name:"",description:"",cveId:"",cvssScore:0,severity:"Medium",affectedAssets:"",discoveryDate:new Date().toISOString().split("T")[0],source:"Manual",exploitability:"",impact:"",status:"open",owner:"",remediationPlan:"",dueDate:"",lastReviewDate:""}),{data:b}=h.clients.get.useQuery({id:r},{enabled:!!r}),{data:f}=h.clients.getUsers.useQuery({clientId:r},{enabled:!!r}),{data:a,isLoading:O}=h.risks.getVulnerabilities.useQuery({clientId:r},{select:s=>s.find(m=>m.id===g),enabled:!!g&&!!r});v.useEffect(()=>{a&&t({vulnerabilityId:a.vulnerabilityId||"",name:a.name||"",description:a.description||"",cveId:a.cveId||"",cvssScore:a.cvssScore||0,severity:a.severity||"Medium",affectedAssets:Array.isArray(a.affectedAssets)?a.affectedAssets.join(", "):a.affectedAssets||"",discoveryDate:a.discoveryDate?new Date(a.discoveryDate).toISOString().split("T")[0]:"",source:a.source||"Manual",exploitability:a.exploitability||"",impact:a.impact||"",status:a.status||"open",owner:a.owner||"",remediationPlan:a.remediationPlan||"",dueDate:a.dueDate?new Date(a.dueDate).toISOString().split("T")[0]:"",lastReviewDate:a.lastReviewDate?new Date(a.lastReviewDate).toISOString().split("T")[0]:""})},[a]);const U=h.risks.createVulnerability.useMutation({onSuccess:()=>{c.success("Vulnerability recorded successfully"),x(`/clients/${r}/risks/vulnerabilities`)},onError:s=>c.error(`Failed to create: ${s.message}`)}),B=h.risks.updateVulnerability.useMutation({onSuccess:()=>{c.success("Vulnerability updated successfully"),x(`/clients/${r}/risks/vulnerabilities`)},onError:s=>c.error(`Failed to update: ${s.message}`)}),[$,N]=v.useState(!1),H=h.threatIntel.lookupCve.useMutation({onSuccess:s=>{if(s.cve){const m=parseFloat(s.cve.cvssScore||"0");t(q=>{var P;return{...q,name:((P=s.cve.description)==null?void 0:P.substring(0,100))+"...",description:s.cve.description||"",cvssScore:m,severity:m>=9?"Critical":m>=7?"High":m>=4?"Medium":"Low",source:"NVD"}}),c.success("CVE details loaded from NVD")}else c.error("CVE not found in NVD database");N(!1)},onError:s=>{c.error(`Lookup failed: ${s.message}`),N(!1)}}),Q=()=>{if(!i.cveId||!i.cveId.match(/^CVE-\d{4}-\d+$/i)){c.error("Enter a valid CVE ID (e.g., CVE-2024-1234)");return}N(!0),H.mutate({cveId:i.cveId.toUpperCase()})},z=async()=>{if(!i.name){c.error("Vulnerability name is required");return}M(!0);try{const s={name:i.name,description:i.description,cveId:i.cveId,cvssScore:Number(i.cvssScore),severity:i.severity,affectedAssets:i.affectedAssets?i.affectedAssets.split(",").map(m=>m.trim()):[],discoveryDate:i.discoveryDate||void 0,source:i.source,exploitability:i.exploitability,impact:i.impact,status:i.status,owner:i.owner,remediationPlan:i.remediationPlan,dueDate:i.dueDate||void 0,lastReviewDate:i.lastReviewDate||void 0};g?await B.mutateAsync({id:g,...s}):await U.mutateAsync({clientId:r,vulnerabilityId:i.vulnerabilityId,...s})}catch(s){console.error(s)}finally{M(!1)}};return O?e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsx(D,{className:"animate-spin"})}):e.jsx(Y,{children:e.jsxs("div",{className:"w-full px-6 py-8 pb-20",children:[e.jsx("div",{className:"mb-6",children:e.jsx(X,{items:[{label:"Clients",href:"/clients"},{label:(b==null?void 0:b.name)||"Client",href:`/clients/${r}`},{label:"Vulnerabilities",href:`/clients/${r}/risks/vulnerabilities`},{label:p?"Record Vulnerability":i.vulnerabilityId}]})}),e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>x(`/clients/${r}/risks/vulnerabilities`),children:e.jsx(se,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(_,{className:"w-6 h-6 text-[#1C4D8D]"}),p?"Record Vulnerability":"Edit Vulnerability"]}),e.jsx("p",{className:"text-muted-foreground",children:i.vulnerabilityId})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{variant:"outline",onClick:()=>x(`/clients/${r}/risks/vulnerabilities`),children:"Cancel"}),e.jsxs(j,{onClick:z,disabled:E,className:"bg-[#1C4D8D] hover:bg-[#1C4D8D]/90",children:[E&&e.jsx(D,{className:"w-4 h-4 mr-2 animate-spin"}),e.jsx(ie,{className:"w-4 h-4 mr-2"}),p?"Record Vulnerability":"Save Changes"]}),e.jsx(ee,{title:p?"Record New Vulnerability":"Edit Vulnerability Details",description:"Document and track the remediation of a security vulnerability.",rationale:"Accurate vulnerability records allow you to prioritize fixes based on risk rather than just age.",howToUse:[{step:"Identify",description:"Use the 'Lookup' button with a CVE ID to auto-fill details from NVD."},{step:"Assess",description:"Set the Severity and CVSS score to determine urgency."},{step:"Remediate",description:"Assign an owner and tracking status (e.g. Open, Remediation In Progress)."}],integrations:[{name:"Asset Management",description:"Link vulnerabilities to specific assets to understand the blast radius."},{name:"Risk Assessment",description:"High-severity vulnerabilities should trigger a formal risk assessment."}]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-8",children:[e.jsx("div",{className:"lg:col-span-1 space-y-1",children:e.jsx("nav",{className:"flex flex-col space-y-1 sticky top-8",children:[{id:"identification",label:"Identification",icon:J,desc:"Basic Details"},{id:"severity",label:"Severity & Scoring",icon:K,desc:"Impact Assessment"},{id:"remediation",label:"Remediation",icon:W,desc:"Fix & Track"}].map(s=>e.jsxs("button",{onClick:()=>F(s.id),className:`group flex items-center gap-3 w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 ${o===s.id?"bg-[#1C4D8D] text-white shadow-md ring-1 ring-[#1C4D8D]":"text-slate-600 hover:bg-slate-100 hover:text-slate-900 bg-transparent"}`,children:[e.jsx("div",{className:`p-2 rounded-md transition-colors ${o===s.id?"bg-white/20":"bg-slate-100 group-hover:bg-white border border-slate-200 group-hover:border-slate-300"}`,children:e.jsx(s.icon,{className:`w-4 h-4 ${o===s.id?"text-white":"text-slate-500 group-hover:text-slate-700"}`})}),e.jsxs("div",{children:[e.jsx("span",{className:"block",children:s.label}),e.jsx("span",{className:`text-[10px] font-normal ${o===s.id?"text-blue-100":"text-slate-400 group-hover:text-slate-500"}`,children:s.desc})]}),o===s.id&&e.jsx("div",{className:"ml-auto w-1.5 h-1.5 rounded-full bg-white animate-pulse"})]},s.id))})}),e.jsxs("div",{className:"lg:col-span-3 space-y-8",children:[e.jsx("div",{className:o==="identification"?"block":"hidden",children:e.jsxs(C,{children:[e.jsxs(w,{children:[e.jsx(S,{children:"Vulnerability Details"}),e.jsx(I,{children:"Basic information about the vulnerability."})]}),e.jsxs(k,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Vulnerability Name *"}),e.jsx(n,{value:i.name,onChange:s=>t({...i,name:s.target.value}),placeholder:"e.g. SQL Injection in Payment Endpoint"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Vulnerability ID"}),e.jsx(n,{value:i.vulnerabilityId,disabled:!p,onChange:s=>t({...i,vulnerabilityId:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"CVE ID (Optional)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(n,{value:i.cveId,onChange:s=>t({...i,cveId:s.target.value.toUpperCase()}),placeholder:"e.g. CVE-2024-1234",className:"flex-1"}),e.jsx(j,{type:"button",variant:"outline",size:"sm",onClick:Q,disabled:$||!i.cveId,className:"shrink-0",children:$?e.jsx(D,{className:"w-4 h-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-4 h-4 mr-1"}),"Lookup"]})}),i.cveId&&e.jsx("a",{href:`https://nvd.nist.gov/vuln/detail/${i.cveId}`,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center justify-center h-9 px-3 text-sm border rounded-md hover:bg-slate-50",children:e.jsx(te,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Click Lookup to auto-fill details from NVD"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Affected Assets (Comma separated)"}),e.jsx(n,{value:i.affectedAssets,onChange:s=>t({...i,affectedAssets:s.target.value}),placeholder:"e.g. Web Server Alpha, PostgreSQL Main"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Description"}),e.jsx(T,{value:i.description,onChange:s=>t({...i,description:s.target.value}),placeholder:"Detailed description of the security flaw...",className:"min-h-[120px]"})]})]})]})}),e.jsx("div",{className:o==="severity"?"block":"hidden",children:e.jsxs(C,{children:[e.jsxs(w,{children:[e.jsx(S,{children:"Classification & Scoring"}),e.jsx(I,{children:"Determine the impact and urgency of this vulnerability."})]}),e.jsxs(k,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Severity Level"}),e.jsxs(V,{value:i.severity,onValueChange:s=>t({...i,severity:s}),children:[e.jsx(A,{children:e.jsx(L,{})}),e.jsxs(R,{children:[e.jsx(d,{value:"Critical",children:"Critical"}),e.jsx(d,{value:"High",children:"High"}),e.jsx(d,{value:"Medium",children:"Medium"}),e.jsx(d,{value:"Low",children:"Low"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"CVSS Score (0.0 - 10.0)"}),e.jsx(n,{type:"number",min:"0",max:"10",step:"0.1",value:i.cvssScore,onChange:s=>t({...i,cvssScore:parseFloat(s.target.value)})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Source / Scanner"}),e.jsx(n,{value:i.source,onChange:s=>t({...i,source:s.target.value}),placeholder:"e.g. Nessus, Qualys, Snyk"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Discovery Date"}),e.jsxs("div",{className:"relative",children:[e.jsx(le,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500"}),e.jsx(n,{type:"date",className:"pl-9",value:i.discoveryDate,onChange:s=>t({...i,discoveryDate:s.target.value})})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Exploitability Details"}),e.jsx(n,{value:i.exploitability,onChange:s=>t({...i,exploitability:s.target.value}),placeholder:"e.g. Public exploit available, Requires local access"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Potential Business Impact"}),e.jsx(n,{value:i.impact,onChange:s=>t({...i,impact:s.target.value}),placeholder:"e.g. Data exfiltration, System downtime"})]})]})]})]})}),e.jsx("div",{className:o==="remediation"?"block":"hidden",children:e.jsxs(C,{children:[e.jsxs(w,{children:[e.jsx(S,{children:"Management & Remediation"}),e.jsx(I,{children:"Track the progress of fixing the vulnerability."})]}),e.jsxs(k,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Current Status"}),e.jsxs(V,{value:i.status,onValueChange:s=>t({...i,status:s}),children:[e.jsx(A,{children:e.jsx(L,{})}),e.jsxs(R,{children:[e.jsx(d,{value:"open",children:"Open"}),e.jsx(d,{value:"mitigated",children:"Mitigated"}),e.jsx(d,{value:"accepted",children:"Accepted"}),e.jsx(d,{value:"remediated",children:"Remediated"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Vulnerability Owner"}),e.jsxs(V,{value:i.owner,onValueChange:s=>t({...i,owner:s}),children:[e.jsx(A,{children:e.jsx(L,{placeholder:"Select Owner"})}),e.jsx(R,{children:f==null?void 0:f.map(s=>e.jsx(d,{value:s.name||s.email,children:s.name},s.id))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Remediation Due Date"}),e.jsx(n,{type:"date",value:i.dueDate,onChange:s=>t({...i,dueDate:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Last Review Date"}),e.jsx(n,{type:"date",value:i.lastReviewDate,onChange:s=>t({...i,lastReviewDate:s.target.value})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Remediation Plan"}),e.jsx(T,{value:i.remediationPlan,onChange:s=>t({...i,remediationPlan:s.target.value}),placeholder:"Steps required to fix or mitigate the vulnerability...",className:"min-h-[120px]"})]})]})]})})]})]})]})})}export{Je as default};
