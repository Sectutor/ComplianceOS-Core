import React, { useState } from 'react';
import { Button } from '@complianceos/ui/ui/button';
import { EnhancedDialog } from '@complianceos/ui/ui/enhanced-dialog';
import { Label } from '@complianceos/ui/ui/label';
import { Input } from '@complianceos/ui/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@complianceos/ui/ui/select';
import { Textarea } from '@complianceos/ui/ui/textarea';
import { trpc } from '@/lib/trpc';
import { Bug, Loader2 } from 'lucide-react';
import { toast } from 'sonner';

interface AddVulnerabilityDialogProps {
    open: boolean;
    onOpenChange: (open: boolean) => void;
    clientId: number;
    onSuccess: () => void;
    initialData?: any;
}

export function AddVulnerabilityDialog({ open, onOpenChange, clientId, onSuccess, initialData }: AddVulnerabilityDialogProps) {
    const [loading, setLoading] = useState(false);
    const [formData, setFormData] = useState({
        vulnerabilityId: `VULN-${new Date().getFullYear()}-${Math.floor(Math.random() * 1000)}`,
        name: '',
        description: '',
        cveId: '',
        cvssScore: 0,
        severity: 'Medium',
        affectedAssets: '',
        discoveryDate: new Date().toISOString().split('T')[0],
        source: 'Manual',
        exploitability: '',
        impact: '',
        status: 'open',
        owner: '',
        remediationPlan: '',
        dueDate: '',
        lastReviewDate: '',
    });

    const { data: users } = trpc.clients.getUsers.useQuery({ clientId });

    React.useEffect(() => {
        if (open) {
            if (initialData) {
                setFormData({
                    vulnerabilityId: initialData.vulnerabilityId || '',
                    name: initialData.name || '',
                    description: initialData.description || '',
                    cveId: initialData.cveId || '',
                    cvssScore: initialData.cvssScore || 0,
                    severity: initialData.severity || 'Medium',
                    affectedAssets: Array.isArray(initialData.affectedAssets) ? initialData.affectedAssets.join(', ') : (initialData.affectedAssets || ''),
                    discoveryDate: initialData.discoveryDate ? new Date(initialData.discoveryDate).toISOString().split('T')[0] : '',
                    source: initialData.source || 'Manual',
                    exploitability: initialData.exploitability || '',
                    impact: initialData.impact || '',
                    status: initialData.status || 'open',
                    owner: initialData.owner || '',
                    remediationPlan: initialData.remediationPlan || '',
                    dueDate: initialData.dueDate ? new Date(initialData.dueDate).toISOString().split('T')[0] : '',
                    lastReviewDate: initialData.lastReviewDate ? new Date(initialData.lastReviewDate).toISOString().split('T')[0] : '',
                });
            } else {
                setFormData({
                    vulnerabilityId: `VULN-${new Date().getFullYear()}-${Math.floor(Math.random() * 1000)}`,
                    name: '',
                    description: '',
                    cveId: '',
                    cvssScore: 0,
                    severity: 'Medium',
                    affectedAssets: '',
                    discoveryDate: new Date().toISOString().split('T')[0],
                    source: 'Manual',
                    exploitability: '',
                    impact: '',
                    status: 'open',
                    owner: '',
                    remediationPlan: '',
                    dueDate: '',
                    lastReviewDate: '',
                });
            }
        }
    }, [open, initialData]);

    const createVuln = trpc.risks.createVulnerability.useMutation();
    const updateVuln = trpc.risks.updateVulnerability.useMutation();

    const handleSubmit = async () => {
        if (!formData.name) {
            toast.error("Vulnerability name is required");
            return;
        }

        setLoading(true);
        try {
            const commonData = {
                name: formData.name,
                description: formData.description,
                cveId: formData.cveId,
                cvssScore: Number(formData.cvssScore),
                severity: formData.severity,
                affectedAssets: formData.affectedAssets ? formData.affectedAssets.split(',').map(s => s.trim()) : [],
                discoveryDate: formData.discoveryDate || undefined,
                source: formData.source,
                exploitability: formData.exploitability,
                impact: formData.impact,
                status: formData.status as any,
                owner: formData.owner,
                remediationPlan: formData.remediationPlan,
                dueDate: formData.dueDate || undefined,
                lastReviewDate: formData.lastReviewDate || undefined,
            };

            if (initialData?.id) {
                await updateVuln.mutateAsync({
                    id: initialData.id,
                    ...commonData,
                });
                toast.success("Vulnerability updated successfully");
            } else {
                await createVuln.mutateAsync({
                    clientId,
                    vulnerabilityId: formData.vulnerabilityId,
                    ...commonData,
                });
                toast.success("Vulnerability recorded successfully");
            }

            onSuccess();
            onOpenChange(false);
        } catch (error) {
            console.error("Failed to save vulnerability", error);
            toast.error("Failed to save vulnerability");
        } finally {
            setLoading(false);
        }
    };

    return (
        <EnhancedDialog
            open={open}
            onOpenChange={onOpenChange}
            title={
                <div className="flex items-center gap-2">
                    <Bug className="w-5 h-5 text-red-600" />
                    {initialData ? 'Edit Vulnerability' : 'Record Vulnerability'}
                </div>
            }
            className="sm:max-w-2xl dark:bg-slate-900"
            size="md"
            footer={
                <>
                    <Button variant="outline" onClick={() => onOpenChange(false)} className="dark:text-white dark:hover:bg-slate-800">Cancel</Button>
                    <Button onClick={handleSubmit} disabled={loading}>
                        {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : (initialData ? 'Update Vulnerability' : 'Record Vulnerability')}
                    </Button>
                </>
            }
        >
            <div className="grid grid-cols-2 gap-4 py-4">
                <div className="space-y-2 col-span-2">
                    <Label className="dark:text-slate-300">Vulnerability Name *</Label>
                    <Input
                        value={formData.name}
                        onChange={e => setFormData({ ...formData, name: e.target.value })}
                        placeholder="e.g., SQL Injection in Login Form"
                        className="dark:bg-slate-950 dark:border-slate-800 dark:text-white"
                    />
                </div>

                <div className="space-y-2">
                    <Label className="dark:text-slate-300">ID</Label>
                    <Input
                        value={formData.vulnerabilityId}
                        onChange={e => setFormData({ ...formData, vulnerabilityId: e.target.value })}
                        disabled={!!initialData}
                        className="dark:bg-slate-950 dark:border-slate-800 dark:text-white disabled:opacity-50"
                    />
                </div>
                <div className="space-y-2">
                    <Label className="dark:text-slate-300">CVE ID</Label>
                    <Input
                        value={formData.cveId}
                        onChange={e => setFormData({ ...formData, cveId: e.target.value })}
                        placeholder="e.g. CVE-2024-1234"
                        className="dark:bg-slate-950 dark:border-slate-800 dark:text-white"
                    />
                </div>

                <div className="space-y-2">
                    <Label className="dark:text-slate-300">Severity</Label>
                    <Select
                        value={formData.severity}
                        onValueChange={v => setFormData({ ...formData, severity: v })}
                    >
                        <SelectTrigger className="dark:bg-slate-950 dark:border-slate-800 dark:text-white">
                            <SelectValue />
                        </SelectTrigger>
                        <SelectContent className="dark:bg-slate-900 dark:border-slate-800">
                            <SelectItem value="Critical" className="dark:focus:bg-slate-800 dark:text-white">Critical</SelectItem>
                            <SelectItem value="High" className="dark:focus:bg-slate-800 dark:text-white">High</SelectItem>
                            <SelectItem value="Medium" className="dark:focus:bg-slate-800 dark:text-white">Medium</SelectItem>
                            <SelectItem value="Low" className="dark:focus:bg-slate-800 dark:text-white">Low</SelectItem>
                        </SelectContent>
                    </Select>
                </div>
                <div className="space-y-2">
                    <Label className="dark:text-slate-300">CVSS Score (0-10)</Label>
                    <Input
                        type="number"
                        min="0" max="10" step="0.1"
                        value={formData.cvssScore}
                        onChange={e => setFormData({ ...formData, cvssScore: parseFloat(e.target.value) })}
                        className="dark:bg-slate-950 dark:border-slate-800 dark:text-white"
                    />
                </div>

                <div className="space-y-2 col-span-2">
                    <Label className="dark:text-slate-300">Affected Assets (comma separated)</Label>
                    <Input
                        value={formData.affectedAssets}
                        onChange={e => setFormData({ ...formData, affectedAssets: e.target.value })}
                        placeholder="Server A, Database B"
                        className="dark:bg-slate-950 dark:border-slate-800 dark:text-white"
                    />
                </div>

                <div className="space-y-2 col-span-2">
                    <Label className="dark:text-slate-300">Description</Label>
                    <Textarea
                        value={formData.description}
                        onChange={e => setFormData({ ...formData, description: e.target.value })}
                        className="dark:bg-slate-950 dark:border-slate-800 dark:text-white"
                    />
                </div>

                <div className="space-y-2">
                    <Label className="dark:text-slate-300">Discovery Date</Label>
                    <Input
                        type="date"
                        value={formData.discoveryDate}
                        onChange={e => setFormData({ ...formData, discoveryDate: e.target.value })}
                        className="dark:bg-slate-950 dark:border-slate-800 dark:text-white"
                    />
                </div>
                <div className="space-y-2">
                    <Label className="dark:text-slate-300">Source</Label>
                    <Input
                        value={formData.source}
                        onChange={e => setFormData({ ...formData, source: e.target.value })}
                        placeholder="e.g. Tenable"
                        className="dark:bg-slate-950 dark:border-slate-800 dark:text-white"
                    />
                </div>

                <div className="space-y-2">
                    <Label className="dark:text-slate-300">Status</Label>
                    <Select
                        value={formData.status}
                        onValueChange={v => setFormData({ ...formData, status: v })}
                    >
                        <SelectTrigger className="dark:bg-slate-950 dark:border-slate-800 dark:text-white">
                            <SelectValue />
                        </SelectTrigger>
                        <SelectContent className="dark:bg-slate-900 dark:border-slate-800">
                            <SelectItem value="open" className="dark:focus:bg-slate-800 dark:text-white">Open</SelectItem>
                            <SelectItem value="mitigated" className="dark:focus:bg-slate-800 dark:text-white">Mitigated</SelectItem>
                            <SelectItem value="accepted" className="dark:focus:bg-slate-800 dark:text-white">Accepted</SelectItem>
                            <SelectItem value="remediated" className="dark:focus:bg-slate-800 dark:text-white">Remediated</SelectItem>
                        </SelectContent>
                    </Select>
                </div>
                <div className="space-y-2">
                    <Label className="dark:text-slate-300">Owner</Label>
                    <Select value={formData.owner} onValueChange={v => setFormData({ ...formData, owner: v })}>
                        <SelectTrigger className="dark:bg-slate-950 dark:border-slate-800 dark:text-white">
                            <SelectValue placeholder="Select Owner" />
                        </SelectTrigger>
                        <SelectContent className="dark:bg-slate-900 dark:border-slate-800">
                            {users?.map(u => (
                                <SelectItem key={u.id} value={u.name || u.email} className="dark:focus:bg-slate-800 dark:text-white">
                                    {u.name} ({u.email})
                                </SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                </div>

                <div className="space-y-2 col-span-2">
                    <Label className="dark:text-slate-300">Remediation Plan</Label>
                    <Textarea
                        value={formData.remediationPlan}
                        onChange={e => setFormData({ ...formData, remediationPlan: e.target.value })}
                        className="dark:bg-slate-950 dark:border-slate-800 dark:text-white"
                    />
                </div>

                <div className="space-y-2">
                    <Label className="dark:text-slate-300">Due Date</Label>
                    <Input
                        type="date"
                        value={formData.dueDate}
                        onChange={e => setFormData({ ...formData, dueDate: e.target.value })}
                        className="dark:bg-slate-950 dark:border-slate-800 dark:text-white"
                    />
                </div>
                <div className="space-y-2">
                    <Label className="dark:text-slate-300">Last Review</Label>
                    <Input
                        type="date"
                        value={formData.lastReviewDate}
                        onChange={e => setFormData({ ...formData, lastReviewDate: e.target.value })}
                        className="dark:bg-slate-950 dark:border-slate-800 dark:text-white"
                    />
                </div>
            </div>
        </EnhancedDialog>
    );
}
